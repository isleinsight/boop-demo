<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Send & Request â€“ BOOP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="styles.css" />
  <style> 
 .search-section {
  margin: 20px 0;
  display: flex;
  flex-direction: column;
  align-items: center;
}

.search-section input {
  width: 95%;
  max-width: 500px;
  padding: 12px 16px;
  font-size: 1em;
  border-radius: 6px;
  border: 1px solid #ccc;
}

.next-button {
  margin-top: 15px;
  padding: 12px 24px;
  background: #ccc;
  color: white;
  border: none;
  border-radius: 6px;
  font-size: 1em;
  cursor: not-allowed;
}

.next-button.enabled {
  background: #2f80ed;
  cursor: pointer;
}
    </style>
</head>
<body>
  <!-- Top Nav -->
  <nav>
    <div class="nav-container">
      <div class="nav-left">
        <a href="cardholder.html"><img src="Boop-Logo.png" alt="BOOP Logo" /></a>
        <div class="nav-links" id="navLinks">
          <a href="send-request.html">Send / Request</a>
          <a href="wallet.html">Wallet</a>
          <a href="activity.html">Activity</a>
          <a href="help.html">Help</a>
        </div>
      </div>
      <div class="nav-right">
        <a href="#" id="logoutBtn">Log Out</a>
      </div>
    </div>
  </nav>

  <!-- Page Body -->
  <div class="container">
    <div class="tabs">
      <div class="tab active" id="sendTab">Send</div>
      <div class="tab" id="requestTab">Request</div>
    </div>

    <div class="search-section">
      <input type="text" id="recipientInput" placeholder="Name, username, email..." />
      <button class="next-button" id="nextBtn" disabled>Next</button>
    </div>

    <div class="results-title" id="resultsTitle">Results</div>
    <div class="results-list" id="resultsList"></div>
  </div>

  <!-- Firebase & Logic -->
  <script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getAuth,
  onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import {
  getFirestore,
  collection,
  getDocs,
  query,
  where
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDwXCiL7elRCyywSjVgwQtklq_98OPWZm0",
  authDomain: "boop-becff.firebaseapp.com",
  projectId: "boop-becff",
  storageBucket: "boop-becff.appspot.com",
  messagingSenderId: "570567453336",
  appId: "1:570567453336:web:43ac40b4cd9d5b517fbeed"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const logoutBtn = document.getElementById("logoutBtn");
logoutBtn.addEventListener("click", () => {
  signOut(auth).then(() => {
    window.location.href = "index.html";
  });
});

const recipientInput = document.getElementById("recipientInput");
const nextBtn = document.getElementById("nextBtn");
const resultsList = document.getElementById("resultsList");
const resultsTitle = document.getElementById("resultsTitle");
const navLinks = document.getElementById("navLinks");

let currentUserEmail = "";
let currentUserUID = "";

onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "index.html";
    return;
  }

  currentUserEmail = user.email;
  currentUserUID = user.uid;

  const userSnap = await getDocs(query(collection(db, "users"), where("email", "==", currentUserEmail)));
  userSnap.forEach((doc) => {
    const data = doc.data();
    if (data.role === "government") {
      navLinks.style.display = "none";
    }
  });
});

recipientInput.addEventListener("input", async () => {
  const queryVal = recipientInput.value.trim().toLowerCase();

  if (queryVal.length === 0) {
    nextBtn.disabled = true;
    nextBtn.classList.remove("enabled");
    resultsList.style.display = "none";
    resultsTitle.style.display = "none";
    return;
  }

  nextBtn.disabled = false;
  nextBtn.classList.add("enabled");

  resultsList.innerHTML = "";
  resultsList.style.display = "block";
  resultsTitle.style.display = "block";

  const usersRef = collection(db, "users");
  const q = query(usersRef, where("role", "==", "cardholder"), where("onAssistance", "==", false));
  const snapshot = await getDocs(q);

  let matchCount = 0;

  snapshot.forEach((doc) => {
    const user = doc.data();

    const userName = `${user.firstName ?? ''} ${user.lastName ?? ''}`.trim().toLowerCase();
    const email = (user.email ?? '').toLowerCase();

    // Exclude current user by UID
    if (doc.id === currentUserUID) return;

    const isMatch =
      userName.includes(queryVal) ||
      (user.firstName ?? '').toLowerCase().includes(queryVal) ||
      (user.lastName ?? '').toLowerCase().includes(queryVal) ||
      email.includes(queryVal);

    if (isMatch) {
      const div = document.createElement("div");
      div.className = "result-item";
      div.textContent = `${user.firstName} ${user.lastName} (${user.email})`;
      resultsList.appendChild(div);
      matchCount++;
    }
  });

  if (matchCount === 0) {
    resultsList.innerHTML = '<div class="result-item">No results found</div>';
  }
});

// Tabs
const sendTab = document.getElementById("sendTab");
const requestTab = document.getElementById("requestTab");

sendTab.addEventListener("click", () => {
  sendTab.classList.add("active");
  requestTab.classList.remove("active");
});

requestTab.addEventListener("click", () => {
  requestTab.classList.add("active");
  sendTab.classList.remove("active");
});
  </script>
</body>
</html>
