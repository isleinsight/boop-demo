// Firebase v10 imports
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getAuth,
  onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import {
  getFirestore,
  doc,
  getDoc,
  setDoc,
  collection,
  addDoc,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyDwXCiL7elRCyywSjVgwQtklq_98OPWZm0",
  authDomain: "boop-becff.firebaseapp.com",
  projectId: "boop-becff",
  storageBucket: "boop-becff.appspot.com",
  messagingSenderId: "570567453336",
  appId: "1:570567453336:web:43ac40b4cd9d5b517fbeed"
};

// Init
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// DOM elements
const sendBtn = document.getElementById("sendBtn");
const requestBtn = document.getElementById("requestBtn");
const recipientInput = document.getElementById("recipient");
const amountInput = document.getElementById("amount");
const noteInput = document.getElementById("transactionNote"); // new
const logoutBtn = document.getElementById("logoutBtn");

// Ensure auth
onAuthStateChanged(auth, (user) => {
  if (!user) {
    window.location.href = "index.html";
  }
});

// Send Money
sendBtn.addEventListener("click", async () => {
  await handleTransaction("send");
});

// Request Money
requestBtn.addEventListener("click", async () => {
  await handleTransaction("request");
});

// Handle send/request logic
async function handleTransaction(type) {
  const user = auth.currentUser;
  if (!user) return;

  const recipient = recipientInput.value.trim();
  const amount = parseFloat(amountInput.value.trim());
  const note = noteInput.value.trim();

  if (!recipient || isNaN(amount) || amount <= 0) {
    alert("Please enter a valid recipient and amount.");
    return;
  }

  try {
    const senderDoc = await getDoc(doc(db, "users", user.uid));
    if (!senderDoc.exists()) throw new Error("Sender not found");

    const senderData = senderDoc.data();

    const txData = {
      from: type === "send" ? user.uid : recipient,
      to: type === "send" ? recipient : user.uid,
      fromName: senderData.firstName + " " + senderData.lastName,
      toName: "Unknown",
      amount: amount,
      category: type === "send" ? "Send" : "Request",
      note: note || null,
      status: "pending",
      timestamp: serverTimestamp()
    };

    await addDoc(collection(db, "transactions"), txData);

    alert("Transaction submitted successfully.");
    recipientInput.value = "";
    amountInput.value = "";
    noteInput.value = "";

  } catch (err) {
    console.error("Transaction failed:", err);
    alert("Transaction failed.");
  }
}

// Logout
logoutBtn.addEventListener("click", () => {
  signOut(auth).then(() => {
    window.location.href = "index.html";
  });
});
