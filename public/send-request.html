<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Send / Request – BOOP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --ink:#102a43;
      --muted:#6b7c93;
      --blue:#2f80ed;
      --blue-dark:#1a5fcc;
      --green:#16a34a;
      --stroke:#dcdcdc;
      --bg:#ffffff;
      --nav:#102a43;
      --grad1: rgba(47,128,237,.18);
      --grad2: rgba(16,185,129,.15);
      --danger:#dc2626;
    }
    *{box-sizing:border-box}
    body{ margin:0; font-family:'Poppins',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background:var(--bg); color:var(--ink); }

    /* NAV */
    nav{ background:var(--nav); color:#fff; position:sticky; top:0; z-index:50; }
    .nav-container{ max-width:1100px; margin:0 auto; padding:12px 20px; display:flex; align-items:center; justify-content:space-between; }
    .nav-left img{ height:36px; display:block }
    .nav-right{ display:flex; align-items:center; gap:18px; }
    .nav-right a{ color:#fff; text-decoration:none; font-size:.95rem; opacity:.95; }
    .nav-right a:hover{ opacity:1 }

    /* Mobile menu */
    .hamburger{ display:none; flex-direction:column; justify-content:space-between; width:26px; height:20px; background:none; border:0; cursor:pointer; }
    .hamburger span{ width:100%; height:3px; background:#fff; border-radius:2px; transition:transform .25s, opacity .25s; }
    .hamburger.active span:nth-child(1){ transform:translateY(8.5px) rotate(45deg); }
    .hamburger.active span:nth-child(2){ opacity:0; }
    .hamburger.active span:nth-child(3){ transform:translateY(-8.5px) rotate(-45deg); }
    .nav-panel{ display:none; }
    @media (max-width: 768px){
      .nav-right{ display:none; }
      .hamburger{ display:flex; }
      .nav-panel{
        display:block; position:fixed; top:0; right:-100%; height:100vh; width:260px;
        background:#ffffff; color:#111827; box-shadow:-4px 0 14px rgba(0,0,0,.18);
        transition:right .3s ease; z-index:60; padding:80px 20px 20px;
      }
      .nav-panel.active{ right:0; }
      .nav-panel a{ display:block; color:#111827; text-decoration:none; padding:12px 8px; border-radius:8px; margin-bottom:6px; font-weight:600; }
      .nav-panel a:hover{ background:#f3f4f6; }
      .nav-overlay{ display:none; position:fixed; inset:0; background:rgba(0,0,0,.35); z-index:55; }
      .nav-overlay.active{ display:block; }
    }

    /* HERO BAND */
    .hero-band{
      background:
        radial-gradient(1000px 600px at 85% -10%, var(--grad1), transparent 60%),
        radial-gradient(700px 500px at -10% 110%, var(--grad2), transparent 60%),
        linear-gradient(180deg, #0b1220 0%, #0d1220 40%, #0b1220 100%);
      color:#eef2ff; padding:26px 0 22px;
    }
    .hero-inner{ max-width:1100px; margin:0 auto; padding:0 20px; display:flex; align-items:center; justify-content:space-between; gap:16px; }
    .hero-title{ margin:0; font-size:clamp(20px, 3.2vw, 28px); font-weight:600; text-align:left; }
    .hero-sub{ margin:6px 0 0; color:#cbd5e1; font-size:.95rem; text-align:left; }

    /* MAIN */
    .container{ max-width:1100px; margin:18px auto 40px; padding:0 20px; }
    .card{ background:#fff; border:1px solid var(--stroke); border-radius:12px; padding:18px; }

    .grid{ display:grid; grid-template-columns:1.2fr 1fr; gap:18px; }
    @media (max-width: 900px){ .grid{ grid-template-columns:1fr; } }

    label{ display:block; font-size:.9rem; color:#475569; margin-bottom:6px; }
    input, textarea, select, button{
      width:100%; padding:12px 12px; border:1px solid #dcdcdc; border-radius:8px; font-size:.95rem; outline:none;
    }
    input:focus, textarea:focus, select:focus{ border-color:var(--blue); }

    .toggle{
      display:inline-flex; border:1px solid var(--stroke); border-radius:10px; overflow:hidden; margin-bottom:10px;
    }
    .toggle button{
      width:auto; flex:1; border:0; padding:10px 14px; background:#f8fafc; color:#111827; cursor:pointer; font-weight:600;
    }
    .toggle button.active-send{ background:var(--blue); color:#fff; }
    .toggle button.active-request{ background:var(--green); color:#fff; }

    .suggestions{
      display:none; position:absolute; left:0; right:0; top:100%;
      background:#fff; border:1px solid #e5e7eb; border-radius:8px; margin-top:6px; z-index:10; max-height:250px; overflow:auto;
    }
    .suggestions .item{
      padding:10px 12px; display:flex; align-items:center; gap:10px; cursor:pointer;
    }
    .suggestions .item:hover{ background:#f3f4f6; }
    .avatar{
      width:28px; height:28px; border-radius:50%; background:#e2e8f0; display:flex; align-items:center; justify-content:center; font-weight:700; color:#334155;
    }
    .row{ margin-bottom:14px; position:relative; }

    .pill{
      display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border:1px solid var(--stroke); border-radius:999px; background:#f8fafc; font-size:.9rem;
    }

    .actions{ display:flex; gap:10px; }
    .btn-primary{ background:var(--blue); color:#fff; border:1px solid var(--blue); cursor:pointer; }
    .btn-primary:hover{ background:var(--blue-dark); border-color:var(--blue-dark); }
    .btn-ghost{ background:#fff; border:1px solid var(--stroke); color:#0f172a; cursor:pointer; }
    .btn-ghost:hover{ background:#f8fafc; }

    .status{ margin-top:10px; font-size:.92rem; }
    .status.ok{ color:var(--green); }
    .status.err{ color:var(--danger); }

    /* Modal */
    .modal{ display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:100; align-items:center; justify-content:center; }
    .modal .box{ background:#fff; width:min(480px, 92vw); border-radius:12px; border:1px solid var(--stroke); padding:18px; }
    .modal .box h3{ margin:0 0 10px; font-size:1.1rem; }
    .modal .box .grid2{ display:grid; grid-template-columns:120px 1fr; gap:10px; font-size:.95rem; }
    .modal .box .grid2 div{ padding:6px 0; border-bottom:1px solid #f1f5f9; }
    .modal .box .row-btns{ display:flex; gap:10px; margin-top:16px; }

    /* Footer */
    footer{ border-top:1px solid var(--stroke); background:#fff; }
    .footer-inner{
      max-width:1100px; margin:0 auto; padding:16px 20px;
      display:flex; align-items:center; justify-content:space-between; gap:12px; color:#6b7280; font-size:.9rem;
    }
    .footer-links a{ color:#6b7280; text-decoration:none; margin-left:12px; }
    .footer-links a:hover{ text-decoration:underline; }

@media (max-width: 768px){
  .menu-dots {
  display:none;
  font-size:32px;          /* bigger than before */
  font-weight:900;         /* makes them thicker/bolder */
  line-height:1;
  color:#fff;              /* strong white against dark background */
  background:none;
  border:0;
  cursor:pointer;
  padding:4px 8px;
  margin-left:auto;        /* push it all the way right */
}

/* Only show on mobile */
@media (max-width: 768px){
  .nav-right { display:none; }
  .menu-dots { display:block; }
}
  </style>
</head>
<body>

  <!-- Top Nav -->
  <nav>
    <div class="nav-container">
      <div class="nav-left">
        <a href="cardholder.html" aria-label="BOOP home">
          <img src="assets/logo-white.png" alt="BOOP Logo" />
        </a>
      </div>

      <!-- Desktop links -->
      <div class="nav-right" aria-label="Primary">
        <a href="cardholder.html">Home</a>
        <a href="send-request.html" id="sendRequestLink" aria-current="page">Send / Request</a>
        <a href="transfer.html">Transfer</a>
        <a href="passport.html">Passport</a>
        <a href="activity.html">Activity</a>
        <a href="help.html">Help</a>
        <a href="#" id="logoutBtn">Log Out</a>
      </div>

      <!-- Hamburger -->
      <button class="menu-dots" id="hamburger" aria-label="Open menu" aria-expanded="false" aria-controls="mobileMenu">
  ⋮
</button>
    </div>

    <!-- Mobile slide-out panel + overlay -->
    <div class="nav-overlay" id="navOverlay" aria-hidden="true"></div>
    <div class="nav-panel" id="mobileMenu" role="dialog" aria-modal="true" aria-label="Menu">
      <a href="cardholder.html">Home</a>
      <a href="send-request.html" aria-current="page">Send / Request</a>
      <a href="transfer.html">Transfer</a>
      <a href="passport.html">Passport</a>
      <a href="activity.html">Activity</a>
      <a href="help.html">Help</a>
      <a href="#" id="logoutBtnMobile">Log Out</a>
    </div>
  </nav>

  <!-- HERO -->
  <section class="hero-band">
    <div class="hero-inner">
      <div>
        <h1 class="hero-title">Send or Request Money</h1>
        <p class="hero-sub">Find another BOOP member and move money securely.</p>
      </div>
    </div>
  </section>

  <!-- MAIN -->
  <main class="container">
    <div class="grid">
      <!-- Left: form -->
      <div class="card">
        <div class="row">
          <label>Action</label>
          <div class="toggle" role="tablist" aria-label="Send or Request">
            <button id="btnSend" class="active-send" aria-selected="true">Send</button>
            <button id="btnRequest">Request</button>
          </div>
        </div>

        <div class="row">
          <label for="userSearch">Search user</label>
          <input id="userSearch" type="text" placeholder="Type name or email…" autocomplete="off" />
          <div id="suggestions" class="suggestions"></div>
        </div>

        <div class="row">
          <label for="amount">Amount</label>
          <input id="amount" type="number" min="0.01" step="0.01" placeholder="0.00" />
        </div>

        <div class="row">
          <label for="note">Note (optional)</label>
          <textarea id="note" rows="3" placeholder="What is this for?"></textarea>
        </div>

        <div class="actions">
          <button class="btn-primary" id="submitBtn">Continue</button>
          <button class="btn-ghost" id="clearBtn" type="button">Clear</button>
        </div>
        <div class="status" id="status"></div>
      </div>

      <!-- Right: selection summary -->
      <div class="card">
        <h3 style="margin:0 0 10px;font-size:1.05rem;">Selected</h3>
        <div id="selectedUser" class="pill" aria-live="polite">No recipient selected</div>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer>
    <div class="footer-inner">
      <div>© 2025 BOOP</div>
      <div class="footer-links">
        <a href="/terms.html" target="_blank" rel="noopener">Terms</a>
        <a href="/privacy.html" target="_blank" rel="noopener">Privacy</a>
      </div>
    </div>
  </footer>

  <!-- Confirm Modal -->
  <div class="modal" id="confirmModal" role="dialog" aria-modal="true" aria-labelledby="confirmTitle">
    <div class="box">
      <h3 id="confirmTitle">Confirm</h3>
      <div class="grid2">
        <div>Action</div><div id="cAction">—</div>
        <div>To</div><div id="cTo">—</div>
        <div>Amount</div><div id="cAmount">—</div>
        <div>Note</div><div id="cNote">—</div>
      </div>
      <div class="row-btns">
        <button class="btn-primary" id="confirmYes">Confirm</button>
        <button class="btn-ghost" id="confirmNo">Cancel</button>
      </div>
    </div>
  </div>

  <script>
  (async () => {
    // --- Auth gate: cardholder-only ---
    try {
      const token = localStorage.getItem("boop_jwt");
      if (!token) throw new Error("No token");
      const res = await fetch("/api/me", { headers: { Authorization: `Bearer ${token}` }});
      const me = await res.json();
      if (!res.ok) throw new Error(me?.error || `HTTP ${res.status}`);

      const role = (me.role||"").toLowerCase();
      const type = (me.type||"").toLowerCase();
      const isCardholder =
        role === "cardholder" || type === "cardholder" ||
        role === "cardholder_assistance" || type === "cardholder_assistance";
      if (!isCardholder) throw new Error("Not a cardholder");

      localStorage.setItem("boopUser", JSON.stringify(me));
    } catch (err) {
      console.warn("🔒 Gate failed:", err);
      localStorage.clear();
      window.location.href = "cardholder-login.html";
      return;
    }

    // --- Page logic ---
    (function(){
      // Mobile nav
      const hamburger = document.getElementById('hamburger');
      const panel = document.getElementById('mobileMenu');
      const overlay = document.getElementById('navOverlay');
      function openMenu(){ hamburger.classList.add('active'); panel.classList.add('active'); overlay.classList.add('active'); document.body.style.overflow='hidden'; }
      function closeMenu(){ hamburger.classList.remove('active'); panel.classList.remove('active'); overlay.classList.remove('active'); document.body.style.overflow=''; }
      hamburger?.addEventListener('click', ()=> hamburger.classList.contains('active')? closeMenu(): openMenu());
      overlay?.addEventListener('click', closeMenu);
      document.addEventListener('keydown', e => { if (e.key === 'Escape') closeMenu(); });

      // Elements
      const token = localStorage.getItem("boop_jwt");
      const statusEl = document.getElementById('status');
      const userSearch = document.getElementById('userSearch');
      const suggestions = document.getElementById('suggestions');
      const selectedUserEl = document.getElementById('selectedUser');
      const amountEl = document.getElementById('amount');
      const noteEl = document.getElementById('note');
      const btnSend = document.getElementById('btnSend');
      const btnRequest = document.getElementById('btnRequest');
      const submitBtn = document.getElementById('submitBtn');
      const clearBtn = document.getElementById('clearBtn');

      const modal = document.getElementById('confirmModal');
      const cAction = document.getElementById('cAction');
      const cTo = document.getElementById('cTo');
      const cAmount = document.getElementById('cAmount');
      const cNote = document.getElementById('cNote');
      const confirmYes = document.getElementById('confirmYes');
      const confirmNo = document.getElementById('confirmNo');

      // State
      let mode = 'send'; // 'send' | 'request'
      let selectedUser = null;
      let timer;

      // Helpers
      const dollars = (n)=> `$${Number(n||0).toFixed(2)}`;
      function setStatus(msg, isErr=false){
        statusEl.textContent = msg || '';
        statusEl.className = 'status' + (isErr ? ' err' : msg ? ' ok' : '');
      }
      function escapeHtml(s){
        return String(s)
          .replaceAll('&','&amp;')
          .replaceAll('<','&lt;')
          .replaceAll('>','&gt;')
          .replaceAll('"','&quot;')
          .replaceAll("'","&#39;");
      }

      // Receipt overlay (no reference row)
      function showReceipt({ toName, amount, note, when }){
        const overlay = document.createElement('div');
        overlay.style.position = 'fixed';
        overlay.style.inset = '0';
        overlay.style.background = 'rgba(0,0,0,.45)';
        overlay.style.zIndex = '1000';
        overlay.style.display = 'flex';
        overlay.style.alignItems = 'center';
        overlay.style.justifyContent = 'center';

        const box = document.createElement('div');
        box.style.width = 'min(480px, 92vw)';
        box.style.background = '#fff';
        box.style.border = '1px solid #e5e7eb';
        box.style.borderRadius = '12px';
        box.style.padding = '18px';
        box.style.boxShadow = '0 12px 32px rgba(0,0,0,.18)';
        box.innerHTML = `
          <h3 style="margin:0 0 10px; font-size:1.1rem;">Payment Sent</h3>
          <div style="display:grid; grid-template-columns:140px 1fr; gap:10px; font-size:.95rem;">
            <div style="padding:6px 0; border-bottom:1px solid #f1f5f9;">To</div>
            <div style="padding:6px 0; border-bottom:1px solid #f1f5f9; font-weight:600;">${toName || '—'}</div>

            <div style="padding:6px 0; border-bottom:1px solid #f1f5f9;">Amount</div>
            <div style="padding:6px 0; border-bottom:1px solid #f1f5f9; font-weight:600;">${dollars(amount)}</div>

            <div style="padding:6px 0; border-bottom:1px solid #f1f5f9;">Note</div>
            <div style="padding:6px 0; border-bottom:1px solid #f1f5f9;">${note ? escapeHtml(note) : '—'}</div>

            <div style="padding:6px 0;">When</div>
            <div style="padding:6px 0;">${when ? new Date(when).toLocaleString() : ''}</div>
          </div>
          <div style="display:flex; gap:10px; margin-top:16px; justify-content:flex-end;">
            <button id="receiptCloseBtn" style="background:#2f80ed;color:#fff;border:1px solid #2f80ed;padding:10px 14px;border-radius:8px;cursor:pointer;font-weight:600;">
              Close
            </button>
          </div>
        `;

        overlay.appendChild(box);
        document.body.appendChild(overlay);

        function close(){ overlay.remove(); }
        overlay.addEventListener('click', (e)=>{ if (e.target === overlay) close(); });
        box.querySelector('#receiptCloseBtn').addEventListener('click', close);
        setTimeout(close, 6000);
      }

      // Toggle
      function setMode(newMode){
        mode = newMode;
        btnSend.classList.toggle('active-send', mode==='send');
        btnRequest.classList.toggle('active-request', mode==='request');
      }
      btnSend.addEventListener('click', ()=> setMode('send'));
      btnRequest.addEventListener('click', ()=> setMode('request'));

      // Search (debounced)
      userSearch.addEventListener('input', ()=>{
        const q = userSearch.value.trim();
        clearTimeout(timer);
        if (q.length < 2){ suggestions.style.display='none'; return; }
        timer = setTimeout(()=> searchUsers(q), 220);
      });

      async function searchUsers(q){
        try{
          // Ask backend to exclude student/parent/admin
          const url = `/api/users?search=${encodeURIComponent(q)}&hasWallet=true&exclude_roles=student,parent,admin`;
          const res = await fetch(url, { headers: { Authorization: `Bearer ${token}` }});
          const list = await res.json();

          // Client-side belt & suspenders (filter role AND type)
          const blocked = new Set(['student','parent','admin']);
          const results = (Array.isArray(list)? list: []).filter(u=>{
            const role = (u.role||'').toLowerCase();
            const type = (u.type||'').toLowerCase();
            return !blocked.has(role) && !blocked.has(type);
          });

          const html = results.length
            ? results.map(u=>{
                const name = [u.first_name, u.last_name].filter(Boolean).join(' ') || u.email || 'Unknown';
                const initial = (name[0]||'U').toUpperCase();
                return `<div class="item" data-id="${u.id}" data-name="${name}">
                  <div class="avatar">${initial}</div>
                  <div>
                    <div style="font-weight:600;">${name}</div>
                    <div style="font-size:.86rem; color:#64748b;">${u.email || ''}</div>
                  </div>
                </div>`;
              }).join('')
            : `<div class="item" style="cursor:default;opacity:.7;">No results</div>`;

          suggestions.innerHTML = html;
          suggestions.style.display = 'block';
        }catch(err){
          console.error('search error', err);
          suggestions.innerHTML = `<div class="item" style="cursor:default;color:#b91c1c;">Error searching</div>`;
          suggestions.style.display = 'block';
        }
      }

      suggestions.addEventListener('click', (e)=>{
        const item = e.target.closest('.item');
        if (!item || !item.dataset.id) return;
        selectedUser = { id: item.dataset.id, name: item.dataset.name };
        selectedUserEl.innerHTML = `<span class="avatar">${(selectedUser.name[0]||'U').toUpperCase()}</span> ${selectedUser.name}`;
        suggestions.style.display = 'none';
        userSearch.value = selectedUser.name;
      });

      document.addEventListener('click', (e)=>{
        if (!suggestions.contains(e.target) && e.target !== userSearch){
          suggestions.style.display='none';
        }
      });

      // Submit flow
      submitBtn.addEventListener('click', ()=>{
        const amt = parseFloat(amountEl.value);
        if (!selectedUser){ return setStatus('Please pick a recipient.', true); }
        if (!amt || isNaN(amt) || amt <= 0){ return setStatus('Enter a valid amount.', true); }

        // Fill confirm modal
        cAction.textContent = mode === 'send' ? 'Send' : 'Request';
        cTo.textContent = selectedUser.name;
        cAmount.textContent = dollars(amt);
        cNote.textContent = noteEl.value || '—';
        openModal();
      });

      confirmYes.addEventListener('click', async ()=>{
        try{
          submitBtn.disabled = true;
          confirmYes.disabled = true;

          const payload = {
            to_user_id: selectedUser.id,
            amount: parseFloat(amountEl.value),
            note: noteEl.value || ''
          };

          // Cardholder → P2P transfer endpoint
          const res = await fetch('/api/transfers/p2p', {
            method:'POST',
            headers: { 'Content-Type':'application/json', Authorization:`Bearer ${token}` },
            body: JSON.stringify(payload)
          });
          const data = await res.json().catch(()=> ({}));
          if (!res.ok) throw new Error(data?.message || data?.error || 'Transfer failed');

          // Success UI
          setStatus('✅ Payment sent!', false);
          showReceipt({
            toName: selectedUser.name,
            amount: payload.amount,
            note: payload.note,
            when: data.created_at || Date.now()
          });
          clearForm();
        }catch(err){
          console.error('submit error', err);
          setStatus(`❌ ${err.message}`, true);
        }finally{
          confirmYes.disabled = false;
          submitBtn.disabled = false;
          closeModal();
        }
      });

      confirmNo.addEventListener('click', closeModal);

      clearBtn.addEventListener('click', clearForm);

      function clearForm(){
        selectedUser = null;
        userSearch.value='';
        selectedUserEl.textContent='No recipient selected';
        amountEl.value='';
        noteEl.value='';
        setMode('send');
        setStatus('');
      }

      function openModal(){ modal.style.display='flex'; }
      function closeModal(){ modal.style.display='none'; }

      // Logout links
      function attachLogout(el){
        if (!el) return;
        el.addEventListener('click', async (e)=>{
          e.preventDefault();
          try { await fetch('/api/logout', { method:'POST' }); } catch {}
          localStorage.clear();
          window.location.href = 'cardholder-login.html';
        });
      }
      attachLogout(document.getElementById('logoutBtn'));
      attachLogout(document.getElementById('logoutBtnMobile'));
    })();
  })();
</script>
</body>
</html>
