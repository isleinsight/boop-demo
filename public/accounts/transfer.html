<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Transfers – BOOP Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="../assets/styles.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet" />

  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: #f4f7fa;
      margin: 0;
      padding: 20px;
      color: #111827;
    }

    h1 {
      font-size: 1.5rem;
      margin-bottom: 8px;
    }

    p {
      font-size: 0.9rem;
      color: #6b7280;
      margin-bottom: 16px;
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      height: 38px;
      padding: 0 14px;
      border-radius: 10px;
      border: 1px solid transparent;
      font-weight: 600;
      cursor: pointer;
      transition: background .15s, border-color .15s, color .15s;
    }
    .btn-primary {
      background: #2f80ed;
      color: #fff;
      border-color: #2f80ed;
    }
    .btn-primary:hover {
      background: #1c6fd8;
      border-color: #1c6fd8;
    }
    .btn-secondary {
      background: #6b7280;
      color: #fff;
      border-color: #6b7280;
    }
    .btn-secondary:hover {
      background: #4b5563;
      border-color: #4b5563;
    }
    .btn-ghost {
      background: #ffffff;
      color: #1f2937;
      border-color: #e5e7eb;
    }
    .btn-ghost:hover {
      border-color: #cbd5e1;
    }

    /* Tab buttons */
    .tab-btn {
      height: 34px;
      padding: 0 12px;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      background: #fff;
      color: #374151;
      font-weight: 600;
      cursor: pointer;
    }
    .tab-btn.active {
      border-color: #2f80ed;
      color: #0f172a;
    }

    /* Filters layout */
    .filters-bar {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 12px;
      margin: 12px 0;
    }
    .filters-grid {
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 10px;
      align-items: end;
    }
    .filters-grid .cell-4 { grid-column: span 4; }
    .filters-grid .cell-3 { grid-column: span 3; }
    .filters-grid .cell-2 { grid-column: span 2; }
    .filters-grid label {
      display: block;
      font-size: .85rem;
      color: #6b7280;
      margin: 0 0 6px;
    }
    .filters-grid input[type="date"],
    .filters-grid select {
      width: 100%;
      height: 38px;
      padding: 0 10px;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      font: inherit;
      background: #fff;
      color: #111827;
    }
    .filters-actions {
      display: flex;
      gap: 8px;
      justify-content: flex-start;
    }
    @media (max-width: 820px) {
      .filters-grid { grid-template-columns: 1fr 1fr; }
      .filters-grid .cell-4, .filters-grid .cell-3, .filters-grid .cell-2 { grid-column: span 1; }
    }
    @media (max-width: 520px) {
      .filters-grid { grid-template-columns: 1fr; }
    }

    /* Table */
    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      border-radius: 12px;
      overflow: hidden;
    }
    table th, table td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid #e5e7eb;
      font-size: 0.9rem;
    }
    table th {
      background: #f9fafb;
      font-weight: 600;
      color: #374151;
    }
    table tbody tr:hover {
      background: #f3f4f6;
    }
    .table-actions .btn {
      height: 32px;
      border-radius: 8px;
      padding: 0 10px;
      font-size: 0.8rem;
    }

    /* Pagination */
    .pagination {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-top: 10px;
    }
    .pagination button {
      border-radius: 8px;
      height: 32px;
      padding: 0 10px;
      border: 1px solid #e5e7eb;
      background: #fff;
      cursor: pointer;
    }
    .pagination button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
  </style>
</head>
<body>

  <h1>Transfer Requests</h1>
  <p>Requests can be claimed by an accountant to prevent double processing. Mark as Completed only after you’ve moved the funds in the bank and recorded the <em>Bank Reference</em>.</p>

  <!-- Top right buttons -->
  <div style="display:flex; gap:8px; margin-bottom: 10px;">
    <button id="refreshBtn" class="btn btn-ghost">Refresh</button>
    <button id="exportCsvBtn" class="btn btn-primary">Export CSV</button>
  </div>

  <!-- Filters -->
  <div class="filters-bar">
    <!-- Status tabs -->
    <div style="display:flex; gap:8px; margin-bottom:10px;">
      <button class="tab-btn active" id="tabPending">Pending</button>
      <button class="tab-btn" id="tabClaimed">Claimed</button>
      <button class="tab-btn" id="tabCompleted">Completed</button>
    </div>

    <!-- Filter inputs -->
    <div class="filters-grid">
      <div class="cell-3">
        <label for="startDate">Start date</label>
        <input type="date" id="startDate">
      </div>
      <div class="cell-3">
        <label for="endDate">End date</label>
        <input type="date" id="endDate">
      </div>
      <div class="cell-4">
        <label for="bankFilter">Bank</label>
        <select id="bankFilter">
          <option value="">All</option>
          <option value="HSBC">HSBC</option>
          <option value="Butterfield">Butterfield</option>
        </select>
      </div>
      <div class="cell-2 filters-actions">
        <button id="applyFilters" class="btn btn-primary">Apply</button>
        <button id="clearFilters" class="btn btn-secondary">Clear</button>
      </div>
    </div>
  </div>

  <!-- Table -->
  <table id="transferTable">
    <thead>
      <tr>
        <th>Requested</th>
        <th>Request ID</th>
        <th>Cardholder</th>
        <th>Amount</th>
        <th>Destination (masked)</th>
        <th>Status</th>
        <th>Claimed By</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <!-- Populated by transfers.js -->
    </tbody>
  </table>

  <!-- Pagination -->
  <div class="pagination">
    <button id="prevPage">Previous</button>
    <span id="pageInfo">Page 1</span>
    <button id="nextPage">Next</button>
  </div>

  <!-- Details / Action Modal -->
  <div id="detailsModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="detailsTitle">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="detailsTitle">Transfer Request</h3>
        <span class="close" id="closeDetails">&times;</span>
      </div>

      <!-- Summary -->
      <div class="two-col" style="margin-bottom:6px;">
        <div class="field">
          <label>Request ID</label>
          <input id="d_reqId" type="text" disabled>
        </div>
        <div class="field">
          <label>Status</label>
          <input id="d_status" type="text" disabled>
        </div>
      </div>

      <div class="two-col">
        <div class="field">
          <label>Cardholder</label>
          <input id="d_user" type="text" disabled>
        </div>
        <div class="field">
          <label>Requested At</label>
          <input id="d_requestedAt" type="text" disabled>
        </div>
      </div>

      <div class="two-col">
        <div class="field">
          <label>Amount</label>
          <input id="d_amount" type="text" disabled>
        </div>
        <div class="field">
          <label>Preferred Bank</label>
          <input id="d_bank" type="text" disabled>
        </div>
      </div>

      <div class="field">
        <label>Destination (masked)</label>
        <input id="d_destination" type="text" disabled>
      </div>

      <hr style="border:none;border-top:1px solid var(--stroke); margin:10px 0;">

      <!-- Action form -->
      <div class="two-col">
        <div class="field">
          <label for="d_treasury">Source Treasury</label>
          <select id="d_treasury">
            <option value="">Select treasury</option>
            <!-- filled by JS from /api/treasury/treasury-wallets -->
          </select>
        </div>
        <div class="field">
          <label for="d_bankRef">Bank Reference #</label>
          <input id="d_bankRef" type="text" placeholder="Paste confirmation from bank portal">
        </div>
      </div>

      <div class="field">
        <label for="d_internalNote">Internal note (optional)</label>
        <textarea id="d_internalNote" rows="3" placeholder="Any context for audit…"></textarea>
      </div>

      <div class="modal-actions">
        <button id="claimBtn" class="btn warn" title="Reserve for me">Claim</button>
        <button id="releaseBtn" class="btn secondary" title="Release back to queue">Release</button>
        <button id="rejectBtn" class="btn danger">Reject</button>
        <button id="completeBtn" class="btn">Mark Completed</button>
      </div>

      <div class="muted" id="d_helper" style="margin-top:6px;">
        Mark Completed only after you’ve moved funds in the bank and entered the Bank Reference #.
      </div>
    </div>
  </div>

  <!-- Permissions + nav visibility -->
  <script>
    (async () => {
      try {
        const token = localStorage.getItem("boop_jwt");
        if (!token) throw new Error("No token");
        const res = await fetch("/api/me", { headers: { Authorization: `Bearer ${token}` }});
        const me = await res.json();
        if (res.status !== 200) throw new Error("Auth failed");

        // must be admin + accountant OR treasury
        if (me.role !== "admin" || !["accountant","treasury","viewer"].includes(me.type)) {
          throw new Error("Not authorized");
        }
        localStorage.setItem("boopUser", JSON.stringify(me));

        // Nav rules
        const addFundsLink = document.getElementById("addFundsLink");
        const manageTreasuryLink = document.getElementById("manageTreasuryLink");
        if (me.type === "treasury" && addFundsLink) addFundsLink.style.display = "none";
        if (me.type === "accountant" && manageTreasuryLink) manageTreasuryLink.style.display = "none";

        // Logout
        document.getElementById("logoutBtn")?.addEventListener("click", async (e) => {
          e.preventDefault();
          try { await fetch("/api/logout", { method:"POST" }); } catch {}
          localStorage.clear();
          window.location.href = "login.html";
        });

      } catch (err) {
        localStorage.clear();
        window.location.href = "login.html";
      }
    })();
  </script>

  <!-- Page logic (separate file) -->
  <script type="module" src="transfers.js"></script>
</body>
</html>
