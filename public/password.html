<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>BOOP — Password</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --ink:#1a2b4a;
      --muted:#6b7280;
      --stroke:#e6ebf1;
      --blue:#2f80ed;
      --green:#10b981;
      --red:#ef4444;
      --bg:#f5f8fb;
    }
    * { box-sizing: border-box; }
    body {
      margin:0; font-family: Poppins, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg); color: #111827;
    }
    .wrap {
      min-height: 100svh; display: grid; place-items: center; padding: 24px;
    }
    .card {
      width: 100%; max-width: 520px; background: #fff;
      border: 1px solid var(--stroke); border-radius: 14px;
      box-shadow: 0 10px 30px rgba(16,24,40,.08);
      overflow: hidden;
    }
    .card__head {
      background: var(--ink); padding: 18px 22px; display: flex; align-items: center; gap: 12px;
    }
    .logo { height: 30px; display: block; }
    .card__body { padding: 22px; }
    h1 { margin: 8px 0 6px; font-size: 22px; color:#111827 }
    p.sub { margin: 0 0 18px; color: var(--muted); }
    form { display: grid; gap: 14px; }
    label { font-size: .95rem; color: var(--ink); font-weight: 500; margin-bottom: 6px; display:block; }
    .field { display: grid; gap: 6px; }
    .input-wrap {
      position: relative;
    }
    input[type="password"], input[type="text"] {
      width: 100%; padding: 12px 42px 12px 12px; border:1px solid var(--stroke); border-radius: 8px;
      font-size: .95rem; outline: none; transition: border-color .2s ease;
    }
    input:focus { border-color: var(--blue); }
    .toggle {
      position:absolute; right: 10px; top: 50%; transform: translateY(-50%);
      font-size: .85rem; color: var(--muted); cursor: pointer; user-select:none;
      padding: 2px 6px;
    }
    .req {
      display: grid; gap: 6px; font-size: .9rem; color: var(--muted); margin-top: -4px;
    }
    .req span { display:flex; align-items:center; gap:8px; }
    .dot { width:10px; height:10px; border-radius:999px; background:#d1d5db; }
    .dot.ok { background: var(--green); }
    .dot.bad { background: var(--red); }
    .strength {
      height: 8px; background:#eef2f7; border-radius: 999px; overflow:hidden; margin-top:4px;
    }
    .strength > div { height:100%; width:0%; background: var(--red); transition: width .25s ease; }
    .hint { font-size: .85rem; color: var(--muted); margin-top: -4px; }
    .error { color: var(--red); font-size: .9rem; }
    .success {
      padding: 14px; border:1px solid #bbf7d0; background:#f0fdf4; color:#065f46; border-radius:10px; margin-top:8px;
    }
    button[type="submit"], .btn {
      width: 100%; padding: 12px 14px; border:0; border-radius: 10px; background: var(--blue);
      color:#fff; font-weight: 600; cursor: pointer; font-size: 1rem; transition: background .15s ease;
    }
    button[disabled] { opacity: .6; cursor: not-allowed; }
    .btn.secondary { background: #e5e7eb; color:#111827; }
    .foot {
      padding: 14px 22px; background:#f9fafb; color: var(--muted); font-size:.85rem; text-align:center;
    }
    .center { text-align:center; }
    .hidden { display:none !important; }
    .mt8 { margin-top: 8px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="card__head">
        <!-- Your logo is white, so dark header keeps it visible -->
        <img class="logo" src="/assets/Boop-Logo.png" alt="BOOP">
      </div>
      <div class="card__body">
        <h1 id="title">Reset your password</h1>
        <p class="sub" id="subtitle">Choose a new password to secure your account.</p>

        <div id="tokenError" class="error hidden">The link is missing or invalid. Please request a new one.</div>

        <form id="resetForm" class="hidden" novalidate>
          <div class="field">
            <label for="password">New password</label>
            <div class="input-wrap">
              <input type="password" id="password" autocomplete="new-password" required />
              <span class="toggle" data-target="password">Show</span>
            </div>
            <div class="strength"><div id="strengthBar"></div></div>
            <div class="req">
              <span><span id="reqLen" class="dot"></span> At least <strong id="minLen">8</strong> characters</span>
              <span><span id="reqLetter" class="dot"></span> At least one letter</span>
              <span><span id="reqNumber" class="dot"></span> At least one number</span>
            </div>
          </div>

          <div class="field">
            <label for="confirm">Confirm password</label>
            <div class="input-wrap">
              <input type="password" id="confirm" autocomplete="new-password" required />
              <span class="toggle" data-target="confirm">Show</span>
            </div>
            <div id="matchErr" class="error hidden">Passwords don’t match.</div>
          </div>

          <div id="serverErr" class="error hidden"></div>
          <div id="serverOk" class="success hidden">Your password was updated successfully.</div>

          <button id="submitBtn" type="submit" disabled>Continue</button>
          <a id="loginBtn" class="btn secondary hidden mt8" href="/login.html">Go to login</a>
        </form>
      </div>
      <div class="foot">
        This link expires for your security. Didn’t request this? Simply ignore this email.
      </div>
    </div>
  </div>

  <script>
    (function () {
      const qs = new URLSearchParams(location.search);
      const mode = (qs.get('mode') || '').toLowerCase(); // setup | admin | forgot | (empty)
      const token = qs.get('token') || '';

      const title = document.getElementById('title');
      const subtitle = document.getElementById('subtitle');
      const tokenError = document.getElementById('tokenError');
      const form = document.getElementById('resetForm');
      const minLenEl = document.getElementById('minLen');

      // Mirror your backend setting if you change it
      const PASSWORD_MIN_LEN = 8; // keep in sync with PASSWORD_MIN_LEN env / backend
      minLenEl.textContent = PASSWORD_MIN_LEN;

      // Adjust copy by mode
      switch (mode) {
        case 'setup':
          title.textContent = 'Set your password';
          subtitle.textContent = 'Welcome to BOOP. Create your password to finish setting up your account.';
          break;
        case 'admin':
          title.textContent = 'Reset your password';
          subtitle.textContent = 'An administrator started a password reset for your account.';
          break;
        case 'forgot':
          title.textContent = 'Reset your password';
          subtitle.textContent = 'Choose a new password to get back into your account.';
          break;
        default:
          // Unknown mode is fine; keep generic copy
          break;
      }

      if (!token || token.length < 16) {
        tokenError.classList.remove('hidden');
        return;
      }
      form.classList.remove('hidden');

      const password = document.getElementById('password');
      const confirm = document.getElementById('confirm');
      const reqLen = document.getElementById('reqLen');
      const reqLetter = document.getElementById('reqLetter');
      const reqNumber = document.getElementById('reqNumber');
      const strengthBar = document.getElementById('strengthBar');
      const matchErr = document.getElementById('matchErr');
      const serverErr = document.getElementById('serverErr');
      const serverOk = document.getElementById('serverOk');
      const submitBtn = document.getElementById('submitBtn');
      const loginBtn = document.getElementById('loginBtn');

      function setDot(el, ok) {
        el.classList.toggle('ok', ok);
        el.classList.toggle('bad', !ok && (password.value.length > 0));
      }

      function score(pw) {
        let s = 0;
        if (pw.length >= PASSWORD_MIN_LEN) s += 25;
        if (/[A-Za-z]/.test(pw)) s += 25;
        if (/\d/.test(pw)) s += 25;
        if (/[^A-Za-z0-9]/.test(pw)) s += 25;
        return s;
      }

      function updateUI() {
        const pw = password.value;
        const okLen = pw.length >= PASSWORD_MIN_LEN;
        const okLetter = /[A-Za-z]/.test(pw);
        const okNumber = /\d/.test(pw);

        setDot(reqLen, okLen);
        setDot(reqLetter, okLetter);
        setDot(reqNumber, okNumber);

        const sc = score(pw);
        strengthBar.style.width = sc + '%';
        strengthBar.style.background = sc >= 75 ? '#10b981' : sc >= 50 ? '#f59e0b' : '#ef4444';

        const match = pw && confirm.value && pw === confirm.value;
        matchErr.classList.toggle('hidden', match || !confirm.value);

        const valid = okLen && okLetter && okNumber && match;
        submitBtn.disabled = !valid;
        serverErr.classList.add('hidden');
      }

      document.querySelectorAll('.toggle').forEach(t => {
        t.addEventListener('click', () => {
          const id = t.getAttribute('data-target');
          const input = document.getElementById(id);
          if (!input) return;
          const isPwd = input.type === 'password';
          input.type = isPwd ? 'text' : 'password';
          t.textContent = isPwd ? 'Hide' : 'Show';
        });
      });

      password.addEventListener('input', updateUI);
      confirm.addEventListener('input', updateUI);

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        submitBtn.disabled = true;
        serverErr.classList.add('hidden');
        serverOk.classList.add('hidden');

        try {
          const res = await fetch('/api/password/reset', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ token, newPassword: password.value })
          });

          const data = await res.json().catch(() => ({}));

          if (!res.ok) {
            const msg = data?.error || data?.message || 'Something went wrong.';
            serverErr.textContent = msg;
            serverErr.classList.remove('hidden');
            submitBtn.disabled = false;
            return;
          }

          serverOk.textContent = 'Your password has been set. You can now sign in.';
          serverOk.classList.remove('hidden');
          submitBtn.classList.add('hidden');
          loginBtn.classList.remove('hidden');

        } catch (err) {
          serverErr.textContent = 'Network error. Please try again.';
          serverErr.classList.remove('hidden');
          submitBtn.disabled = false;
        }
      });

      // Initial UI
      updateUI();
    })();
  </script>
</body>
</html>
