<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Activity – BOOP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --ink:#102a43;
      --muted:#6b7c93;
      --blue:#2f80ed;
      --blue-dark:#1a5fcc;
      --stroke:#e5e7eb;
      --bg:#ffffff;
      --nav:#102a43;
      --grad1: rgba(47,128,237,.18);
      --grad2: rgba(16,185,129,.15);
      --green:#16a34a;
      --red:#dc2626;
    }
    *{box-sizing:border-box}
    body{ margin:0; font-family:'Poppins',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background:var(--bg); color:var(--ink); }

    /* NAV */
    nav{ background:var(--nav); color:#fff; position:sticky; top:0; z-index:50; }
    .nav-container{ max-width:1100px; margin:0 auto; padding:12px 20px; display:flex; align-items:center; justify-content:space-between; }
    .nav-left img{ height:36px; display:block }
    .nav-right{ display:flex; align-items:center; gap:18px; }
    .nav-right a{ color:#fff; text-decoration:none; font-size:.95rem; opacity:.95; }
    .nav-right a:hover{ opacity:1 }

    /* Mobile menu */
    .hamburger{ display:none; flex-direction:column; justify-content:space-between; width:26px; height:20px; background:none; border:0; cursor:pointer; }
    .hamburger span{ width:100%; height:3px; background:#fff; border-radius:2px; transition:transform .25s, opacity .25s; }
    .hamburger.active span:nth-child(1){ transform:translateY(8.5px) rotate(45deg); }
    .hamburger.active span:nth-child(2){ opacity:0; }
    .hamburger.active span:nth-child(3){ transform:translateY(-8.5px) rotate(-45deg); }
    .nav-panel{ display:none; }
    @media (max-width: 768px){
      .nav-right{ display:none; }
      .hamburger{ display:flex; }
      .nav-panel{
        display:block; position:fixed; top:0; right:-100%; height:100vh; width:260px;
        background:#ffffff; color:#111827; box-shadow:-4px 0 14px rgba(0,0,0,.18);
        transition:right .3s ease; z-index:60; padding:80px 20px 20px;
      }
      .nav-panel.active{ right:0; }
      .nav-panel a{ display:block; color:#111827; text-decoration:none; padding:12px 8px; border-radius:8px; margin-bottom:6px; font-weight:600; }
      .nav-panel a:hover{ background:#f3f4f6; }
      .nav-overlay{ display:none; position:fixed; inset:0; background:rgba(0,0,0,.35); z-index:55; }
      .nav-overlay.active{ display:block; }
    }

    /* HERO */
    .hero-band{
      background:
        radial-gradient(1000px 600px at 85% -10%, var(--grad1), transparent 60%),
        radial-gradient(700px 500px at -10% 110%, var(--grad2), transparent 60%),
        linear-gradient(180deg, #0b1220 0%, #0d1220 40%, #0b1220 100%);
      color:#eef2ff; padding:26px 0 22px;
    }
    .hero-inner{ max-width:1100px; margin:0 auto; padding:0 20px; display:flex; align-items:center; justify-content:space-between; gap:16px; }
    .hero-title{ margin:0; font-size:clamp(20px, 3.2vw, 28px); font-weight:600; }
    .hero-sub{ margin:6px 0 0; color:#cbd5e1; font-size:.95rem; }

    /* MAIN */
    .container{ max-width:1100px; margin:18px auto 40px; padding:0 20px; }

    .filters{
      display:flex; flex-wrap:wrap; gap:10px; align-items:end; margin-bottom:16px;
      border:1px solid var(--stroke); border-radius:12px; padding:12px;
      background:#fff;
    }
    .filters .btn-group{ display:flex; gap:8px; }
    .filters .btn-group button{
      padding:8px 12px; border:1px solid var(--stroke); border-radius:999px; background:#fff; cursor:pointer; font-weight:600;
    }
    .filters .btn-group button.active{
      background:var(--blue); color:#fff; border-color:var(--blue);
    }
    .filters input{ padding:10px 12px; border:1px solid var(--stroke); border-radius:8px; font-size:.95rem; }
    .spacer{ flex:1; }

    /* Export button – BOOP blue */
    .export-btn{
      background:var(--blue); color:#fff; border:none; padding:10px 14px; border-radius:8px; cursor:pointer; font-weight:600;
      transition:background-color .2s ease-in-out;
    }
    .export-btn:hover{ background:var(--blue-dark); }

    .list{ display:grid; gap:10px; }
    .item{
      background:#fff; border:1px solid var(--stroke); border-radius:12px;
      padding:12px 14px; display:flex; align-items:center; gap:12px;
    }
    .avatar{
      width:42px; height:42px; border-radius:50%; background:#e2e8f0; display:flex; align-items:center; justify-content:center;
      font-weight:700; color:#334155; flex:0 0 42px;
    }
    .line{
      display:flex; align-items:center; justify-content:space-between; width:100%;
    }
    .who{ font-weight:600; }
    .desc{ font-size:.9rem; color:#64748b; }
    .amt{ font-weight:700; }
    .amt.positive{ color:var(--green); }
    .amt.negative{ color:var(--red); }
    .meta{ font-size:.85rem; color:#94a3b8; margin-top:2px; }

    .empty{ text-align:center; color:#64748b; padding:20px; border:1px dashed var(--stroke); border-radius:12px; background:#fff; }
  </style>
</head>
<body>

  <!-- NAV -->
  <nav>
    <div class="nav-container">
      <div class="nav-left">
        <a href="cardholder.html"><img src="assets/Boop-Logo.png" alt="BOOP Logo" /></a>
      </div>
      <div class="nav-right">
        <a href="cardholder.html">Home</a>
        <a href="send-request.html">Send / Request</a>
        <a href="wallet.html">Wallet</a>
        <a href="activity.html" aria-current="page">Activity</a>
        <a href="help.html">Help</a>
        <a href="#" id="logoutBtn">Log Out</a>
      </div>
      <button class="hamburger" id="hamburger" aria-label="Open menu" aria-expanded="false" aria-controls="mobileMenu">
        <span></span><span></span><span></span>
      </button>
    </div>
    <div class="nav-overlay" id="navOverlay" aria-hidden="true"></div>
    <div class="nav-panel" id="mobileMenu" role="dialog" aria-modal="true" aria-label="Menu">
      <a href="cardholder.html">Home</a>
      <a href="send-request.html">Send / Request</a>
      <a href="wallet.html">Wallet</a>
      <a href="activity.html" aria-current="page">Activity</a>
      <a href="help.html">Help</a>
      <a href="#" id="logoutBtnMobile">Log Out</a>
    </div>
  </nav>

  <!-- HERO -->
  <section class="hero-band">
    <div class="hero-inner">
      <div>
        <h1 class="hero-title">Activity</h1>
        <p class="hero-sub">Track your recent payments and requests.</p>
      </div>
    </div>
  </section>

  <!-- MAIN -->
  <main class="container">

    <!-- Filters -->
    <div class="filters">
      <div class="btn-group" role="group" aria-label="Quick ranges">
        <button id="btn7">Last 7 days</button>
        <button id="btn30" class="active">Last 30 days</button>
        <button id="btn90">Last 90 days</button>
      </div>
      <div class="spacer"></div>
      <div>
        <label style="display:block;font-size:.85rem;color:#64748b;margin:0 0 6px;">Custom range</label>
        <div style="display:flex; gap:8px;">
          <input type="date" id="startDate">
          <input type="date" id="endDate">
          <button id="applyCustom">Apply</button>
        </div>
      </div>
      <div class="spacer"></div>
      <button id="exportBtn" class="export-btn">Export CSV</button>
    </div>

    <!-- List -->
    <div id="list" class="list">
      <div class="empty">Loading…</div>
    </div>

  </main>

  <!-- Permissions gate (cardholder only) -->
  <script>
    (async () => {
      try {
        const token = localStorage.getItem("boop_jwt");
        if (!token) throw new Error("No token");
        const res = await fetch("/api/me", { headers: { Authorization: `Bearer ${token}` }});
        const me = await res.json();
        if (res.status === 401 || res.status === 403) throw new Error("Unauthorized");
        const role = (me.role||"").toLowerCase();
        const type = (me.type||"").toLowerCase();
        const ok = role === "cardholder" || type === "cardholder" || role === "cardholder_assistance" || type === "cardholder_assistance";
        if (!ok) throw new Error("Not a cardholder");
        localStorage.setItem("boopUser", JSON.stringify(me));
      } catch (err) {
        localStorage.clear();
        window.location.href = "cardholder-login.html";
      }
    })();
  </script>

  <!-- Page logic -->
  <script>
    (function(){
      // Mobile nav
      const hamburger = document.getElementById('hamburger');
      const panel = document.getElementById('mobileMenu');
      const overlay = document.getElementById('navOverlay');
      function openMenu(){ hamburger.classList.add('active'); panel.classList.add('active'); overlay.classList.add('active'); document.body.style.overflow='hidden'; }
      function closeMenu(){ hamburger.classList.remove('active'); panel.classList.remove('active'); overlay.classList.remove('active'); document.body.style.overflow=''; }
      hamburger?.addEventListener('click', ()=> hamburger.classList.contains('active')? closeMenu(): openMenu());
      overlay?.addEventListener('click', closeMenu);
      document.addEventListener('keydown', e => { if (e.key === 'Escape') closeMenu(); });

      const token = localStorage.getItem("boop_jwt");
      const listEl = document.getElementById('list');

      let allTx = []; // last 50 from API
      let filtered = [];

      // Quick range buttons
      const btn7 = document.getElementById('btn7');
      const btn30 = document.getElementById('btn30');
      const btn90 = document.getElementById('btn90');
      const startEl = document.getElementById('startDate');
      const endEl = document.getElementById('endDate');
      const applyCustom = document.getElementById('applyCustom');
      const exportBtn = document.getElementById('exportBtn');

      function dollars(cents){ return `$${(Number(cents||0)/100).toFixed(2)}`; }
      function byDateDesc(a,b){ return new Date(b.created_at) - new Date(a.created_at); }

      function setActive(btn){
        [btn7, btn30, btn90].forEach(b => b.classList.toggle('active', b===btn));
      }

      function withinRange(tx, start, end){
        const t = new Date(tx.created_at).getTime();
        if (start && t < start) return false;
        if (end && t > end) return false;
        return true;
      }

      function render(){
        if (!filtered.length){
          listEl.innerHTML = `<div class="empty">No activity for this range.</div>`;
          return;
        }
        listEl.innerHTML = filtered.map(tx=>{
          // Direction: for cardholder, credit = received, debit = sent
          const isCredit = (tx.type || '').toLowerCase() === 'credit';
          const who = isCredit ? (tx.sender_name || tx.from_name || 'Someone') : (tx.recipient_name || tx.to_name || 'Someone');
          const verb = isCredit ? 'Received from' : 'Sent to';
          const sign = isCredit ? '+' : '−';
          const cls = isCredit ? 'positive' : 'negative';
          const initials = (who?.trim?.()[0] || 'U').toUpperCase();
          const when = new Date(tx.created_at).toLocaleString();
          const note = tx.note ? ` • ${tx.note}` : '';
          return `
            <div class="item">
              <div class="avatar">${initials}</div>
              <div class="line">
                <div>
                  <div class="who">${verb} ${who}</div>
                  <div class="meta">${when}${note}</div>
                </div>
                <div class="amt ${cls}">${sign}${dollars(tx.amount_cents)}</div>
              </div>
            </div>
          `;
        }).join('');
      }

      function applyRange(days){
        const now = Date.now();
        const start = now - days*24*60*60*1000;
        const end = now;
        setActive(days===7 ? btn7 : days===30 ? btn30 : btn90);
        filtered = allTx.filter(tx => withinRange(tx, start, end)).sort(byDateDesc);
        render();
      }

      function applyCustomRange(){
        const s = startEl.value ? new Date(startEl.value).setHours(0,0,0,0) : null;
        const e = endEl.value ? new Date(endEl.value).setHours(23,59,59,999) : null;
        setActive(null);
        filtered = allTx.filter(tx => withinRange(tx, s, e)).sort(byDateDesc);
        render();
      }

      btn7.addEventListener('click', ()=> applyRange(7));
      btn30.addEventListener('click', ()=> applyRange(30));
      btn90.addEventListener('click', ()=> applyRange(90));
      applyCustom.addEventListener('click', applyCustomRange);

      exportBtn.addEventListener('click', ()=>{
        if (!filtered.length) return;
        const headers = ["Date","Direction","Counterparty","Amount","Note","TxID"];
        const rows = filtered.map(tx=>{
          const isCredit = (tx.type||'').toLowerCase()==='credit';
          const dir = isCredit ? "Received" : "Sent";
          const who = isCredit ? (tx.sender_name || tx.from_name || '') : (tx.recipient_name || tx.to_name || '');
          return [
            new Date(tx.created_at).toISOString(),
            dir,
            who,
            (Number(tx.amount_cents||0)/100).toFixed(2),
            (tx.note||"").replace(/,/g," "),
            tx.id || ""
          ];
        });
        const csv = [headers, ...rows].map(r=>r.join(",")).join("\n");
        const blob = new Blob([csv], { type:"text/csv" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url; a.download = "boop-activity.csv";
        document.body.appendChild(a); a.click(); a.remove();
        URL.revokeObjectURL(url);
      });

      async function loadMine(){
        try{
          const res = await fetch('/api/transactions/mine', {
            headers: { Authorization: `Bearer ${token}` }
          });
          const rows = await res.json();
          if (!Array.isArray(rows)){
            listEl.innerHTML = `<div class="empty">Couldn’t load activity.</div>`;
            return;
          }
          // Normalize possible missing fields
          allTx = rows.map(r => ({
            id: r.id,
            created_at: r.created_at,
            type: r.type,               // 'credit' | 'debit'
            amount_cents: r.amount_cents,
            note: r.note,
            sender_name: r.sender_name || r.from_name,   // if backend adds later
            recipient_name: r.recipient_name || r.to_name
          }));
          // Default to 30 days
          applyRange(30);
        } catch (e){
          console.warn('mine error', e);
          listEl.innerHTML = `<div class="empty">Couldn’t load activity.</div>`;
        }
      }

      // Logout
      function attachLogout(el){
        if (!el) return;
        el.addEventListener('click', async (e)=>{
          e.preventDefault();
          try { await fetch('/api/logout', { method:'POST' }); } catch {}
          localStorage.clear();
          window.location.href = 'cardholder-login.html';
        });
      }
      attachLogout(document.getElementById('logoutBtn'));
      attachLogout(document.getElementById('logoutBtnMobile'));

      // Go
      loadMine();
    })();
  </script>
</body>
</html>
