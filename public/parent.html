<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Parent Portal — BOOP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Parents can track spending, add funds, and manage their child's BOOP Card." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --ink:#0f1f36; --boop:#2f80ed; --muted:#6b7280; --stroke:#e5e7eb;
      --bg:#f5f8fb; --card:#ffffff; --ok:#10b981; --warn:#f59e0b; --danger:#ef4444;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:#1f2937}
    /* Header */
    .nav{background:var(--ink);padding:12px 18px}
    .nav .inner{max-width:1120px;margin:0 auto;display:flex;align-items:center}
    .nav img{height:28px;display:block}
    /* Layout */
    .wrap{max-width:1120px;margin:0 auto;padding:28px 18px}
    .hero{display:grid;gap:18px;grid-template-columns:1.4fr .9fr;align-items:start}
    @media (max-width:900px){ .hero{grid-template-columns:1fr} }
    /* Left side */
    .eyebrow{color:var(--boop);font-weight:600;letter-spacing:.02em;text-transform:uppercase;font-size:.9rem}
    h1{font-size:clamp(28px,3.2vw,40px);margin:6px 0}
    .lead{color:var(--muted);margin:0 0 14px;max-width:720px}
    .grid{display:grid;gap:14px;grid-template-columns:1fr 1fr}
    @media (max-width:700px){ .grid{grid-template-columns:1fr} }
    .card{background:var(--card);border:1px solid var(--stroke);border-radius:14px;box-shadow:0 10px 24px rgba(16,24,40,.06);padding:18px}
    .card h3{margin:0 0 6px}
    ul.clean{margin:8px 0 0;list-style:none;padding:0;display:grid;gap:8px;color:#374151}
    ul.clean li{display:flex;gap:10px;align-items:flex-start}
    .dot{width:8px;height:8px;border-radius:99px;background:var(--boop);margin-top:8px;flex:0 0 8px}
    /* Login card */
    .loginCard{background:#fff;border:1px solid var(--stroke);border-radius:16px;box-shadow:0 12px 28px rgba(16,24,40,.08);padding:20px;position:sticky;top:24px}
    .loginCard h2{margin:0 0 6px}
    .loginCard p{margin:0 0 12px;color:var(--muted)}
    form{display:grid;gap:12px}
    input{width:100%;padding:12px 14px;border:1px solid var(--stroke);border-radius:10px;font-size:.95rem;outline:none;transition:border-color .15s ease}
    input:focus{border-color:var(--boop)}
    button{width:100%;padding:12px 14px;border:0;border-radius:10px;background:var(--boop);color:#fff;font-weight:600;font-size:1rem;cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
    .help{display:flex;justify-content:space-between;align-items:center;font-size:.9rem}
    .help a{color:var(--boop);text-decoration:none}
    .msg{font-size:.92rem;margin-top:6px;display:none}
    .msg.error{color:var(--danger)}
    .msg.ok{color:var(--ok)}
    .tip{font-size:.85rem;color:var(--muted);margin-top:6px}
  </style>
</head>
<body>
  <!-- Header with white logo -->
  <header class="nav">
    <div class="inner">
      <a href="/"><img src="/assets/Boop-Logo.png" alt="BOOP" /></a>
    </div>
  </header>

  <main class="wrap">
    <section class="hero">
      <!-- LEFT: Info -->
      <div>
        <div class="eyebrow">Parent Portal</div>
        <h1>See spending, add funds, and keep your child on track.</h1>
        <p class="lead">The BOOP Parent Portal gives you a clear view into your child’s BOOP Card activity—with simple tools to add funds and set helpful limits.</p>

        <div class="grid">
          <div class="card">
            <h3>Real-time tracking</h3>
            <ul class="clean">
              <li><span class="dot"></span><span>See recent purchases and running balance at a glance.</span></li>
              <li><span class="dot"></span><span>Instant alerts (coming soon) for large or unusual transactions.</span></li>
            </ul>
          </div>
          <div class="card">
            <h3>Add funds fast</h3>
            <ul class="clean">
              <li><span class="dot"></span><span>Top up your child’s BOOP Card in a few taps.</span></li>
              <li><span class="dot"></span><span>Auto-reload rules (coming soon) so they’re never stuck.</span></li>
            </ul>
          </div>
          <div class="card">
            <h3>Helpful controls</h3>
            <ul class="clean">
              <li><span class="dot"></span><span>Daily/weekly spending caps (program-dependent).</span></li>
              <li><span class="dot"></span><span>Category safeguards so money goes to essentials.</span></li>
            </ul>
          </div>
          <div class="card">
            <h3>Peace of mind</h3>
            <ul class="clean">
              <li><span class="dot"></span><span>Freeze/unfreeze the card if it’s misplaced.</span></li>
              <li><span class="dot"></span><span>Emergency contact and notes (optional).</span></li>
            </ul>
          </div>
        </div>
      </div>

      <!-- RIGHT: Login -->
      <aside>
        <div class="loginCard">
          <h2>Log in</h2>
          <p>Parents only. Use the email you registered with.</p>
          <form id="parentLoginForm" novalidate>
            <input type="email" id="email" placeholder="Email" autocomplete="email" required />
            <input type="password" id="password" placeholder="Password" autocomplete="current-password" required />
            <button type="submit" id="loginBtn">Sign in</button>
            <div class="help">
              <a href="/password.html?mode=forgot">Forgot password?</a>
              <a href="/contact.html">Need help?</a>
            </div>
            <div id="loginMsg" class="msg"></div>
            <div class="tip">By signing in you agree to BOOP’s Terms and Privacy Policy.</div>
          </form>
        </div>
      </aside>
    </section>
  </main>

  <script>
    (function(){
      const REDIRECT_AFTER_LOGIN = "/parent/index.html"; // change if needed

      const form = document.getElementById("parentLoginForm");
      const emailEl = document.getElementById("email");
      const pwEl = document.getElementById("password");
      const btn = document.getElementById("loginBtn");
      const msg = document.getElementById("loginMsg");

      function showMsg(text, type="error"){
        msg.textContent = text;
        msg.className = "msg " + (type === "ok" ? "ok" : "error");
        msg.style.display = "block";
      }

      form.addEventListener("submit", async (e)=>{
        e.preventDefault();
        msg.style.display = "none";
        btn.disabled = true;

        const email = emailEl.value.trim();
        const password = pwEl.value;

        if(!email || !password){
          showMsg("Please enter your email and password.");
          btn.disabled = false;
          return;
        }

        try{
          const res = await fetch("/auth/login", {
            method:"POST",
            headers:{ "Content-Type":"application/json" },
            body: JSON.stringify({ email, password })
          });

          const data = await res.json().catch(()=> ({}));

          if(!res.ok){
            showMsg(data.message || "Login failed. Please check your credentials.");
            btn.disabled = false;
            return;
          }

          const { token, user } = data;

          // Only allow parent role
          if((user?.role || "").toLowerCase() !== "parent"){
            showMsg("This portal is for parents only. Please use the correct account.");
            btn.disabled = false;
            return;
          }

          // Persist session
          localStorage.setItem("boop_jwt", token);
          localStorage.setItem("boopUser", JSON.stringify(user));

          // (Optional) record session server-side, if you use /api/sessions
          try{
            // decode exp for expires_at (non-critical if it fails)
            const payload = JSON.parse(atob(token.split(".")[1] || ""));
            const expiresAt = payload?.exp ? new Date(payload.exp * 1000).toISOString() : null;

            await fetch("/api/sessions", {
              method:"POST",
              headers:{
                "Content-Type":"application/json",
                "Authorization": `Bearer ${token}`
              },
              body: JSON.stringify({
                email: user.email,
                user_id: user.id,
                jwt_token: token,
                expires_at: expiresAt,
                status: "online"
              })
            }).catch(()=>{});
          } catch(_) {}

          // Go to parent dashboard
          window.location.href = REDIRECT_AFTER_LOGIN;

        }catch(err){
          showMsg("Network error. Please try again.");
          console.error(err);
          btn.disabled = false;
        }
      });
    })();
  </script>
</body>
</html>
