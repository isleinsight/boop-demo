<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Government Portal â€” BOOP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root { --ink:#0f172a; --muted:#6b7280; --brand:#2f80ed; --bg:#f5f8fb; --card:#fff; --danger:#b91c1c; --ok:#0f766e; }
    * { box-sizing: border-box }
    body { margin:0; font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--ink) }
    .wrap { max-width: 960px; margin: 48px auto; padding: 0 20px }
    .header { text-align:center; margin-bottom: 24px }
    .header img { height: 40px; display:block; margin: 0 auto 12px }
    h1 { margin:0; font-size:1.6rem }
    .card { background:var(--card); border:1px solid #e6ebf1; border-radius:12px; box-shadow:0 6px 20px rgba(0,0,0,.06) }
    .tabs { display:flex; border-bottom:1px solid #e6ebf1 }
    .tab { flex:1; text-align:center; padding:14px 10px; cursor:pointer; user-select:none; font-weight:600; color:#334155 }
    .tab.active { color:var(--brand); border-bottom:3px solid var(--brand) }
    .panel { display:none; padding:22px; }
    .panel.active { display:block }
    label { display:block; font-size:.92rem; margin:12px 0 6px; color:#0f172a }
    input { width:100%; padding:12px 14px; border:1px solid #d1d9e6; border-radius:8px; font-size:1rem; }
    input:focus { outline: none; border-color: var(--brand) }
    .row { display:flex; gap:14px; align-items:center; justify-content:space-between; margin-top: 16px; }
    .btn { appearance:none; border:0; background:var(--brand); color:#fff; padding:12px 16px; border-radius:10px; font-weight:600; cursor:pointer; width:100% }
    .btn:disabled { opacity:.6; cursor:not-allowed }
    .status { min-height: 22px; margin-top:10px; font-size:.92rem }
    .status.error { color: var(--danger) }
    .status.ok { color: var(--ok) }
    .helper { font-size:.9rem; color:var(--muted); margin-top:10px; text-align:center }
    .links { text-align:center; margin-top:8px }
    .links a { color: var(--brand); text-decoration: none }
    .links a:hover { text-decoration: underline }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <!-- Optional logo (served from /public/assets/Boop-Logo.png) -->
      <img src="/assets/Boop-Logo.png" alt="BOOP" />
      <h1>Government Portal</h1>
      <div class="helper">Choose the correct area and sign in.</div>
    </div>

    <div class="card">
      <!-- Tabs -->
      <div class="tabs">
        <div class="tab active" data-target="admin">Admin</div>
        <div class="tab" data-target="accounts">Accounts</div>
      </div>

      <!-- Admin form -->
      <div class="panel active" id="panel-admin">
        <form id="form-admin" novalidate>
          <label for="email-admin">Email</label>
          <input id="email-admin" type="email" autocomplete="username" required />

          <label for="password-admin">Password</label>
          <input id="password-admin" type="password" autocomplete="current-password" required />

          <div class="row">
            <button class="btn" type="submit" id="btn-admin">Sign in to Admin</button>
          </div>
          <div class="status" id="status-admin"></div>
          <div class="links">
            <a href="/password.html?mode=forgot">Forgot password?</a>
          </div>
        </form>
      </div>

      <!-- Accounts form -->
      <div class="panel" id="panel-accounts">
        <form id="form-accounts" novalidate>
          <label for="email-accounts">Email</label>
          <input id="email-accounts" type="email" autocomplete="username" required />

          <label for="password-accounts">Password</label>
          <input id="password-accounts" type="password" autocomplete="current-password" required />

          <div class="row">
            <button class="btn" type="submit" id="btn-accounts">Sign in to Accounts</button>
          </div>
          <div class="status" id="status-accounts"></div>
          <div class="links">
            <a href="/password.html?mode=forgot">Forgot password?</a>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
  (function(){
    // --- Tab switching (shows the correct FORM, not just color) ---
    const tabs = document.querySelectorAll('.tab');
    const panels = {
      admin: document.getElementById('panel-admin'),
      accounts: document.getElementById('panel-accounts')
    };
    tabs.forEach(t => {
      t.addEventListener('click', () => {
        tabs.forEach(x => x.classList.remove('active'));
        t.classList.add('active');
        const target = t.dataset.target; // 'admin' | 'accounts'
        panels.admin.classList.toggle('active', target === 'admin');
        panels.accounts.classList.toggle('active', target === 'accounts');
        // Focus first input of the active panel
        const first = panels[target].querySelector('input[type="email"]');
        if (first) first.focus();
      });
    });

    // --- Common helpers ---
    async function login({email, password}) {
      const res = await fetch('/auth/login', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ email, password })
      });
      const data = await res.json().catch(() => ({}));
      return { ok: res.ok, data };
    }

    function saveSession(token, user){
      localStorage.setItem("boop_jwt", token);
      localStorage.setItem("boopUser", JSON.stringify(user));
    }

    async function recordSession(token, user){
      try {
        // Decode JWT exp
        const payload = JSON.parse(atob(token.split('.')[1] || ''));
        const expiresAt = new Date((payload.exp || 0) * 1000).toISOString();
        const res = await fetch('/api/sessions', {
          method: 'POST',
          headers: {
            'Content-Type':'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            email: user.email,
            user_id: user.id,
            jwt_token: token,
            expires_at: expiresAt,
            status: 'online'
          })
        });
        if (!res.ok) {
          console.warn('Session record failed:', await res.text());
        }
      } catch (e) {
        console.warn('Session record error:', e);
      }
    }

    // --- Admin form logic ---
    const adminForm = document.getElementById('form-admin');
    const adminBtn  = document.getElementById('btn-admin');
    const adminStatus = document.getElementById('status-admin');

    adminForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      adminStatus.className = 'status';
      adminStatus.textContent = '';
      adminBtn.disabled = true;

      const email = document.getElementById('email-admin').value.trim();
      const password = document.getElementById('password-admin').value;

      const { ok, data } = await login({email, password});
      adminBtn.disabled = false;

      if (!ok) {
        adminStatus.classList.add('error');
        adminStatus.textContent = data.message || 'Login failed.';
        return;
      }

      const { token, user } = data;
      // Allowed admin types:
      const allowed = ['super_admin','admin','support'];
      if (!(user && allowed.includes(user.type))) {
        adminStatus.classList.add('error');
        adminStatus.textContent = 'Access denied. This area is for Admin roles only.';
        return;
      }

      saveSession(token, user);
      recordSession(token, user);
      window.location.href = '/admin/index.html';
    });

    // --- Accounts form logic ---
    const accForm = document.getElementById('form-accounts');
    const accBtn  = document.getElementById('btn-accounts');
    const accStatus = document.getElementById('status-accounts');

    accForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      accStatus.className = 'status';
      accStatus.textContent = '';
      accBtn.disabled = true;

      const email = document.getElementById('email-accounts').value.trim();
      const password = document.getElementById('password-accounts').value;

      const { ok, data } = await login({email, password});
      accBtn.disabled = false;

      if (!ok) {
        accStatus.classList.add('error');
        accStatus.textContent = data.message || 'Login failed.';
        return;
      }

      const { token, user } = data;
      // Allowed accounts types (no support here)
      const allowed = ['accountant','treasury'];
      if (!(user && allowed.includes(user.type))) {
        accStatus.classList.add('error');
        accStatus.textContent = 'Access denied. This area is for Accounts roles only.';
        return;
      }

      saveSession(token, user);
      recordSession(token, user);
      window.location.href = '/accounts/index.html';
    });
  })();
  </script>
</body>
</html>
