<script>
  // Fill hero from window.__vendorDisplay if auth script ran after DOMContentLoaded
  document.addEventListener("DOMContentLoaded", () => {
    const title = document.getElementById("welcomeTitle");
    const display = (window.__vendorDisplay || "Vendor").trim();
    title.textContent = `${display} Vendor Portal`;
  });

  (async function init(){
    const token = localStorage.getItem("boop_jwt");
    const setText = (id,v) => { const el=document.getElementById(id); if (el) el.textContent = v; };
    const fmt = (cents) => `$${(Number(cents||0)/100).toFixed(2)}`;

    // Balance
    try {
      let bal = null;
      const r = await fetch("/api/wallets/mine", { headers:{ Authorization:`Bearer ${token}` }});
      if (r.ok) { const j = await r.json(); bal = j?.balance_cents; }
      if (bal != null) setText("balanceValue", fmt(bal));
    } catch {}

    // Today's Sales
    try {
      const r = await fetch("/api/sales/today", { headers:{ Authorization:`Bearer ${token}` }});
      if (r.ok) {
        const j = await r.json();
        setText("todaysSales", fmt(j.total_cents || 0));
      } else {
        setText("todaysSales", "—");
      }
    } catch {
      setText("todaysSales", "—");
    }

    // Pending Payouts
    try {
      const r = await fetch("/api/payouts/pending", { headers:{ Authorization:`Bearer ${token}` }});
      if (r.ok) {
        const j = await r.json(); // { pending_count, pending_total_cents }
        const count = Number(j.pending_count || 0);
        const total = fmt(j.pending_total_cents || 0);
        setText("pendingPayouts", count > 0 ? `${count} pending • ${total}` : "None");
      } else {
        setText("pendingPayouts", "—");
      }
    } catch {
      setText("pendingPayouts", "—");
    }

    // Recent activity (last 30 days)
    try{
      const qs = new URLSearchParams({
        start: new Date(Date.now()-30*864e5).toISOString().slice(0,10),
        end: new Date().toISOString().slice(0,10),
        limit:"50", offset:"0"
      }).toString();
      const r = await fetch(`/api/vendor/transactions/report?${qs}`, { headers:{ Authorization:`Bearer ${token}` }});
      const j = await r.json();
      const rows = (j && j.transactions) || [];
      renderActivity(rows.slice(0,10));
    }catch{ renderActivity([]); }

    // Recent payouts (keep using transfers list)
    try{
      const r = await fetch(`/api/transfers/mine?limit=10&offset=0`, { headers:{ Authorization:`Bearer ${token}` }});
      const j = await r.json();
      const rows = Array.isArray(j?.transfers) ? j.transfers : (Array.isArray(j) ? j : []);
      renderPayouts(rows.slice(0,10));
    }catch{ renderPayouts([]); }

    function renderActivity(rows){
      const box = document.getElementById('activityList');
      if (!rows.length){ box.innerHTML = `<div class="empty">No recent activity.</div>`; return; }
      box.innerHTML = rows.map(tx=>{
        const isCredit = (tx.type||'').toLowerCase()==='credit';
        const who = isCredit ? (tx.sender_name || 'Customer') : (tx.recipient_name || 'Counterparty');
        const when = tx.created_at ? new Date(tx.created_at).toLocaleString() : '';
        const initials = (who?.trim?.()[0] || 'U').toUpperCase();
        const amt = (Number(tx.amount_cents||0)/100).toFixed(2);
        return `
          <div class="item">
            <div class="left">
              <div class="avatar">${initials}</div>
              <div>
                <div class="who">${isCredit ? 'Received from' : 'Sent to'} ${who}</div>
                <div class="meta">${when}${tx.note ? ' • '+tx.note : ''}</div>
              </div>
            </div>
            <div class="amt ${isCredit ? 'positive' : 'negative'}">${isCredit?'+':'−'}$${amt}</div>
          </div>`;
      }).join('');
    }

    function renderPayouts(rows){
      const box = document.getElementById('payoutList');
      if (!rows.length){ box.innerHTML = `<div class="empty">No recent payouts.</div>`; return; }
      box.innerHTML = rows.map(t=>{
        const when = t.created_at ? new Date(t.created_at).toLocaleString() : '';
        const dest = (t.bank_name || 'Bank') + (t.last4 ? ` •••• ${t.last4}` : '');
        const initials = (dest?.trim?.()[0] || 'B').toUpperCase();
        const amt = (Number(t.amount_cents||0)/100).toFixed(2);
        const status = (t.status||'submitted').toLowerCase();
        return `
          <div class="item">
            <div class="left">
              <div class="avatar">${initials}</div>
              <div>
                <div class="who">Payout to ${dest}</div>
                <div class="meta">${when} • ${status}</div>
              </div>
            </div>
            <div class="amt negative">−$${amt}</div>
          </div>`;
      }).join('');
    }
  })();

  // Logout → same folder vendor-login.html
  document.getElementById("logoutLink")?.addEventListener("click", async (e) => {
    e.preventDefault();
    try { await fetch("/api/logout", { method:"POST" }); } catch {}
    localStorage.clear();
    location.href = "vendor-login.html";
  });
</script>
