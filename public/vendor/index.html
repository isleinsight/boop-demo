<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Vendor Portal – Payulot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --ink:#1a2b4a; --muted:#6b7280; --stroke:#e6ebf1; --bg:#f5f7fa; --panel:#ffffff;
      --blue:#2f80ed; --blue-dark:#1a5fcc; --nav:#0b1220;
      --green:#16a34a; --red:#dc2626;
    }
    *{ box-sizing:border-box }
    body{ margin:0; font-family:'Poppins',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background:var(--bg); color:var(--ink); }

    /* Top vendor nav (matches other vendor pages) */
    .vendor-nav{ background:var(--nav); color:#fff; position:sticky; top:0; z-index:50; }
    .vendor-nav .nav-container{
      max-width:1100px; margin:0 auto; padding:10px 18px;
      display:flex; align-items:center; justify-content:space-between;
    }
    .vendor-nav .nav-left img{ height:30px; display:block; }
    .vendor-nav .nav-right{ display:flex; align-items:center; gap:16px; }
    .vendor-nav .nav-right a{
      color:#fff; text-decoration:none; font-size:.95rem; line-height:1;
      padding:6px 8px; border-radius:6px; opacity:.95;
    }
    .vendor-nav .nav-right a[aria-current="page"]{ opacity:1; background:rgba(255,255,255,.08); }
    .vendor-nav .nav-right a:hover{ opacity:1; background:rgba(255,255,255,.08); }

    /* Hero */
    .hero{ background:linear-gradient(180deg,#f7fafc,#fff); border-bottom:1px solid var(--stroke); }
    .hero-inner{ max-width:1100px; margin:0 auto; padding:22px 18px 18px; }
    .hero h1{ margin:0 0 6px; font-size:clamp(20px,3vw,28px); font-weight:600; }
    .hero-sub{ margin:0; color:#4b5563; }

    /* Stats */
    .stats{
      max-width:1100px; margin:14px auto 0; padding:0 18px 10px;
      display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:12px;
    }
    .stat{ background:#fff; border:1px solid var(--stroke); border-radius:12px; padding:14px; }
    .stat .label{ color:var(--muted); font-size:.9rem; margin:0 0 6px; }
    .stat .value{ font-size:1.25rem; font-weight:600; }

    /* Tiles */
    .tiles{
      max-width:1100px; margin:12px auto 40px; padding:0 18px;
      display:grid; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); gap:14px;
    }
    .tile{
      display:flex; gap:12px; align-items:center; padding:14px;
      border:1px solid var(--stroke); background:#fff; border-radius:12px; text-decoration:none; color:var(--ink);
      box-shadow:0 6px 16px rgba(0,0,0,.06); transition:transform .15s ease, border-color .15s ease;
    }
    .tile:hover{ border-color:#d7deea; transform:translateY(-1px); }
    .tile .icon{ width:28px; height:28px; flex:0 0 28px; }
    .tile .title{ font-weight:600; font-size:.98rem; }
    .tile .sub{ color:var(--muted); font-size:.9rem; }

    /* Lists */
    .panel{
      max-width:1100px; margin:0 auto 36px; padding:0 18px;
      display:grid; grid-template-columns: 1fr 1fr; gap:14px;
    }
    .card{ background:var(--panel); border:1px solid var(--stroke); border-radius:12px; padding:16px; }
    .card h2{ margin:0 0 10px; font-size:1.06rem; }
    .list{ display:grid; gap:10px; }
    .item{ background:#fff; border:1px solid var(--stroke); border-radius:10px; padding:10px 12px; display:flex; justify-content:space-between; align-items:center; }
    .item .left{ display:flex; gap:10px; align-items:center; }
    .avatar{ width:36px; height:36px; border-radius:50%; background:#e2e8f0; display:flex; align-items:center; justify-content:center; font-weight:700; color:#334155; }
    .who{ font-weight:600; }
    .meta{ font-size:.85rem; color:#94a3b8; }
    .amt{ font-weight:700; white-space:nowrap; }
    .amt.positive{ color:var(--green); }
    .amt.negative{ color:#dc2626; }
    .empty{ color:#6b7280; border:1px dashed var(--stroke); border-radius:10px; padding:12px; text-align:center; }

    /* Footer */
    footer{ border-top:1px solid var(--stroke); background:#fff; }
    .footer-inner{ max-width:1100px; margin:0 auto; padding:16px 18px; display:flex; gap:14px; align-items:center; justify-content:space-between; color:#6b7280; font-size:.9rem; }
    .footer-links a{ color:#6b7280; text-decoration:none; margin-left:12px; }
    .footer-links a:hover{ text-decoration:underline; }

    @media (max-width:900px){ .panel{ grid-template-columns:1fr; } }
  </style>
</head>
<body>
  <!-- Vendor auth gate -->
  <script>
    (async () => {
      try {
        const token = localStorage.getItem("boop_jwt");
        if (!token) throw new Error("No token");
        let me = JSON.parse(localStorage.getItem("boopUser") || "null");
        if (!me) {
          const r = await fetch("/api/me", { headers:{ Authorization:`Bearer ${token}` }});
          if (!r.ok) throw new Error("Unauthorized");
          me = await r.json(); localStorage.setItem("boopUser", JSON.stringify(me));
        }
        if ((me.role||"").toLowerCase() !== "vendor") throw new Error("Not a vendor");
      } catch {
        localStorage.clear(); location.href = "vendor-login.html";
      }
    })();
  </script>

  <script>
  // If this device is logged in as cashier (boopStaff set), bounce to the cashier session page
  try {
    const staff = JSON.parse(localStorage.getItem('boopStaff') || 'null');
    if (staff) {
      // optional: show a quick message first
      // alert('Cashier accounts cannot access vendor owner pages.');
      location.replace('/vendor/sessions.html');
    }
  } catch {}
</script>
  
  <!-- Shared vendor helpers (apiFetch/apiJSON + token renew) -->
  <script src="vendor-common.js"></script>

  <!-- Keep-alive (captures x-renew-jwt via apiFetch) -->
  <script>
    setInterval(() => { apiFetch('/api/vendor/ping').catch(()=>{}); }, 10 * 60 * 1000);
  </script>

  <!-- NAV -->
  <nav class="vendor-nav">
    <div class="nav-container">
      <div class="nav-left">
        <a href="index.html" aria-label="Payulot home">
          <img src="../assets/logo-white.png" alt="Payulot Logo" />
        </a>
      </div>
      <div class="nav-right" aria-label="Primary">
        <a href="index.html" aria-current="page">Home</a>
        <a href="transfer.html">Transfer</a>
        <a href="transactions.html">Transactions</a>
        <a href="manage-staff.html">Manage Staff</a>
        <a href="#" id="logoutLink">Log Out</a>
      </div>
    </div>
  </nav>

  <!-- Hero -->
  <section class="hero">
    <div class="hero-inner">
      <h1 id="welcomeTitle">Vendor Portal</h1>
      <p class="hero-sub">Quick actions to move money, manage staff, and review activity.</p>
    </div>
  </section>

  <!-- Stats -->
  <section class="stats">
    <div class="stat">
      <p class="label">Current Balance</p>
      <p class="value" id="balanceValue">—</p>
    </div>
    <div class="stat">
      <p class="label">Today’s Sales</p>
      <p class="value" id="todaysSales">—</p>
    </div>
    <div class="stat">
      <p class="label">Pending Payouts</p>
      <p class="value" id="pendingPayouts">—</p>
    </div>
  </section>

  <!-- Quick actions -->
  <section class="tiles">
    <a class="tile" href="transfer.html">
      <svg class="icon" viewBox="0 0 24 24" fill="none">
        <path d="M17 6H7m10 4l-4-4m4 4l-4 4M7 18h10m-10-4l4 4m-4-4l4-4" stroke="#1f2937" stroke-width="2" stroke-linecap="round"/>
      </svg>
      <span>
        <span class="title">Transfer to Bank</span><br/>
        <span class="sub">Move funds from Payulot to your bank</span>
      </span>
    </a>

    <a class="tile" href="transactions.html">
      <svg class="icon" viewBox="0 0 24 24" fill="none">
        <path d="M3 6h18M3 12h12M3 18h9" stroke="#1f2937" stroke-width="2" stroke-linecap="round"/>
      </svg>
      <span>
        <span class="title">Transactions</span><br/>
        <span class="sub">View recent payments & payouts</span>
      </span>
    </a>

    <!-- Replaced Help & Tips with Manage Staff -->
    <a class="tile" href="manage-staff.html">
      <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
        <path d="M16 11a4 4 0 10-8 0 4 4 0 008 0zm-11 9a7 7 0 0114 0" stroke="#1f2937" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <span>
        <span class="title">Manage Staff</span><br/>
        <span class="sub">Add, edit, or remove cashier logins</span>
      </span>
    </a>
  </section>

  <!-- Activity & payouts -->
  <section class="panel">
    <div class="card">
      <h2>Recent activity</h2>
      <div id="activityList" class="list">
        <div class="empty">Loading…</div>
      </div>
    </div>
    <div class="card">
      <h2>Recent payouts</h2>
      <div id="payoutList" class="list">
        <div class="empty">Loading…</div>
      </div>
    </div>
  </section>

  <footer>
    <div class="footer-inner">
      <div>© 2025 Payulot</div>
      <div class="footer-links">
        <a href="/terms.html" target="_blank" rel="noopener">Terms</a>
        <a href="/privacy.html" target="_blank" rel="noopener">Privacy</a>
      </div>
    </div>
  </footer>

  <script>
    // Paint vendor name if profile already cached
    document.addEventListener("DOMContentLoaded", () => {
      const title = document.getElementById("welcomeTitle");
      const me = JSON.parse(localStorage.getItem('boopUser') || 'null') || {};
      const biz = me.business_name || (me.first_name && me.last_name ? `${me.first_name} ${me.last_name}` : me.email || 'Vendor');
      if (title) title.textContent = `${biz} Vendor Portal`;
      document.title = `${biz} Vendor Portal – Payulot`;
    });

    (async function init(){
      const token = localStorage.getItem("boop_jwt");
      const setText = (id,v) => { const el=document.getElementById(id); if (el) el.textContent = v; };
      const fmt = (cents) => `$${(Number(cents||0)/100).toFixed(2)}`;

      // Balance
      try {
        const r = await apiFetch("/api/wallets/mine");
        if (r.ok) {
          const j = await r.json();
          if (j && typeof j.balance_cents !== "undefined") setText("balanceValue", fmt(j.balance_cents));
        }
      } catch {}

      // Today’s Sales
      try {
        const r = await apiFetch("/api/sales/today");
        if (r.ok) {
          const j = await r.json();
          setText("todaysSales", fmt(j.total_cents || 0));
        } else { setText("todaysSales", "—"); }
      } catch { setText("todaysSales", "—"); }

      // Pending Payouts
      try {
        const r = await apiFetch("/api/payouts/pending");
        if (r.ok) {
          const j = await r.json();
          const count = Number(j.pending_count || 0);
          const total = fmt(j.pending_total_cents || 0);
          setText("pendingPayouts", count > 0 ? `${count} pending • ${total}` : "None");
        } else { setText("pendingPayouts", "—"); }
      } catch { setText("pendingPayouts", "—"); }

      // Recent activity (last 30 days)
      try{
        const qs = new URLSearchParams({
          start: new Date(Date.now()-30*864e5).toISOString().slice(0,10),
          end: new Date().toISOString().slice(0,10),
          limit:"50", offset:"0"
        }).toString();
        const r = await apiFetch(`/api/vendor/transactions/report?${qs}`);
        const j = await r.json();
        renderActivity((j?.transactions || []).slice(0,10));
      }catch{ renderActivity([]); }

      // Recent payouts
      try{
        const r = await apiFetch(`/api/transfers/mine?limit=10&offset=0`);
        const j = await r.json();
        const rows = Array.isArray(j?.transfers) ? j.transfers : (Array.isArray(j) ? j : []);
        renderPayouts(rows.slice(0,10));
      }catch{ renderPayouts([]); }

      function renderActivity(rows){
        const box = document.getElementById('activityList');
        if (!box) return;
        if (!rows.length){ box.innerHTML = `<div class="empty">No recent activity.</div>`; return; }
        box.innerHTML = rows.map(tx=>{
          const isCredit = (tx.type||'').toLowerCase()==='credit';
          const who = isCredit ? (tx.sender_name || 'Customer') : (tx.recipient_name || 'Counterparty');
          const when = tx.created_at ? new Date(tx.created_at).toLocaleString() : '';
          const initials = (who?.trim?.()[0] || 'U').toUpperCase();
          const amt = (Number(tx.amount_cents||0)/100).toFixed(2);
          return `
            <div class="item">
              <div class="left">
                <div class="avatar">${initials}</div>
                <div>
                  <div class="who">${isCredit ? 'Received from' : 'Sent to'} ${who}</div>
                  <div class="meta">${when}${tx.note ? ' • '+tx.note : ''}</div>
                </div>
              </div>
              <div class="amt ${isCredit ? 'positive' : 'negative'}">${isCredit?'+':'−'}$${amt}</div>
            </div>`;
        }).join('');
      }

      function renderPayouts(rows){
        const box = document.getElementById('payoutList');
        if (!box) return;
        if (!rows.length){ box.innerHTML = `<div class="empty">No recent payouts.</div>`; return; }
        box.innerHTML = rows.map(t=>{
          const when = t.created_at ? new Date(t.created_at).toLocaleString() : '';
          const dest = (t.bank_name || 'Bank') + (t.last4 ? ` •••• ${t.last4}` : '');
          const initials = (dest?.trim?.()[0] || 'B').toUpperCase();
          const amt = (Number(t.amount_cents||0)/100).toFixed(2);
          const status = (t.status||'submitted').toLowerCase();
          return `
            <div class="item">
              <div class="left">
                <div class="avatar">${initials}</div>
                <div>
                  <div class="who">Payout to ${dest}</div>
                  <div class="meta">${when} • ${status}</div>
                </div>
              </div>
              <div class="amt negative">−$${amt}</div>
            </div>`;
        }).join('');
      }
    })();

    // Logout
    document.getElementById("logoutLink")?.addEventListener("click", async (e) => {
      e.preventDefault();
      try { await apiFetch("/api/logout", { method:"POST" }); } catch {}
      localStorage.clear();
      location.href = "vendor-login.html";
    });
  </script>
</body>
</html>
