<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Passport Pay – Vendor | BOOP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="../../assets/styles.css" />
  <style>
    :root { --ink:#1a2b4a; --muted:#6b7280; --stroke:#e6ebf1; }
    body { font-family:'Poppins',sans-serif; background:#f5f7fa; color:var(--ink); margin:0; }

    /* Minimal header (logo only, no nav) */
    .nav { background:#0b1220; color:#fff; }
    .nav-inner { max-width:900px; margin:0 auto; padding:12px 18px; display:flex; align-items:center; }
    .nav img { height:32px; display:block; }

    .wrap { max-width:660px; margin:26px auto 34px; background:#fff; padding:22px 18px; border:1px solid var(--stroke); border-radius:12px; box-shadow:0 6px 16px rgba(0,0,0,.06); }
    h1 { margin:6px 0 18px; font-size:1.4rem; font-weight:600; }
    .muted { color:var(--muted); font-size:0.95rem; }

    .grid { display:grid; grid-template-columns:1fr; gap:12px; margin-top:10px; }
    label { font-size:0.9rem; font-weight:600; color:#1f2a44; }
    input, textarea, select, button {
      width:100%; padding:10px 12px; border:1px solid #d1d9e6; border-radius:8px; font-size:1rem; box-sizing:border-box; background:#fff;
    }
    textarea { resize:vertical; min-height:80px; }
    .actions { display:flex; gap:10px; margin-top:14px; }
    .btn { background:#2f80ed; color:#fff; border:none; cursor:pointer; font-weight:600; }
    .btn:hover { background:#1c6fd8; }
    .btn.secondary { background:#6b7280; }
    .btn.secondary:hover { background:#4b5563; }
    .status { margin-top:12px; font-weight:600; }
    .status.ok { color:#065f46; background:#ecfdf5; border:1px solid #34d399; padding:10px; border-radius:8px; }
    .status.err { color:#991b1b; background:#fef2f2; border:1px solid #fecaca; padding:10px; border-radius:8px; }
    .dim { opacity:.5; pointer-events:none; }

    /* Footer */
    footer { border-top:1px solid var(--stroke); padding:16px 18px; color:var(--muted); font-size:0.9rem; }
    .footer-inner { max-width:900px; margin:0 auto; display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
    .footer-links a { color:#2f80ed; text-decoration:none; margin-right:12px; }
    .footer-links a:hover { text-decoration:underline; }
  </style>
</head>
<body>
  <!-- Auth guard: vendor only -->
  <script>
    (async () => {
      try {
        const token = localStorage.getItem("boop_jwt");
        if (!token) throw new Error("No token");
        const res = await fetch("/api/me", { headers: { Authorization: `Bearer ${token}` }});
        if (!res.ok) throw new Error("Unauthorized");
        const me = await res.json();
        if (!me || me.role !== "vendor") throw new Error("Not a vendor");
        localStorage.setItem("boopUser", JSON.stringify(me));
      } catch (err) {
        localStorage.clear();
        location.href = "../../login.html";
      }
    })();
  </script>

  <!-- Header (logo only) -->
  <div class="nav">
    <div class="nav-inner">
      <img src="../../assets/Boop-Logo.png" alt="BOOP Logo" />
    </div>
  </div>

  <!-- Main -->
  <div class="wrap" id="card">
    <h1>Passport Pay</h1>
    <p class="muted">
      Scan brings you here with a passport ID. Enter the total and submit. This page locks after a successful charge.
    </p>

    <div class="grid" id="formFields">
      <div>
        <label for="passportId">Passport ID</label>
        <input id="passportId" type="text" placeholder="e.g. PRT-123456" autocomplete="off" />
      </div>
      <div>
        <label for="amount">Amount (BMD)</label>
        <input id="amount" type="number" step="0.01" min="0.01" placeholder="0.00" />
      </div>
      <div>
        <label for="note">Note (optional)</label>
        <textarea id="note" placeholder="Short description"></textarea>
      </div>
    </div>

    <div class="actions">
      <button id="submitBtn" class="btn">Charge</button>
      <button id="resetBtn" class="btn secondary" style="display:none;">New Charge</button>
    </div>

    <div id="status" class="status"></div>
  </div>

  <!-- Footer -->
  <footer>
    <div class="footer-inner">
      <div>© 2025 BOOP. All rights reserved.</div>
      <div class="footer-links">
        <a href="/legal/terms.html" target="_blank" rel="noopener">Terms of Service</a>
        <a href="/legal/privacy.html" target="_blank" rel="noopener">Privacy Policy</a>
      </div>
    </div>
  </footer>

  <script>
    const q = new URLSearchParams(location.search);
    const preset = q.get("passport") || q.get("pid") || "";

    const passportEl = document.getElementById("passportId");
    const amountEl   = document.getElementById("amount");
    const noteEl     = document.getElementById("note");
    const submitBtn  = document.getElementById("submitBtn");
    const resetBtn   = document.getElementById("resetBtn");
    const statusEl   = document.getElementById("status");
    const card       = document.getElementById("card");
    const fieldsWrap = document.getElementById("formFields");

    if (preset) {
      passportEl.value = preset;
      passportEl.readOnly = true; // came from NFC/URL → lock it
    }

    function showStatus(msg, kind) {
      statusEl.textContent = msg;
      statusEl.className = "status " + (kind === "ok" ? "ok" : kind === "err" ? "err" : "");
    }
    function lockUI() {
      fieldsWrap.classList.add("dim");
      submitBtn.disabled = true;
      submitBtn.classList.add("dim");
      resetBtn.style.display = "inline-block";
    }
    function unlockUI() {
      fieldsWrap.classList.remove("dim");
      submitBtn.disabled = false;
      submitBtn.classList.remove("dim");
      resetBtn.style.display = "none";
    }

    async function submitCharge() {
      const token = localStorage.getItem("boop_jwt");
      const passport_id = passportEl.value.trim();
      const amt = parseFloat(amountEl.value);

      if (!passport_id) { showStatus("Please provide a passport ID.", "err"); return; }
      if (!(amt > 0))   { showStatus("Please enter a valid amount.", "err"); return; }

      submitBtn.disabled = true;
      showStatus("Submitting charge…");

      try {
        // Adjust this path if your backend differs:
        const res = await fetch("/api/vendor/passport-pay/charge", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`
          },
          body: JSON.stringify({
            passport_id,
            amount: amt,
            note: noteEl.value.trim()
          })
        });

        const payload = await res.json().catch(() => ({}));

        if (!res.ok) {
          const msg = payload?.message || payload?.error || `Charge failed (HTTP ${res.status})`;
          showStatus("❌ " + msg, "err");
          submitBtn.disabled = false;
          return;
        }

        // Success → lock page
        const disp = (payload.amount_cents != null) ? (payload.amount_cents/100).toFixed(2) : amt.toFixed(2);
        showStatus(`✅ Charged BMD $${disp} to passport ${passport_id}.`, "ok");
        lockUI();
      } catch (err) {
        showStatus("❌ " + (err.message || "Network error"), "err");
        submitBtn.disabled = false;
      }
    }

    submitBtn.addEventListener("click", submitCharge);
    amountEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter") submitCharge();
    });

    resetBtn.addEventListener("click", () => {
      // Fresh flow — easiest/safest is a full reload (clears any locked readOnly)
      location.href = location.pathname; // keep on /vendor/passport-pay/
    });
  </script>
</body>
</html>
