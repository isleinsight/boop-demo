<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Manage Staff — Payulot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --ink:#0b1220; --muted:#6b7280; --stroke:#e5e7eb; --bg:#f5f8fb; --card:#ffffff;
      --blue:#2f80ed; --blue-dark:#1a6fe0; --ok:#10b981; --warn:#f59e0b; --danger:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:var(--bg);color:#1f2937;font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Arial}
    a{color:var(--blue);text-decoration:none}
    img{max-width:100%;display:block}

    /* Header */
    .site-head{background:#0b1220}
    .site-head__inner{max-width:1120px;margin:0 auto;padding:12px 16px;display:flex;align-items:center;justify-content:space-between}
    .brand{display:flex;align-items:center;gap:10px}
    .brand img{height:28px}
    .logout{color:#cfe0ff}

    /* Subnav */
    .subbar{background:#eef2f7;border-bottom:1px solid var(--stroke)}
    .subbar__inner{max-width:1120px;margin:0 auto;padding:10px 16px;display:flex;align-items:center;justify-content:space-between;gap:10px}
    .subnav-left{display:flex;gap:12px;flex-wrap:wrap}
    .subnav-left a{color:#111827;font-weight:600;padding:6px 10px;border-radius:8px}
    .subnav-left a.active{background:#e5e7eb}

    /* Main */
    .wrap{max-width:1120px;margin:0 auto;padding:16px}
    .grid{display:grid;grid-template-columns:2fr 1fr;gap:16px;align-items:start}
    @media (max-width:900px){ .grid{grid-template-columns:1fr} }

    .card{background:var(--card);border:1px solid var(--stroke);border-radius:14px;box-shadow:0 8px 20px rgba(16,24,40,.06)}
    .card__head{padding:12px 14px;border-bottom:1px solid var(--stroke);display:flex;align-items:center;justify-content:space-between;gap:10px}
    .card__body{padding:14px}

    .btn{background:var(--blue);color:#fff;border:0;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer}
    .btn:hover{background:var(--blue-dark)}
    .btn.light{background:#fff;color:var(--blue);border:1px solid var(--stroke)}
    .btn.danger{background:var(--danger)}
    .btn.warn{background:var(--warn);color:#111827}

    .toolbar{display:flex;gap:8px;flex-wrap:wrap}
    .search{display:flex;gap:8px;flex-wrap:wrap}
    .input{padding:10px 12px;border:1px solid var(--stroke);border-radius:10px;background:#fff;min-width:240px}

    table{width:100%;border-collapse:separate;border-spacing:0}
    th,td{padding:10px 12px;border-bottom:1px solid var(--stroke);vertical-align:middle}
    th{text-align:left;color:#374151;font-weight:600}
    td .tags{display:flex;gap:6px;flex-wrap:wrap}
    .pill{font-size:.8rem;background:#eef2ff;color:#374151;border-radius:999px;padding:3px 8px;border:1px solid #dbeafe}
    .pill.gray{background:#f3f4f6;border-color:#e5e7eb;color:#374151}
    .actions{display:flex;gap:6px;flex-wrap:wrap}

    .empty{color:var(--muted);text-align:center;padding:18px 0}

    /* Modal */
    .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.45);z-index:50;padding:16px}
    .modal__card{width:100%;max-width:560px;background:#fff;border-radius:14px;border:1px solid var(--stroke);box-shadow:0 20px 50px rgba(0,0,0,.15);overflow:hidden}
    .modal__head,.modal__foot{padding:12px 14px;border-bottom:1px solid var(--stroke);display:flex;align-items:center;justify-content:space-between}
    .modal__foot{border-top:1px solid var(--stroke);border-bottom:none}
    .modal__body{padding:14px;display:grid;gap:12px}
    label{display:block;font-weight:600;margin-bottom:6px}
    .note{font-size:.9rem;color:var(--muted)}
    .msg{font-size:.92rem;margin-top:6px;display:none}
    .msg.ok{color:var(--ok)} .msg.err{color:var(--danger)}
  </style>
</head>
<body>
  <!-- Header -->
  <header class="site-head">
    <div class="site-head__inner">
      <a class="brand" href="../index.html" aria-label="Payulot home">
        <img src="../assets/logo-white.png" alt="Payulot" />
      </a>
      <a href="#" id="logoutLink" class="logout">Log out</a>
    </div>
  </header>

  <!-- Subbar -->
  <div class="subbar">
    <div class="subbar__inner">
      <nav class="subnav-left" aria-label="Vendor navigation">
        <a href="index.html">Home</a>
        <a href="transfer.html">Transfer</a>
        <a href="transactions.html">Transactions</a>
        <a href="help.html">Help</a>
        <a class="active" aria-current="page" href="manage-staff.html">Manage Staff</a>
      </nav>
    </div>
  </div>

  <!-- Content -->
  <main class="wrap">
    <section class="grid">
      <div class="card">
        <div class="card__head">
          <strong>Staff Accounts</strong>
          <div class="toolbar">
            <input id="q" class="input" type="search" placeholder="Search name or email…" />
            <button id="btnAdd" class="btn" type="button">Add Staff</button>
          </div>
        </div>
        <div class="card__body">
          <div id="tableWrap">
            <table id="staffTable" aria-describedby="staffDesc">
              <thead>
                <tr>
                  <th style="width:34%">Name</th>
                  <th style="width:34%">Email</th>
                  <th style="width:14%">Status</th>
                  <th style="width:18%">Actions</th>
                </tr>
              </thead>
              <tbody id="tbody">
                <tr><td colspan="4" class="empty">Loading…</td></tr>
              </tbody>
            </table>
            <p id="staffDesc" class="note">Staff log in with their own credentials. All activity is narrowed to your vendor account.</p>
          </div>
        </div>
      </div>

      <aside class="card">
        <div class="card__head"><strong>Tips</strong></div>
        <div class="card__body">
          <ul style="margin:0 0 10px 16px;line-height:1.5">
            <li>Create a staff login per cashier/terminal.</li>
            <li>“Disable” locks access without deleting history.</li>
            <li>“Reset password” creates a one-time temporary password.</li>
          </ul>
          <div id="flash" class="msg" style="display:none"></div>
        </div>
      </aside>
    </section>
  </main>

  <!-- Add/Edit Modal -->
  <div id="editModal" class="modal" aria-hidden="true">
    <div class="modal__card" role="dialog" aria-modal="true" aria-labelledby="editTitle">
      <div class="modal__head">
        <strong id="editTitle">Add Staff</strong>
        <button class="btn light" id="closeEdit">Close</button>
      </div>
      <div class="modal__body">
        <div>
          <label for="mName">Display name</label>
          <input id="mName" class="input" type="text" placeholder="e.g., Suzy Q" />
        </div>
        <div>
          <label for="mEmail">Login email (username)</label>
          <input id="mEmail" class="input" type="email" placeholder="user@example.com" />
        </div>
        <div id="tempPwWrap" style="display:none">
          <label>Temporary password</label>
          <div id="tempPw" class="note" style="padding:10px 12px;border:1px dashed var(--stroke);border-radius:10px;background:#f8fafc">—</div>
          <div class="note">Show this to the staff member now. It will not be shown again.</div>
        </div>
        <div id="editMsg" class="msg"></div>
      </div>
      <div class="modal__foot">
        <button id="saveEdit" class="btn">Save</button>
      </div>
    </div>
  </div>

  <!-- Confirm Delete Modal -->
  <div id="delModal" class="modal" aria-hidden="true">
    <div class="modal__card" role="dialog" aria-modal="true" aria-labelledby="delTitle">
      <div class="modal__head">
        <strong id="delTitle">Delete Staff</strong>
        <button class="btn light" id="closeDel">Close</button>
      </div>
      <div class="modal__body">
        <p>Type <strong>DELETE</strong> to confirm removing this staff account. This cannot be undone.</p>
        <input id="delConfirm" class="input" type="text" placeholder="DELETE" />
        <div id="delMsg" class="msg"></div>
      </div>
      <div class="modal__foot">
        <button id="confirmDel" class="btn danger">Delete</button>
      </div>
    </div>
  </div>

  <script>
    (function(){
      // ---------- auth guard ----------
      const token = localStorage.getItem('boop_jwt');
      if (!token) { location.href = 'vendor-login.html'; return; }

      // ---------- helpers ----------
      const $ = (id)=>document.getElementById(id);
      const flash = (msg, ok=true)=>{
        const el = $('flash'); if(!el) return;
        el.textContent = msg; el.className = 'msg ' + (ok ? 'ok':'err'); el.style.display='block';
        setTimeout(()=>{ el.style.display='none'; }, 4000);
      };

      const api = {
        async list(){
          const r = await fetch('/api/vendor/staff', { headers:{ Authorization:`Bearer ${token}` }});
          const j = await r.json(); if(!r.ok) throw new Error(j.message||'Failed to load');
          return Array.isArray(j) ? j : (j.staff || []);
        },
        async create({display_name,email}){
          const r = await fetch('/api/vendor/staff', {
            method:'POST', headers:{ 'Content-Type':'application/json', Authorization:`Bearer ${token}` },
            body: JSON.stringify({ display_name, email })
          });
          const j = await r.json(); if(!r.ok) throw new Error(j.message||'Create failed');
          return j; // expect { staff: {...}, temp_password: '...' } or similar
        },
        async update(id, {display_name,email}){
          const r = await fetch(`/api/vendor/staff/${id}`, {
            method:'PATCH', headers:{ 'Content-Type':'application/json', Authorization:`Bearer ${token}` },
            body: JSON.stringify({ display_name, email })
          });
          const j = await r.json().catch(()=>({}));
          if(!r.ok) throw new Error(j.message||'Update failed');
          return true;
        },
        async del(id){
          const r = await fetch(`/api/vendor/staff/${id}`, {
            method:'DELETE', headers:{ Authorization:`Bearer ${token}` }
          });
          const j = await r.json().catch(()=>({}));
          if(!r.ok) throw new Error(j.message||'Delete failed');
          return true;
        },
        async resetPw(id){
          const r = await fetch(`/api/vendor/staff/${id}/reset-password`, {
            method:'POST', headers:{ Authorization:`Bearer ${token}` }
          });
          const j = await r.json(); if(!r.ok) throw new Error(j.message||'Reset failed');
          return j; // { temp_password: '...' }
        },
        async disable(id){
          const r = await fetch(`/api/vendor/staff/${id}/disable`, { method:'POST', headers:{ Authorization:`Bearer ${token}` }});
          if(!r.ok) throw new Error('Disable failed');
          return true;
        },
        async enable(id){
          const r = await fetch(`/api/vendor/staff/${id}/enable`, { method:'POST', headers:{ Authorization:`Bearer ${token}` }});
          if(!r.ok) throw new Error('Enable failed');
          return true;
        },
        async revoke(id){
          const r = await fetch(`/api/vendor/staff/${id}/revoke-sessions`, { method:'POST', headers:{ Authorization:`Bearer ${token}` }});
          if(!r.ok) throw new Error('Revoke failed');
          return true;
        }
      };

      // ---------- state ----------
      let rows = [];
      let filterQ = '';
      let editing = null;   // { id, display_name, email }
      let deleting = null;  // { id, display_name }

      // ---------- UI refs ----------
      const tbody = $('tbody');
      const q = $('q');

      // ---------- render ----------
      function render(){
        const ql = filterQ.trim().toLowerCase();
        const list = rows.filter(r=>{
          if(!ql) return true;
          return (String(r.display_name||'').toLowerCase().includes(ql) ||
                  String(r.email||'').toLowerCase().includes(ql));
        });

        if(!list.length){
          tbody.innerHTML = `<tr><td colspan="4" class="empty">No staff yet.</td></tr>`;
          return;
        }

        tbody.innerHTML = list.map(s=>{
          const statusPill = s.disabled
            ? `<span class="pill gray">Disabled</span>`
            : `<span class="pill">Active</span>`;
          return `
            <tr data-id="${s.id}">
              <td>${escapeHtml(s.display_name||'—')}</td>
              <td>${escapeHtml(s.email||'')}</td>
              <td><div class="tags">${statusPill}</div></td>
              <td>
                <div class="actions">
                  <button class="btn light act-edit" type="button">Edit</button>
                  <button class="btn warn act-reset" type="button">Reset PW</button>
                  ${s.disabled
                    ? `<button class="btn act-enable" type="button">Enable</button>`
                    : `<button class="btn light act-disable" type="button">Disable</button>`}
                  <button class="btn light act-revoke" type="button">Revoke</button>
                  <button class="btn danger act-del" type="button">Delete</button>
                </div>
              </td>
            </tr>
          `;
        }).join('');

        // wire actions
        tbody.querySelectorAll('.act-edit').forEach(btn=>{
          btn.addEventListener('click', onEditClick);
        });
        tbody.querySelectorAll('.act-del').forEach(btn=>{
          btn.addEventListener('click', onDelClick);
        });
        tbody.querySelectorAll('.act-reset').forEach(btn=>{
          btn.addEventListener('click', onResetClick);
        });
        tbody.querySelectorAll('.act-disable').forEach(btn=>{
          btn.addEventListener('click', onDisableClick);
        });
        tbody.querySelectorAll('.act-enable').forEach(btn=>{
          btn.addEventListener('click', onEnableClick);
        });
        tbody.querySelectorAll('.act-revoke').forEach(btn=>{
          btn.addEventListener('click', onRevokeClick);
        });
      }

      function escapeHtml(s){
        return String(s||'').replace(/[&<>"']/g, c => ({
          '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
        }[c]));
      }

      // ---------- actions ----------
      function rowIdFromButton(el){
        const tr = el.closest('tr'); return tr ? tr.getAttribute('data-id') : null;
      }

      async function reload(){
        try{
          rows = await api.list();
          render();
        }catch(e){
          tbody.innerHTML = `<tr><td colspan="4" class="empty">Failed to load staff.</td></tr>`;
          flash(e.message||'Load error', false);
        }
      }

      // Add
      $('btnAdd')?.addEventListener('click', ()=>{
        editing = null;
        $('editTitle').textContent = 'Add Staff';
        $('mName').value = '';
        $('mEmail').value = '';
        $('tempPwWrap').style.display = 'none';
        $('editMsg').style.display = 'none';
        openModal('editModal');
      });

      // Edit click
      function onEditClick(e){
        const id = rowIdFromButton(e.currentTarget); if(!id) return;
        const item = rows.find(r=>String(r.id)===String(id)); if(!item) return;
        editing = { id:item.id, display_name:item.display_name||'', email:item.email||'' };
        $('editTitle').textContent = 'Edit Staff';
        $('mName').value = editing.display_name;
        $('mEmail').value = editing.email;
        $('tempPwWrap').style.display = 'none';
        $('editMsg').style.display = 'none';
        openModal('editModal');
      }

      // Delete click
      function onDelClick(e){
        const id = rowIdFromButton(e.currentTarget); if(!id) return;
        const item = rows.find(r=>String(r.id)===String(id)); if(!item) return;
        deleting = { id:item.id, display_name:item.display_name||item.email||'staff' };
        $('delConfirm').value = '';
        $('delMsg').style.display = 'none';
        openModal('delModal');
      }

      async function onResetClick(e){
        const id = rowIdFromButton(e.currentTarget); if(!id) return;
        try{
          const r = await api.resetPw(id);
          const pw = r.temp_password || r.tempPassword || r.password || '(created)';
          flash(`Temporary password: ${pw}`, true);
        }catch(err){ flash(err.message||'Reset failed', false); }
      }

      async function onDisableClick(e){
        const id = rowIdFromButton(e.currentTarget); if(!id) return;
        try{ await api.disable(id); await reload(); flash('Staff disabled.', true); }
        catch(err){ flash(err.message||'Failed to disable', false); }
      }

      async function onEnableClick(e){
        const id = rowIdFromButton(e.currentTarget); if(!id) return;
        try{ await api.enable(id); await reload(); flash('Staff enabled.', true); }
        catch(err){ flash(err.message||'Failed to enable', false); }
      }

      async function onRevokeClick(e){
        const id = rowIdFromButton(e.currentTarget); if(!id) return;
        try{ await api.revoke(id); flash('Sessions revoked.', true); }
        catch(err){ flash(err.message||'Failed to revoke', false); }
      }

      // Save (Add/Edit)
      $('saveEdit')?.addEventListener('click', async ()=>{
        const name = $('mName').value.trim();
        const email = $('mEmail').value.trim();
        const msg = $('editMsg'); msg.style.display='none';

        if(!email){ msg.textContent='Email is required.'; msg.className='msg err'; msg.style.display='block'; return; }

        try{
          if(editing){
            await api.update(editing.id, { display_name:name, email });
            closeModal('editModal'); flash('Staff updated.', true); await reload();
          }else{
            const res = await api.create({ display_name:name, email });
            const pw = res.temp_password || res.tempPassword || res.password;
            if (pw){
              $('tempPw').textContent = pw;
              $('tempPwWrap').style.display = 'block';
              msg.textContent = 'Share the temporary password with your staff member now.';
              msg.className = 'msg ok'; msg.style.display='block';
            }else{
              closeModal('editModal'); flash('Staff created.', true); await reload();
            }
          }
        }catch(e){
          msg.textContent = e.message || 'Save failed.';
          msg.className = 'msg err'; msg.style.display = 'block';
        }
      });

      // Confirm Delete
      $('confirmDel')?.addEventListener('click', async ()=>{
        const val = $('delConfirm').value.trim();
        const msg = $('delMsg'); msg.style.display='none';
        if(val !== 'DELETE'){ msg.textContent='Type DELETE to confirm.'; msg.className='msg err'; msg.style.display='block'; return; }
        try{
          await api.del(deleting.id);
          closeModal('delModal'); flash('Staff deleted.', true); await reload();
        }catch(e){
          msg.textContent = e.message || 'Delete failed.'; msg.className='msg err'; msg.style.display='block';
        }
      });

      // Search
      q?.addEventListener('input', ()=>{
        filterQ = q.value||''; render();
      });

      // Modals open/close
      function openModal(id){ const m=$(id); if(m){ m.style.display='grid'; m.setAttribute('aria-hidden','false'); } }
      function closeModal(id){ const m=$(id); if(m){ m.style.display='none'; m.setAttribute('aria-hidden','true'); } }
      $('closeEdit')?.addEventListener('click', ()=>closeModal('editModal'));
      $('closeDel')?.addEventListener('click', ()=>closeModal('delModal'));
      $('editModal')?.addEventListener('click', (e)=>{ if(e.target === $('editModal')) closeModal('editModal'); });
      $('delModal')?.addEventListener('click', (e)=>{ if(e.target === $('delModal')) closeModal('delModal'); });

      // Logout
      $('logoutLink')?.addEventListener('click', async (e)=>{
        e.preventDefault();
        try { await fetch('/api/logout', { method:'POST' }); } catch {}
        localStorage.clear(); location.href = 'vendor-login.html';
      });

      // Boot
      reload();
    })();
  </script>
</body>
</html>
