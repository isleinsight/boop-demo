<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Manage Staff – Vendor | Payulot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --ink:#102a43; --muted:#6b7c93; --blue:#2f80ed; --blue-dark:#1a5fcc;
      --bg:#ffffff; --panel:#ffffff; --stroke:#e5e7eb; --soft:#f8fafc;
      --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444; --nav:#0b1220;
    }
    *{box-sizing:border-box}
    body{ margin:0; font-family:'Poppins',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background:var(--bg); color:var(--ink); }

    /* ── Vendor NAV (matches other vendor pages) ── */
    .vendor-nav{ background:var(--nav); color:#fff; position:sticky; top:0; z-index:50; }
    .vendor-nav .nav-container{ max-width:1100px; margin:0 auto; padding:10px 18px; display:flex; align-items:center; justify-content:space-between; }
    .vendor-nav .nav-left img{ height:30px; display:block; }
    .vendor-nav .nav-right{ display:flex; align-items:center; gap:16px; }
    .vendor-nav .nav-right a{ color:#fff; text-decoration:none; font-size:.95rem; line-height:1; padding:6px 8px; border-radius:6px; opacity:.95; }
    .vendor-nav .nav-right a[aria-current="page"]{ opacity:1; background:rgba(255,255,255,.08); }
    .vendor-nav .nav-right a:hover{ opacity:1; background:rgba(255,255,255,.08); }

    .header{ max-width:1100px; margin:18px auto 0; padding:0 20px; }
    .header h1{ margin:16px 0 6px; font-size:clamp(22px,3vw,28px); }
    .sub{ color:var(--muted); margin:0; }

    .container{ max-width:1100px; margin:16px auto 40px; padding:0 20px; }
    .grid{ display:grid; grid-template-columns:1fr; gap:16px; }
    .card{ background:var(--panel); border:1px solid var(--stroke); border-radius:14px; padding:18px; box-shadow:0 8px 24px rgba(0,0,0,.06); }
    .card h2{ margin:0 0 10px; font-size:1.12rem; }

    .btn{ display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:10px 14px; border-radius:10px; font-weight:700; border:1px solid transparent; cursor:pointer; }
    .btn.primary{ background:var(--blue); color:#fff; border-color:var(--blue); }
    .btn.primary:hover{ background:var(--blue-dark); border-color:var(--blue-dark); }
    .btn.ghost{ background:#fff; border:1px solid var(--stroke); color:#111827; }
    .btn.ghost:hover{ border-color:#cbd5e1; }

    .row{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    label{ display:block; color:var(--muted); font-size:.92rem; margin:10px 0 6px; }
    input{ width:100%; padding:12px; border-radius:10px; border:1px solid var(--stroke); background:#fff; font-size:1rem; }

    .alert{ padding:10px 12px; border-radius:10px; border:1px solid var(--stroke); background:#f9fafb; display:none; }
    .alert.ok{ border-color:#dcfce7; background:#f0fdf4; color:#166534; display:block; }
    .alert.bad{ border-color:#fee2e2; background:#fef2f2; color:#991b1b; display:block; }

    .table{ width:100%; border-collapse:separate; border-spacing:0 10px; }
    .table th{ text-align:left; font-weight:600; color:#374151; padding:0 8px; }
    .table td{ background:#fff; border:1px solid var(--stroke); padding:12px 10px; }
    .tr{ border-radius:12px; }
    .actions{ display:flex; gap:8px; justify-content:flex-end; }

    /* Modal */
    .modal{ position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.45); z-index:1000; }
    .modal-card{ background:#fff; border:1px solid var(--stroke); border-radius:12px; padding:18px; width:92%; max-width:520px; }
  </style>
</head>
<body>
  <!-- Vendor auth gate -->
  <script>
    (async () => {
      try {
        const token = localStorage.getItem("boop_jwt");
        if (!token) throw new Error("No token");
        let me = JSON.parse(localStorage.getItem("boopUser") || "null");
        if (!me) {
          const r = await fetch("/api/me", { headers:{ Authorization:`Bearer ${token}` }});
          if (!r.ok) throw new Error("Unauthorized");
          me = await r.json(); localStorage.setItem("boopUser", JSON.stringify(me));
        }
        if ((me.role||"").toLowerCase() !== "vendor") throw new Error("Not a vendor");
      } catch {
        localStorage.clear(); location.href = "vendor-login.html";
      }
    })();
  </script>
  <script>
  setInterval(() => {
    fetch('/api/vendor/ping', {
      headers: { Authorization: `Bearer ${localStorage.getItem('boop_jwt')||''}` }
    }).catch(()=>{});
  }, 10 * 60 * 1000); // every 10 minutes
</script>

  <!-- NAV -->
  <nav class="vendor-nav">
    <div class="nav-container">
      <div class="nav-left">
        <a href="index.html" aria-label="Payulot home">
          <img src="../assets/logo-white.png" alt="Payulot Logo" />
        </a>
      </div>
      <div class="nav-right" aria-label="Primary">
        <a href="index.html">Home</a>
        <a href="transfer.html">Transfer</a>
        <a href="transactions.html">Transactions</a>
        <a href="manage-staff.html" aria-current="page">Manage Staff</a>
        <a href="#" id="logoutBtn">Log Out</a>
      </div>
    </div>
  </nav>

  <!-- HEADER -->
  <header class="header">
    <h1>Manage staff</h1>
    <p class="sub">Create, edit, and remove cashier logins for your business.</p>
  </header>

  <main class="container">
    <div id="flash" class="alert"></div>

    <section class="card">
      <div class="row" style="justify-content:space-between;">
        <h2 style="margin:0">Staff</h2>
        <button id="addBtn" class="btn primary">Add Staff</button>
      </div>

      <table class="table" aria-describedby="staffTable">
        <thead>
          <tr>
            <th style="width:30%">Name</th>
            <th style="width:35%">Email</th>
            <th style="width:20%">Status</th>
            <th style="width:15%"></th>
          </tr>
        </thead>
        <tbody id="staffBody">
          <tr><td colspan="4" style="padding:16px;border:1px dashed var(--stroke);text-align:center;background:#fff;">Loading…</td></tr>
        </tbody>
      </table>
    </section>
  </main>

  <!-- Add/Edit Modal -->
  <div id="editModal" class="modal" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <h3 id="modalTitle" style="margin:0 0 10px;">Add staff</h3>
      <label>Full name</label>
      <input id="fName" type="text" placeholder="e.g., Suzy Q" />
      <label style="margin-top:8px;">Email</label>
      <input id="fEmail" type="email" placeholder="name@example.com" />
      <label style="margin-top:8px;">Password</label>
      <input id="fPassword" type="password" placeholder="Set a password" />
      <div id="modalMsg" class="alert" style="margin-top:10px;"></div>
      <div class="row" style="justify-content:flex-end;margin-top:10px;">
        <button id="saveBtn" class="btn primary">Save</button>
        <button id="cancelBtn" class="btn ghost">Cancel</button>
      </div>
    </div>
  </div>

  <footer style="border-top:1px solid var(--stroke);background:#fff;">
    <div style="max-width:1100px;margin:0 auto;padding:16px 18px;display:flex;gap:14px;align-items:center;justify-content:space-between;color:#6b7280;font-size:.9rem;">
      <div>© 2025 Payulot</div>
      <div><a href="/terms.html" target="_blank" rel="noopener" style="color:#6b7280;text-decoration:none;margin-right:12px;">Terms</a><a href="/privacy.html" target="_blank" rel="noopener" style="color:#6b7280;text-decoration:none;">Privacy</a></div>
    </div>
  </footer>

  <!-- Shared helpers (make sure the path & name match your file on disk) -->
  <script src="vendor-common.js"></script>

<script>
  /* ─────────────────────────────────────────────────────────
     Tiny fallbacks (in case vendor-common.js wasn't loaded)
  ───────────────────────────────────────────────────────── */
  (function ensureHelpers(){
    if (typeof window.apiFetch === 'function') return;
    window.apiFetch = async (url, opts = {}) => {
      const token = localStorage.getItem('boop_jwt');
      const headers = { 'Content-Type': 'application/json', ...(opts.headers||{}) };
      if (token) headers.Authorization = `Bearer ${token}`;
      const res = await fetch(url, { ...opts, headers });
      const renewed = res.headers.get('x-renew-jwt');
      if (renewed) localStorage.setItem('boop_jwt', renewed);
      return res;
    };
    window.apiJSON = async (url, opts = {}) => {
      const r = await apiFetch(url, opts);
      const j = await r.json().catch(() => ({}));
      if (!r.ok) throw new Error(j.message || j.error || `HTTP ${r.status}`);
      return j;
    };
    window.apiGet    = (u)   => apiJSON(u);
    window.apiPost   = (u,b) => apiJSON(u, { method:'POST',   body: JSON.stringify(b||{}) });
    window.apiPatch  = (u,b) => apiJSON(u, { method:'PATCH',  body: JSON.stringify(b||{}) });
    window.apiDelete = (u,b) => apiJSON(u, { method:'DELETE', body: JSON.stringify(b||{}) });
  })();

  /* ─────────────────────────────────────────────────────────
     Manage Staff page logic
  ───────────────────────────────────────────────────────── */
  (function(){
    const flash     = document.getElementById('flash');
    const body      = document.getElementById('staffBody');    // <tbody id="staffBody">
    const addBtn    = document.getElementById('addBtn');

    // Modal controls
    const modal     = document.getElementById('editModal');
    const title     = document.getElementById('modalTitle');
    const fName     = document.getElementById('fName');
    const fEmail    = document.getElementById('fEmail');
    const fPass     = document.getElementById('fPassword');
    const mMsg      = document.getElementById('modalMsg');
    const saveBtn   = document.getElementById('saveBtn');
    const cancelBtn = document.getElementById('cancelBtn');

    let editingId = null;

    function showFlash(msg, ok=true){
      if (!flash) return;
      flash.textContent = msg;
      flash.className = 'alert ' + (ok ? 'ok' : 'bad');
      flash.style.display = 'block';
      setTimeout(()=> (flash.style.display='none'), 3500);
    }

    function openModal(mode, staff){
      editingId = (mode === 'edit') ? staff.id : null;
      title.textContent = (mode === 'edit') ? 'Edit staff' : 'Add staff';
      fName.value  = staff?.name  || staff?.display_name || '';
      fEmail.value = staff?.email || '';
      fPass.value  = '';
      mMsg.textContent = '';
      mMsg.style.display = 'none';
      modal.style.display = 'grid';
      fName.focus();
    }
    function closeModal(){ modal.style.display = 'none'; }

    async function loadStaff(){
      body.innerHTML =
        `<tr><td colspan="4" style="padding:16px;border:1px dashed var(--stroke);text-align:center;background:#fff;">Loading…</td></tr>`;
      try{
        // API returns { staff: [...] }
        const data = await apiGet('/api/vendor/vendorstaff');
        const list = Array.isArray(data?.staff) ? data.staff : Array.isArray(data) ? data : [];

        if (list.length === 0){
          body.innerHTML =
            `<tr><td colspan="4" style="padding:16px;border:1px dashed var(--stroke);text-align:center;background:#fff;">
               No staff yet.<br/>Click <b>Add Staff</b> to create your first cashier login.
             </td></tr>`;
          return;
        }

        body.innerHTML = list.map(s => {
          const status = s.disabled ? 'Inactive' : 'Active';
          const name   = s.display_name || s.name || s.username || '—';
          const email  = s.email || '—';
          return `
            <tr class="tr" data-id="${s.id}">
              <td>${name}</td>
              <td>${email}</td>
              <td>${status}</td>
              <td>
                <div class="actions">
                  <button class="btn ghost" data-edit="${s.id}">Edit</button>
                  <button class="btn ghost" data-del="${s.id}">Delete</button>
                </div>
              </td>
            </tr>`;
        }).join('');

      } catch (e){
        body.innerHTML =
          `<tr><td colspan="4" style="padding:16px;border:1px dashed var(--stroke);text-align:center;background:#fff;color:#991b1b;">
             Couldn’t load staff. ${e && e.message ? e.message : ''}
           </td></tr>`;
        console.error('loadStaff error:', e);
      }
    }

    // Add
    addBtn.addEventListener('click', () => openModal('add'));

    // Save (add or edit)
    saveBtn.addEventListener('click', async () => {
      const name  = fName.value.trim();
      const email = fEmail.value.trim();
      const pass  = fPass.value.trim();

      if (!name || !email || (!editingId && !pass)){
        mMsg.textContent = 'Name and email are required. Password is required when creating.';
        mMsg.className = 'alert bad';
        mMsg.style.display = 'block';
        return;
      }

      try{
        if (editingId){
          await apiPatch(`/api/vendor/vendorstaff/${editingId}`, { name, email, password: pass || undefined });
          showFlash('Staff updated.', true);
        } else {
          await apiPost('/api/vendor/vendorstaff', { name, email, password: pass });
          showFlash('Staff added.', true);
        }
        closeModal();
        loadStaff();
      } catch(e){
        mMsg.textContent = e.message || 'Save failed';
        mMsg.className = 'alert bad';
        mMsg.style.display = 'block';
      }
    });

    // Cancel + backdrop click
    cancelBtn.addEventListener('click', closeModal);
    modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });

    // Row actions (edit/delete)
    body.addEventListener('click', (e) => {
      const editId = e.target?.getAttribute?.('data-edit');
      const delId  = e.target?.getAttribute?.('data-del');

      if (editId){
        const tr = e.target.closest('tr');
        const name  = tr.children[0].textContent.trim();
        const email = tr.children[1].textContent.trim();
        openModal('edit', { id: editId, name, email });
      } else if (delId){
        if (confirm('Delete this staff account?')){
          apiDelete(`/api/vendor/vendorstaff/${delId}`)
            .then(() => { showFlash('Staff deleted.', true); loadStaff(); })
            .catch(err => showFlash(err.message || 'Delete failed', false));
        }
      }
    });

    // Logout (top-right)
    document.getElementById('logoutBtn')?.addEventListener('click', async (e)=>{
      e.preventDefault();
      try { await fetch('/api/logout', { method:'POST' }); } catch {}
      localStorage.clear();
      location.href = 'vendor-login.html';
    });

    // Init
    loadStaff();
  })();
</script>
</body>
</html>
