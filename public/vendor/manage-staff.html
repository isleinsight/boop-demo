<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Manage Staff – Vendor | Payulot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --ink:#102a43; --muted:#6b7c93; --blue:#2f80ed; --blue-dark:#1a5fcc;
      --bg:#ffffff; --panel:#ffffff; --stroke:#e5e7eb; --soft:#f8fafc;
      --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444; --nav:#0b1220;
    }
    *{ box-sizing:border-box }
    body{ margin:0; font-family:'Poppins',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background:var(--bg); color:var(--ink); }

    /* ── NAV + mobile drawer (matches Transfer) ───────────────── */
    .vendor-nav{ background:var(--nav); color:#fff; position:sticky; top:0; z-index:1000; }
    .vendor-nav .nav-container{
      max-width:1100px; margin:0 auto; padding:10px 18px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .vendor-nav .nav-left img{ height:30px; display:block; }
    .vendor-nav .nav-right{ display:flex; align-items:center; gap:16px; }
    .vendor-nav .nav-right a{
      color:#fff; text-decoration:none; font-size:.95rem; line-height:1;
      padding:6px 8px; border-radius:6px; opacity:.95;
    }
    .vendor-nav .nav-right a[aria-current="page"]{ opacity:1; background:rgba(255,255,255,.08); }
    .vendor-nav .nav-right a:hover{ opacity:1; background:rgba(255,255,255,.08); }

    .hamburger{ display:none; flex-direction:column; gap:4px; cursor:pointer; }
    .hamburger span{ width:24px; height:3px; background:#fff; border-radius:2px; display:block; }
    @media (max-width: 900px){
      .vendor-nav .nav-right{ display:none; }
      .hamburger{ display:flex; }
    }

    .mobile-menu{
      position:fixed; top:0; right:-100%; width:260px; height:100%;
      background:var(--nav); color:#fff; transition:right .3s ease;
      padding:20px; display:flex; flex-direction:column; gap:12px;
      z-index:1100; box-shadow:-8px 0 24px rgba(0,0,0,.35);
    }
    .mobile-menu a{ color:#fff; text-decoration:none; padding:10px 0; font-size:1rem; border-radius:8px; }
    .mobile-menu a[aria-current="page"], .mobile-menu a:hover{ background:rgba(255,255,255,.08); }
    .mobile-menu.active{ right:0; }

    .overlay{
      position:fixed; inset:0; background:rgba(0,0,0,.5);
      display:none; z-index:1050;
    }
    .overlay.active{ display:block; }

    /* ── Page scaffold ─────────────────────────────────────────── */
    .header{ max-width:1100px; margin:18px auto 0; padding:0 20px; }
    .header h1{ margin:16px 0 6px; font-size:clamp(22px,3vw,28px); }
    .sub{ color:var(--muted); margin:0; }

    .container{ max-width:1100px; margin:16px auto 40px; padding:0 20px; }
    .card{ background:var(--panel); border:1px solid var(--stroke); border-radius:14px; padding:18px; box-shadow:0 8px 24px rgba(0,0,0,.06); }
    .card h2{ margin:0 0 10px; font-size:1.12rem; }

    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      padding:10px 14px; border-radius:10px; font-weight:700; border:1px solid transparent; cursor:pointer;
    }
    .btn.primary{ background:var(--blue); color:#fff; border-color:var(--blue); }
    .btn.primary:hover{ background:var(--blue-dark); border-color:var(--blue-dark); }
    .btn.ghost{ background:#fff; border:1px solid var(--stroke); color:#111827; }
    .btn.ghost:hover{ border-color:#cbd5e1; }

    .row{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; }

    /* ── Table + mobile scroll wrapper ─────────────────────────── */
    .table-scroll{ overflow:auto; border-radius:12px; }
    table.table{ width:100%; min-width:680px; border-collapse:separate; border-spacing:0 10px; }
    .table th{ text-align:left; font-weight:600; color:#374151; padding:0 8px; }
    .table td{ background:#fff; border:1px solid var(--stroke); padding:12px 10px; }
    .actions{ display:flex; gap:8px; justify-content:flex-end; }

    /* ── Flash + Modal ─────────────────────────────────────────── */
    .alert{ padding:10px 12px; border-radius:10px; border:1px solid var(--stroke); background:#f9fafb; display:none; }
    .alert.ok{ border-color:#dcfce7; background:#f0fdf4; color:#166534; display:block; }
    .alert.bad{ border-color:#fee2e2; background:#fef2f2; color:#991b1b; display:block; }

    .modal{ position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.45); z-index:1200; }
    .modal.is-open{ display:grid; }
    .modal-card{ background:#fff; border:1px solid var(--stroke); border-radius:12px; padding:18px; width:92%; max-width:520px; }
    .modal-card label{ display:block; color:var(--muted); font-size:.92rem; margin:10px 0 6px; }
    .modal-card input{ width:100%; padding:12px; border-radius:10px; border:1px solid var(--stroke); background:#fff; font-size:1rem; }

    /* Footer */
    footer{ border-top:1px solid var(--stroke); background:#fff; }
    .footer-inner{ max-width:1100px; margin:0 auto; padding:16px 18px; display:flex; gap:14px; align-items:center; justify-content:space-between; color:#6b7280; font-size:.9rem; }
    .footer-links a{ color:#6b7280; text-decoration:none; margin-left:12px; }
    .footer-links a:hover{ text-decoration:underline; }
  </style>
</head>
<body>
  <!-- Vendor auth gate -->
  <script>
    (async () => {
      try {
        const token = localStorage.getItem("boop_jwt");
        if (!token) throw new Error("No token");
        let me = JSON.parse(localStorage.getItem("boopUser") || "null");
        if (!me) {
          const r = await fetch("/api/me", { headers:{ Authorization:`Bearer ${token}` }});
          if (!r.ok) throw new Error("Unauthorized");
          me = await r.json(); localStorage.setItem("boopUser", JSON.stringify(me));
        }
        if ((me.role||"").toLowerCase() !== "vendor") throw new Error("Not a vendor");
      } catch {
        localStorage.clear(); location.href = "vendor-login.html";
      }
    })();
  </script>
  <script>
    // If device is logged in as cashier (boopStaff set), bounce to session page
    try {
      const staff = JSON.parse(localStorage.getItem('boopStaff') || 'null');
      if (staff) { location.replace('session.html'); }
    } catch {}
  </script>
  <script>
    // keep-alive
    setInterval(() => {
      fetch('/api/vendor/ping', {
        headers: { Authorization: `Bearer ${localStorage.getItem('boop_jwt')||''}` }
      }).catch(()=>{});
    }, 10 * 60 * 1000);
  </script>

  <!-- NAV (desktop + mobile drawer) -->
  <nav class="vendor-nav">
    <div class="nav-container">
      <div class="nav-left">
        <a href="index.html" aria-label="Payulot home">
          <img src="../assets/logo-white.png" alt="Payulot Logo" />
        </a>
      </div>
      <div class="nav-right" aria-label="Primary">
        <a href="index.html">Home</a>
        <a href="transfer.html">Transfer</a>
        <a href="transactions.html">Transactions</a>
        <a href="manage-staff.html" aria-current="page">Manage Staff</a>
        <a href="#" id="logoutBtn">Log Out</a>
      </div>
      <div class="hamburger" id="hamburger" aria-label="Open menu" aria-controls="mobileMenu" aria-expanded="false">
        <span></span><span></span><span></span>
      </div>
    </div>
  </nav>

  <!-- Mobile slide-in menu + overlay -->
  <div class="mobile-menu" id="mobileMenu" aria-hidden="true" role="dialog" aria-modal="true">
    <a href="index.html">Home</a>
    <a href="transfer.html">Transfer</a>
    <a href="transactions.html">Transactions</a>
    <a href="manage-staff.html" aria-current="page">Manage Staff</a>
    <a href="#" id="logoutBtnMobile">Log Out</a>
  </div>
  <div class="overlay" id="overlay"></div>

  <!-- HEADER -->
  <header class="header">
    <h1>Manage staff</h1>
    <p class="sub">Create, edit, and remove cashier logins for your business.</p>
  </header>

  <!-- MAIN -->
  <main class="container">
    <div id="flash" class="alert"></div>

    <section class="card">
      <div class="row" style="justify-content:space-between;">
        <h2 style="margin:0">Staff</h2>
        <button id="addBtn" class="btn primary">Add Staff</button>
      </div>

      <div class="table-scroll" role="region" aria-label="Staff table">
        <table class="table" aria-describedby="staffTable">
          <thead>
            <tr>
              <th style="width:30%">Name</th>
              <th style="width:35%">Email</th>
              <th style="width:20%">Status</th>
              <th style="width:15%"></th>
            </tr>
          </thead>
          <tbody id="staffBody">
            <tr><td colspan="4" style="padding:16px;border:1px dashed var(--stroke);text-align:center;background:#fff;">Loading…</td></tr>
          </tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- Add/Edit Modal (hidden by default) -->
  <div id="editModal" class="modal" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <h3 id="modalTitle" style="margin:0 0 10px;">Add staff</h3>
      <label>Full name</label>
      <input id="fName" type="text" placeholder="e.g., Suzy Q" />
      <label style="margin-top:8px;">Email</label>
      <input id="fEmail" type="email" placeholder="name@example.com" />
      <label style="margin-top:8px;">Password</label>
      <input id="fPassword" type="password" placeholder="Set a password" />
      <div id="modalMsg" class="alert" style="margin-top:10px;"></div>
      <div class="row" style="justify-content:flex-end;margin-top:10px;">
        <button id="saveBtn" class="btn primary">Save</button>
        <button id="cancelBtn" class="btn ghost">Cancel</button>
      </div>
    </div>
  </div>

  <footer>
    <div class="footer-inner">
      <div>© 2025 Payulot</div>
      <div class="footer-links">
        <a href="/terms.html" target="_blank" rel="noopener">Terms</a>
        <a href="/privacy.html" target="_blank" rel="noopener">Privacy</a>
      </div>
    </div>
  </footer>

  <!-- Shared helpers -->
  <script src="vendor-common.js"></script>

  <script>
    /* ---------- Mobile nav (identical to Transfer) ---------- */
    const hamburger   = document.getElementById('hamburger');
    const mobileMenu  = document.getElementById('mobileMenu');
    const overlay     = document.getElementById('overlay');
    const logoutBtn   = document.getElementById('logoutBtn');
    const logoutBtnMobile = document.getElementById('logoutBtnMobile');

    function openMenu(){
      mobileMenu.classList.add('active');
      overlay.classList.add('active');
      hamburger.setAttribute('aria-expanded','true');
      mobileMenu.setAttribute('aria-hidden','false');
    }
    function closeMenu(){
      mobileMenu.classList.remove('active');
      overlay.classList.remove('active');
      hamburger.setAttribute('aria-expanded','false');
      mobileMenu.setAttribute('aria-hidden','true');
    }
    hamburger?.addEventListener('click', ()=>{
      const expanded = hamburger.getAttribute('aria-expanded') === 'true';
      expanded ? closeMenu() : openMenu();
    });
    overlay?.addEventListener('click', closeMenu);
    window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeMenu(); });
    mobileMenu?.querySelectorAll('a').forEach(a=> a.addEventListener('click', closeMenu));

    async function doLogout(e){
      e?.preventDefault();
      try { await fetch('/api/logout', { method:'POST' }); } catch {}
      localStorage.clear();
      location.href = 'vendor-login.html';
    }
    logoutBtn?.addEventListener('click', doLogout);
    logoutBtnMobile?.addEventListener('click', (e)=>{ doLogout(e); closeMenu(); });
  </script>

  <!-- Manage Staff page logic -->
  <script>
    (function ensureHelpers(){
      if (typeof window.apiFetch === 'function') return;
      window.apiFetch = async (url, opts = {}) => {
        const token = localStorage.getItem('boop_jwt');
        const headers = { 'Content-Type': 'application/json', ...(opts.headers||{}) };
        if (token) headers.Authorization = `Bearer ${token}`;
        const res = await fetch(url, { ...opts, headers });
        const renewed = res.headers.get('x-renew-jwt');
        if (renewed) localStorage.setItem('boop_jwt', renewed);
        return res;
      };
      window.apiJSON = async (url, opts = {}) => {
        const r = await apiFetch(url, opts);
        const j = await r.json().catch(() => ({}));
        if (!r.ok) throw new Error(j.message || j.error || `HTTP ${r.status}`);
        return j;
      };
      window.apiGet    = (u)   => apiJSON(u);
      window.apiPost   = (u,b) => apiJSON(u, { method:'POST',   body: JSON.stringify(b||{}) });
      window.apiPatch  = (u,b) => apiJSON(u, { method:'PATCH',  body: JSON.stringify(b||{}) });
      window.apiDelete = (u,b) => apiJSON(u, { method:'DELETE', body: JSON.stringify(b||{}) });
    })();

    (function(){
      const flash     = document.getElementById('flash');
      const body      = document.getElementById('staffBody');
      const addBtn    = document.getElementById('addBtn');

      const modal     = document.getElementById('editModal');
      const title     = document.getElementById('modalTitle');
      const fName     = document.getElementById('fName');
      const fEmail    = document.getElementById('fEmail');
      const fPass     = document.getElementById('fPassword');
      const mMsg      = document.getElementById('modalMsg');
      const saveBtn   = document.getElementById('saveBtn');
      const cancelBtn = document.getElementById('cancelBtn');

      let editingId = null;

      function showFlash(msg, ok=true){
        if (!flash) return;
        flash.textContent = msg;
        flash.className = 'alert ' + (ok ? 'ok' : 'bad');
        flash.style.display = 'block';
        setTimeout(()=> (flash.style.display='none'), 3500);
      }

      function openStaffModal(mode, staff){
        editingId      = (mode === 'edit') ? staff.id : null;
        title.textContent = (mode === 'edit') ? 'Edit staff' : 'Add staff';
        fName.value    = staff?.display_name || staff?.name || '';
        fEmail.value   = staff?.username || staff?.email || '';
        fPass.value    = '';
        mMsg.textContent = ''; mMsg.className = 'alert';
        modal.classList.add('is-open');           // ← show
        modal.setAttribute('aria-hidden','false');
      }
      function closeStaffModal(){
        modal.classList.remove('is-open');        // ← hide
        modal.setAttribute('aria-hidden','true');
      }

      async function loadStaff(){
        body.innerHTML =
          `<tr><td colspan="4" style="padding:16px;border:1px dashed var(--stroke);text-align:center;background:#fff;">Loading…</td></tr>`;
        try{
          const data = await apiGet('/api/vendor/vendorstaff');
          const list = Array.isArray(data?.staff) ? data.staff : (Array.isArray(data) ? data : []);

          if (!list.length){
            body.innerHTML =
              `<tr><td colspan="4" style="padding:16px;border:1px dashed var(--stroke);text-align:center;background:#fff;">
                 No staff yet.<br/>Click <b>Add Staff</b> to create your first cashier login.
               </td></tr>`;
            return;
          }

          body.innerHTML = list.map(s => {
            const isActive = (typeof s.is_active === 'boolean') ? s.is_active : !s.disabled;
            const status   = isActive ? 'Active' : 'Inactive';
            const name     = s.display_name || s.name || s.username || '—';
            const username = s.username || '—';
            return `
              <tr class="tr" data-id="${s.id}">
                <td>${name}</td>
                <td>${username}</td>
                <td>${status}</td>
                <td>
                  <div class="actions">
                    <button class="btn ghost" data-edit="${s.id}">Edit</button>
                    <button class="btn ghost" data-del="${s.id}">Delete</button>
                  </div>
                </td>
              </tr>`;
          }).join('');

        } catch (e){
          body.innerHTML =
            `<tr><td colspan="4" style="padding:16px;border:1px dashed var(--stroke);text-align:center;background:#fff;color:#991b1b;">
               Couldn’t load staff. ${e && e.message ? e.message : ''}
             </td></tr>`;
        }
      }

      // Add
      addBtn.addEventListener('click', () => openStaffModal('add'));

      // Save (add or edit)
      saveBtn.addEventListener('click', async () => {
        const display_name = fName.value.trim();
        const username     = (fEmail.value || '').trim().toLowerCase();
        const password     = fPass.value.trim();

        if (!display_name || !username || (!editingId && !password)){
          mMsg.textContent = 'Name and email are required. Password is required when creating.';
          mMsg.className = 'alert bad';
          return;
        }

        try{
          if (editingId){
            await apiPatch(`/api/vendor/vendorstaff/${editingId}`, {
              display_name, username, password: password || undefined
            });
            showFlash('Staff updated.', true);
          } else {
            await apiPost('/api/vendor/vendorstaff', { display_name, username, password });
            showFlash('Staff added.', true);
          }
          closeStaffModal();
          loadStaff();
        } catch(e){
          mMsg.textContent = e.message || 'Save failed';
          mMsg.className = 'alert bad';
        }
      });

      // Cancel + backdrop click
      cancelBtn.addEventListener('click', closeStaffModal);
      modal.addEventListener('click', (e) => { if (e.target === modal) closeStaffModal(); });

      // Row actions (edit/delete)
      body.addEventListener('click', (e) => {
        const editId = e.target?.getAttribute?.('data-edit');
        const delId  = e.target?.getAttribute?.('data-del');

        if (editId){
          const tr   = e.target.closest('tr');
          const name = tr.children[0].textContent.trim();
          const uname= tr.children[1].textContent.trim();
          openStaffModal('edit', { id: editId, display_name: name, username: uname });
        } else if (delId){
          if (confirm('Delete this staff account?')){
            apiDelete(`/api/vendor/vendorstaff/${delId}`)
              .then(() => { showFlash('Staff deleted.', true); loadStaff(); })
              .catch(err => showFlash(err.message || 'Delete failed', false));
          }
        }
      });

      // Logout (desktop)
      document.getElementById('logoutBtn')?.addEventListener('click', async (e)=>{
        e.preventDefault();
        try { await fetch('/api/logout', { method:'POST' }); } catch {}
        localStorage.clear();
        location.href = 'vendor-login.html';
      });

      // Init
      loadStaff();
    })();
  </script>
</body>
</html>
