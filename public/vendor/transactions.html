<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Transactions – Vendor | BOOP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../assets/styles.css" />
  <style>
    :root { --ink:#1a2b4a; --muted:#6b7280; --stroke:#e6ebf1; }
    body { font-family:'Poppins',sans-serif; background:#f5f7fa; margin:0; color:var(--ink); }

    /* Top Nav */
    nav { background:#0b1220; color:#fff; }
    .nav-container { max-width:1100px; margin:0 auto; padding:12px 18px; display:flex; align-items:center; justify-content:space-between; }
    .nav-left img { height:32px; display:block; }
    .nav-right { display:flex; gap:16px; align-items:center; }
    .nav-right a { color:#fff; text-decoration:none; font-size:.95rem; }
    .nav-right a[aria-current="page"] { text-decoration:underline; }

    .container { max-width:1100px; margin:28px auto 40px; background:#fff; padding:24px 20px; border:1px solid var(--stroke); border-radius:12px; box-shadow:0 6px 16px rgba(0,0,0,.06); }

    h2 { margin:0 0 14px; font-size:1.4rem; }

    .notice {
      margin: 0 0 12px 0; padding: 10px 12px; background:#f7fafd; border:1px solid #e6ebf1;
      border-radius:8px; font-size:.95rem; color:#1a2b4a; display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }
    .chips { margin-left:auto; display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .chip { border:1px solid #d1d9e6; background:#fff; border-radius:14px; padding:4px 10px; font-size:.85rem; color:#1a2b4a; }
    .chip-btn { border:1px solid #2f80ed; color:#2f80ed; background:#fff; border-radius:14px; padding:5px 12px; font-size:.85rem; cursor:pointer; }
    .chip-btn:hover { background:#2f80ed; color:#fff; }

    table { width:100%; border-collapse:collapse; margin-top:10px; background:#fff; border-radius:8px; overflow:hidden; font-size:.95rem; }
    th, td { padding:12px 16px; text-align:left; border-bottom:1px solid #eef2f7; white-space:nowrap; }
    th { background:#f7fafd; font-weight:600; color:#1a2b4a; }
    tr:hover { background:#f5f8fb; }
    .status { color:#c0392b; text-align:center; padding:16px; font-weight:500; }

    /* Modal */
    .modal { display:none; position:fixed; z-index:1000; inset:0; background:rgba(0,0,0,.4); }
    .modal-content { background:#fff; margin:10% auto; padding:20px; border:1px solid #888; width:90%; max-width:520px; border-radius:10px; position:relative; }
    .close { position:absolute; top:10px; right:15px; font-size:28px; font-weight:bold; cursor:pointer; }

    /* Footer */
    footer { border-top:1px solid var(--stroke); }
    .footer-inner { max-width:1100px; margin:0 auto; padding:16px 18px; display:flex; gap:14px; align-items:center; justify-content:space-between; color:#6b7280; font-size:.9rem; }
    .footer-links a { color:#6b7280; text-decoration:none; margin-left:12px; }
    .footer-links a:hover { text-decoration:underline; }
  </style>
</head>
<body>
  <!-- Vendor auth guard -->
  <script>
    (async () => {
      try {
        const token = localStorage.getItem("boop_jwt");
        if (!token) throw new Error("No token");
        let me = JSON.parse(localStorage.getItem("boopUser") || "null");
        if (!me) {
          const r = await fetch("/api/me", { headers:{ Authorization:`Bearer ${token}` }});
          if (!r.ok) throw new Error("Unauthorized");
          me = await r.json();
          localStorage.setItem("boopUser", JSON.stringify(me));
        }
        if (me.role !== "vendor") throw new Error("Not a vendor");
      } catch {
        localStorage.clear();
        location.href = "../login.html";
      }
    })();
  </script>

  <!-- Top Nav (vendor) -->
  <nav>
    <div class="nav-container">
      <div class="nav-left">
        <img src="../assets/Boop-Logo.png" alt="BOOP Logo" />
      </div>
      <div class="nav-right">
        <a href="index.html">Home</a>
        <a href="transfer.html">Transfer</a>
        <a href="transactions.html" aria-current="page">Transactions</a>
        <a href="reports.html">Reports</a>
        <a href="#" id="logoutLink">Log Out</a>
      </div>
    </div>
  </nav>

  <div class="container">
    <h2>Recent Transactions</h2>

    <div class="notice">
      Showing the latest <span id="limitLabel" class="chip">100</span> transactions (your vendor account).
      <div class="chips">
        <span id="lastUpdated" class="chip">Last updated: —</span>
        <button id="toggleLive" class="chip-btn">Pause Live</button>
      </div>
    </div>

    <table id="transactionsTable">
      <thead>
        <tr>
          <th>Type</th>
          <th>Amount</th>
          <th>From</th>
          <th>To</th>
          <th>Time</th>
          <th>Note</th>
        </tr>
      </thead>
      <tbody id="transactionsBody">
        <tr><td colspan="6" class="status">Loading…</td></tr>
      </tbody>
    </table>
  </div>

  <!-- Note Modal -->
  <div id="noteModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h3 style="margin:0 0 10px;">Transaction Note</h3>
      <p id="noteContent" style="white-space: pre-wrap; color:#333; margin:0;"></p>
    </div>
  </div>

  <footer>
    <div class="footer-inner">
      <div>© 2025 BOOP</div>
      <div class="footer-links">
        <a href="/terms.html" target="_blank" rel="noopener">Terms</a>
        <a href="/privacy.html" target="_blank" rel="noopener">Privacy</a>
      </div>
    </div>
  </footer>

  <script type="module">
    const LIMIT = 100;
    const REFRESH_MS = 15000;

    const token = localStorage.getItem("boop_jwt");
    const me = JSON.parse(localStorage.getItem("boopUser") || "{}");

    const tbody = document.getElementById("transactionsBody");
    const limitLabel = document.getElementById("limitLabel");
    const lastUpdated = document.getElementById("lastUpdated");
    const toggleLive = document.getElementById("toggleLive");

    const modal = document.getElementById("noteModal");
    const noteContent = document.getElementById("noteContent");
    const modalClose = modal.querySelector(".close");

    limitLabel.textContent = String(LIMIT);

    let live = true;
    let intervalId = null;

    function setLastUpdated() {
      lastUpdated.textContent = "Last updated: " + new Date().toLocaleTimeString();
    }

    function startLive() {
      if (intervalId) clearInterval(intervalId);
      intervalId = setInterval(() => {
        if (live && document.visibilityState === "visible") {
          loadTransactions();
        }
      }, REFRESH_MS);
    }

    function money(cents) {
      const n = Number(cents || 0) / 100;
      return "$" + n.toFixed(2);
    }

    function resolveParties(tx) {
      const from = tx.sender_name || tx.from_name || tx.counterparty_from || null;
      const to   = tx.recipient_name || tx.to_name || tx.counterparty_to || null;
      const userSide = tx.customer_name || tx.user_name || tx.userEmail || tx.user_email || null;
      return {
        from: from || (tx.type === 'debit' ? (userSide || '—') : (tx.counterparty_name || '—')),
        to:   to   || (tx.type === 'credit' ? (userSide || '—') : '—')
      };
    }

    async function fetchWithFallbacks() {
      // Prefer a vendor-scoped endpoint
      let r = await fetch(`/api/vendor/transactions/recent?limit=${LIMIT}`, {
        headers: { Authorization:`Bearer ${token}` }
      });
      if (r.ok) return r.json();

      // Fallback: generic recent with vendor_id
      if (me?.id) {
        r = await fetch(`/api/transactions/recent?limit=${LIMIT}&vendor_id=${encodeURIComponent(me.id)}`, {
          headers:{ Authorization:`Bearer ${token}` }
        });
        if (r.ok) return r.json();
      }

      // Fallback: by wallet
      try {
        const w = await fetch(`/api/wallets/mine`, { headers:{ Authorization:`Bearer ${token}` }});
        const jw = await w.json();
        if (w.ok && jw.wallet_id) {
          r = await fetch(`/api/transactions/by-wallet/${jw.wallet_id}?limit=${LIMIT}`, {
            headers:{ Authorization:`Bearer ${token}` }
          });
          if (r.ok) return r.json();
        }
      } catch {}

      const payload = await r.json().catch(()=>({ message:"Failed to load" }));
      const err = new Error(payload.message || "Failed to fetch transactions");
      err.payload = payload;
      throw err;
    }

    async function loadTransactions() {
      try {
        const payload = await fetchWithFallbacks();
        const data = Array.isArray(payload) ? payload : (payload.transactions || []);

        if (!Array.isArray(data) || data.length === 0) {
          tbody.innerHTML = `<tr><td colspan="6" class="status">No transactions found.</td></tr>`;
          setLastUpdated();
          return;
        }

        const rows = data.map(tx => {
          const parties = resolveParties(tx);
          const noteText = tx.note || 'No note';
          const created = tx.created_at ? new Date(tx.created_at).toLocaleString() : "—";
          return `
            <tr>
              <td>${tx.type || '—'}</td>
              <td>${money(tx.amount_cents)}</td>
              <td>${parties.from || '—'}</td>
              <td>${parties.to || '—'}</td>
              <td>${created}</td>
              <td><button class="chip-btn" onclick="showNoteModal(\`${(String(noteText)).replace(/`/g,'\\`')}\`)">View</button></td>
            </tr>
          `;
        }).join("");

        tbody.innerHTML = rows;
        setLastUpdated();
      } catch (err) {
        console.error("❌ Vendor transactions error:", err);
        tbody.innerHTML = `<tr><td colspan="6" class="status">❌ ${err.message}</td></tr>`;
      }
    }

    // Expose for inline onclick
    window.showNoteModal = function(note) {
      noteContent.textContent = note || "No note";
      modal.style.display = "block";
    };

    // Modal handlers
    modalClose.onclick = () => (modal.style.display = "none");
    window.onclick = (e) => { if (e.target === modal) modal.style.display = "none"; };

    // Live toggle
    toggleLive.addEventListener("click", () => {
      live = !live;
      toggleLive.textContent = live ? "Pause Live" : "Resume Live";
      if (live) loadTransactions();
    });

    // Init
    document.addEventListener("visibilitychange", () => {
      if (document.visibilityState === "visible" && live) loadTransactions();
    });
    loadTransactions();
    startLive();

    // Logout
    document.getElementById("logoutLink")?.addEventListener("click", async (e) => {
      e.preventDefault();
      try { await fetch("/api/logout", { method:"POST" }); } catch {}
      localStorage.clear();
      location.href = "../login.html";
    });
  </script>
</body>
</html>
