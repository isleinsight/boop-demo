<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Transactions – Vendor | Payulot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --ink:#102a43; --muted:#6b7c93; --blue:#2f80ed; --blue-dark:#1a5fcc;
      --stroke:#e5e7eb; --bg:#ffffff; --nav:#0b1220;
      --grad1: rgba(47,128,237,.18); --grad2: rgba(16,185,129,.15);
      --green:#16a34a; --red:#dc2626;
    }
    *{box-sizing:border-box}
    body{ margin:0; font-family:'Poppins',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background:var(--bg); color:var(--ink); }

    .vendor-nav{ background:var(--nav); color:#fff; position:sticky; top:0; z-index:50; }
    .vendor-nav .nav-container{
      max-width:1100px; margin:0 auto;
      padding:10px 18px !important;
      display:flex; align-items:center; justify-content:space-between;
    }
    .vendor-nav .nav-left img{ height:30px !important; display:block; }
    .vendor-nav .nav-right{ display:flex; align-items:center; gap:16px !important; }
    .vendor-nav .nav-right a{
      color:#fff; text-decoration:none;
      font-size:.95rem !important; line-height:1 !important;
      padding:6px 8px !important; border-radius:6px; opacity:.95;
    }
    .vendor-nav .nav-right a[aria-current="page"]{ opacity:1; background:rgba(255,255,255,.08); }
    .vendor-nav .nav-right a:hover{ opacity:1; background:rgba(255,255,255,.08); }

    .hero-band{
      background:
        radial-gradient(1000px 600px at 85% -10%, var(--grad1), transparent 60%),
        radial-gradient(700px 500px at -10% 110%, var(--grad2), transparent 60%),
        linear-gradient(180deg, #0b1220 0%, #0d1220 40%, #0b1220 100%);
      color:#eef2ff; padding:26px 0 22px;
    }
    .hero-inner{ max-width:1100px; margin:0 auto; padding:0 20px; display:flex; align-items:center; justify-content:space-between; gap:16px; }
    .hero-title{ margin:0; font-size:clamp(20px,3.2vw,28px); font-weight:600; }
    .hero-sub{ margin:6px 0 0; color:#cbd5e1; font-size:.95rem; }

    .container{ max-width:1100px; margin:18px auto 40px; padding:0 20px; }
    .filters{
      display:flex; flex-wrap:wrap; gap:10px; align-items:end; margin-bottom:16px;
      border:1px solid var(--stroke); border-radius:12px; padding:12px; background:#fff;
    }
    .filters .btn-group{ display:flex; gap:8px; }
    .filters .btn-group button{
      padding:8px 12px; border:1px solid var(--stroke); border-radius:999px; background:#fff; cursor:pointer; font-weight:600;
    }
    .filters .btn-group button.active{ background:var(--blue); color:#fff; border-color:var(--blue); }
    .filters input{ padding:10px 12px; border:1px solid var(--stroke); border-radius:8px; font-size:.95rem; background:#fff; }
    .spacer{ flex:1; }
    .export-btn{
      background:var(--blue); color:#fff; border:none; padding:10px 14px; border-radius:8px; cursor:pointer; font-weight:600;
      transition:background-color .2s ease-in-out;
    }
    .export-btn:hover{ background:var(--blue-dark); }

    .list{ display:grid; gap:10px; }
    .item{
      background:#fff; border:1px solid var(--stroke); border-radius:12px;
      padding:12px 14px; display:flex; align-items:center; gap:12px;
    }
    .avatar{
      width:42px; height:42px; border-radius:50%; background:#e2e8f0; display:flex; align-items:center; justify-content:center;
      font-weight:700; color:#334155; flex:0 0 42px;
    }
    .line{ display:flex; align-items:center; justify-content:space-between; width:100%; gap:10px; }
    .who{ font-weight:600; }
    .amt{ font-weight:700; white-space:nowrap; }
    .amt.positive{ color:var(--green); }
    .amt.negative{ color:var(--red); }
    .meta{ font-size:.85rem; color:#94a3b8; margin-top:2px; }

    .empty{ text-align:center; color:#64748b; padding:20px; border:1px dashed var(--stroke); border-radius:12px; background:#fff; }

    footer{ border-top:1px solid var(--stroke); background:#fff; }
    .footer-inner{ max-width:1100px; margin:0 auto; padding:16px 18px; display:flex; gap:14px; align-items:center; justify-content:space-between; color:#6b7280; font-size:.9rem; }
    .footer-links a{ color:#6b7280; text-decoration:none; margin-left:12px; }
    .footer-links a:hover{ text-decoration:underline; }
  </style>
</head>
<body>
  <!-- Vendor auth gate -->
  <script>
    (async () => {
      try {
        const token = localStorage.getItem("boop_jwt");
        if (!token) throw new Error("No token");
        let me = JSON.parse(localStorage.getItem("boopUser") || "null");
        if (!me) {
          const r = await fetch("/api/me", { headers:{ Authorization:`Bearer ${token}` }});
          if (!r.ok) throw new Error("Unauthorized");
          me = await r.json(); localStorage.setItem("boopUser", JSON.stringify(me));
        }
        if ((me.role||"").toLowerCase() !== "vendor") throw new Error("Not a vendor");
      } catch {
        localStorage.clear(); location.href = "vendor-login.html";
      }
    })();
  </script>

  <!-- Load vendor helpers BEFORE page logic -->
  <script src="vendor-common.js"></script>

  <!-- Keep-alive using helper (captures x-renew-jwt) -->
  <script>
    setInterval(() => {
      apiFetch('/api/vendor/ping').catch(()=>{});
    }, 10 * 60 * 1000);
  </script>

  <!-- NAV -->
  <nav class="vendor-nav">
    <div class="nav-container">
      <div class="nav-left">
        <a href="index.html"><img src="../assets/logo-white.png" alt="Payulot Logo" /></a>
      </div>
      <div class="nav-right">
        <a href="index.html">Home</a>
        <a href="transfer.html">Transfer</a>
        <a href="transactions.html" aria-current="page">Transactions</a>
        <a href="manage-staff.html">Manage Staff</a>
        <a href="#" id="logoutLink">Log Out</a>
      </div>
    </div>
  </nav>

  <!-- HERO -->
  <section class="hero-band">
    <div class="hero-inner">
      <div>
        <h1 class="hero-title">Transactions</h1>
        <p class="hero-sub">Your recent payments, refunds, and payouts.</p>
      </div>
    </div>
  </section>

  <!-- MAIN -->
  <main class="container">
    <div class="filters">
      <div class="btn-group" role="group" aria-label="Quick ranges">
        <button id="btn7">Last 7 days</button>
        <button id="btn30" class="active">Last 30 days</button>
        <button id="btn90">Last 90 days</button>
      </div>

      <div class="spacer"></div>

      <div>
        <label style="display:block;font-size:.85rem;color:#64748b;margin:0 0 6px;">Custom range</label>
        <div style="display:flex; gap:8px;">
          <input type="date" id="startDate">
          <input type="date" id="endDate">
          <button id="applyCustom">Apply</button>
        </div>
      </div>

      <div class="spacer"></div>

      <button id="exportBtn" class="export-btn">Export CSV</button>
    </div>

    <div id="list" class="list">
      <div class="empty">Loading…</div>
    </div>
  </main>

  <footer>
    <div class="footer-inner">
      <div>© 2025 Payulot</div>
      <div class="footer-links">
        <a href="/terms.html" target="_blank" rel="noopener">Terms</a>
        <a href="/privacy.html" target="_blank" rel="noopener">Privacy</a>
      </div>
    </div>
  </footer>

  <!-- Page logic (uses apiJSON from vendor-common.js) -->
  <script>
  (function () {
    const listEl = document.getElementById('list');

    let allTx = [];
    let filtered = [];

    const btn7 = document.getElementById('btn7');
    const btn30 = document.getElementById('btn30');
    const btn90 = document.getElementById('btn90');
    const startEl = document.getElementById('startDate');
    const endEl = document.getElementById('endDate');
    const applyCustom = document.getElementById('applyCustom');
    const exportBtn = document.getElementById('exportBtn');

    function dollars(c) { return `$${(Number(c || 0) / 100).toFixed(2)}`; }
    function byDateDesc(a, b) { return new Date(b.created_at) - new Date(a.created_at); }
    function setActive(btn) { [btn7, btn30, btn90].forEach(b => b.classList.toggle('active', b === btn)); }

    function withinRange(tx, start, end) {
      const t = new Date(tx.created_at).getTime();
      if (start && t < start) return false;
      if (end && t > end) return false;
      return true;
    }

    function render() {
      if (!filtered.length) {
        listEl.innerHTML = `<div class="empty">No transactions for this range.</div>`;
        return;
      }
      listEl.innerHTML = filtered.map(tx => {
        const isCredit = (tx.type || '').toLowerCase() === 'credit';
        const who = isCredit
          ? (tx.sender_name || tx.from_name || 'Customer')
          : (tx.recipient_name || tx.to_name || 'Counterparty');
        const verb = isCredit ? 'Received from' : 'Sent to';
        const sign = isCredit ? '+' : '−';
        const cls = isCredit ? 'positive' : 'negative';
        const initials = (who?.trim?.()[0] || 'U').toUpperCase();
        const when = tx.created_at ? new Date(tx.created_at).toLocaleString() : '';
        const note = tx.note ? ` • ${tx.note}` : '';
        return `
          <div class="item">
            <div class="avatar">${initials}</div>
            <div class="line">
              <div>
                <div class="who">${verb} ${who}</div>
                <div class="meta">${when}${note}</div>
              </div>
              <div class="amt ${cls}">${sign}${dollars(tx.amount_cents)}</div>
            </div>
          </div>`;
      }).join('');
    }

    function applyRange(days) {
      const now = Date.now();
      const start = now - days * 24 * 60 * 60 * 1000;
      const end = now;
      setActive(days === 7 ? btn7 : days === 30 ? btn30 : btn90);
      filtered = allTx.filter(tx => withinRange(tx, start, end)).sort(byDateDesc);
      render();
    }

    function applyCustomRange() {
      const s = startEl.value ? new Date(startEl.value).setHours(0, 0, 0, 0) : null;
      const e = endEl.value ? new Date(endEl.value).setHours(23, 59, 59, 999) : null;
      setActive(null);
      filtered = allTx.filter(tx => withinRange(tx, s, e)).sort(byDateDesc);
      render();
    }

    btn7.addEventListener('click', () => applyRange(7));
    btn30.addEventListener('click', () => applyRange(30));
    btn90.addEventListener('click', () => applyRange(90));
    applyCustom.addEventListener('click', applyCustomRange);

    exportBtn.addEventListener('click', () => {
      if (!filtered.length) return;
      const headers = ["Date", "Direction", "Counterparty", "Amount", "Note", "TxID"];
      const rows = filtered.map(tx => {
        const isCredit = (tx.type || '').toLowerCase() === 'credit';
        const dir = isCredit ? "Received" : "Sent";
        const who = isCredit ? (tx.sender_name || tx.from_name || '')
                             : (tx.recipient_name || tx.to_name || '');
        return [
          tx.created_at ? new Date(tx.created_at).toISOString() : "",
          dir,
          who,
          (Number(tx.amount_cents || 0) / 100).toFixed(2),
          (tx.note || "").replace(/,/g, " "),
          tx.id || ""
        ];
      });
      const csv = [headers, ...rows].map(r => r.join(",")).join("\n");
      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = "vendor-transactions.csv";
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    });

    async function fetchVendorRange({ startISO, endISO, limit = 500 }) {
      const qs = new URLSearchParams();
      if (startISO) qs.set("start", startISO.slice(0, 10));
      if (endISO)   qs.set("end",   endISO.slice(0, 10));
      qs.set("limit", String(limit));
      qs.set("offset", "0");
      const data = await apiJSON(`/api/vendor/transactions/report?${qs.toString()}`);
      const rows = data.transactions || [];
      return rows.map(r => ({
        id: r.id,
        created_at: r.created_at,
        type: r.type,
        amount_cents: r.amount_cents,
        note: r.note,
        sender_name: r.sender_name || r.from_name,
        recipient_name: r.recipient_name || r.to_name
      }));
    }

    async function loadDefault() {
      try {
        const now = new Date();
        const start = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000);
        allTx = await fetchVendorRange({ startISO: start.toISOString(), endISO: now.toISOString(), limit: 500 });
        applyRange(30);
      } catch (e) {
        console.warn('vendor report error', e);
        listEl.innerHTML = `<div class="empty">Couldn’t load transactions.</div>`;
      }
    }

    document.getElementById('logoutLink')?.addEventListener('click', async (e) => {
      e.preventDefault();
      try { await apiFetch('/api/logout', { method: 'POST' }); } catch {}
      localStorage.clear();
      location.href = 'vendor-login.html';
    });

    loadDefault();
  })();
  </script>
</body>
</html>
