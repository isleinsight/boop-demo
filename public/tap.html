<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Scanning…</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-store" />
  <style>
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:#0b1220;color:#eaf0ff;
         display:flex;align-items:center;justify-content:center;min-height:100vh}
    .s {text-align:center;opacity:.9}
  </style>
</head>
<body>
  <div class="s">Scanning…</div>
  <script>
  (function(){
    const ORIGIN = location.origin;
    const KIOSK_NAME = 'payulot_kiosk';

    // 1) Get pid from the tag/QR
    const u = new URL(window.location.href);
    const pid  = (u.searchParams.get('pid') || '').trim();
    // Optional hint (kept, but not forwarded in URL)
    const mode = (u.searchParams.get('mode') || '').trim().toLowerCase();

    // 2) Always open kiosk WITHOUT pid in the URL
    const kioskUrl = '/passport/index.html';

    // 3) Try to reuse a named window; if we cannot (same-tab fallback), stash pid in sessionStorage
    let w = null;
    try { w = window.open('', KIOSK_NAME); } catch {}

    if (w) {
      try { w.location.replace(kioskUrl); } catch { w.location.href = kioskUrl; }

      // Handshake: when kiosk signals ready, send pid via postMessage
      const onReady = (ev) => {
        if (ev.origin !== ORIGIN) return;
        const d = ev.data || {};
        if (d.type === 'charge:ready') {
          try { w.postMessage({ type: 'charge:start', pn: pid, mode }, ORIGIN); } catch {}
          window.removeEventListener('message', onReady);
          // Close this relay
          try { window.close(); } catch {}
          setTimeout(()=>{ try{ window.location.replace('/'); }catch{} }, 1200);
        }
      };
      window.addEventListener('message', onReady);
    } else {
      // Same-tab fallback: stash pid so kiosk can pick it up on load
      try { sessionStorage.setItem('tap:pendingPid', pid); sessionStorage.setItem('tap:pendingMode', mode); } catch {}
      window.location.href = kioskUrl;
    }
  })();
  </script>
</body>
</html>
