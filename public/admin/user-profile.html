<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>User Profile - Payulot Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../assets/styles.css" />
</head>
<body>
<div id="screenGuard" style="display:none; position:fixed; inset:0; background:#0b1220; color:#fff; 
  display:flex; align-items:center; justify-content:center; text-align:center; padding:24px; z-index:9999;">
  <div style="max-width:540px;">
    <h2 style="margin:0 0 12px; font-family:Poppins, sans-serif;">Desktop Required</h2>
    <p>For security and usability, the Payulot Admin dashboard must be used on a desktop or tablet in landscape.</p>
  </div>
</div>
<script>
  (function(){
    const minWidth = 900; 
    const guard = document.getElementById('screenGuard');
    function update(){ guard.style.display = (window.innerWidth < minWidth) ? 'flex' : 'none'; }
    window.addEventListener('resize', update, { passive:true });
    update();
  })();
</script>
  
  <script>
    (async () => {
      try {
        const token = localStorage.getItem("boop_jwt");
        const res = await fetch("/api/me", {
          headers: { Authorization: `Bearer ${token}` }
        });
        if (!res.ok) throw new Error("Unauthorized");
        const meData = await res.json();
        const allowedTypes = ["super_admin", "admin", "support"];
        if (!meData || meData.role !== "admin" || !allowedTypes.includes(meData.type)) {
          throw new Error("Invalid role or type");
        }
        localStorage.setItem("boopUser", JSON.stringify(meData));
      } catch (err) {
        console.warn("Not authorized or error fetching user:", err);
        localStorage.removeItem("boop_jwt");
        localStorage.removeItem("boopUser");
        window.location.href = "../government-portal.html";
      }
    })();
  </script>

  <!-- Top Nav -->
<nav>
  <div class="nav-container">
    <div class="nav-left">
      <img src="../assets/logo-white.png" alt="Payulot Logo" />
    </div>
    <div class="nav-right">
      <a href="index.html">Dashboard</a>
      <a href="admin-actions.html">Admin Actions</a>
      <div class="nav-dropdown">
        <a href="#" class="dropbtn" style="color: white;">Add</a>
        <div class="dropdown-content">
          <a href="add-user.html" id="addUserLink">Add User</a>
          <a href="assign-card.html" id="assignCardLink">Assign Card</a>
          <a href="assign-student.html">Assign Student</a>
        </div>
      </div>
      <a href="view-users.html">View Users</a>
      <a href="#" id="logoutBtn">Log Out</a>
    </div>
  </div>
</nav>


  <div class="profile-container user-profile-page">
    <a href="view-users.html" class="back-button">‚Üê Back to Users</a>
    <h2>User Profile</h2>

    <div class="action-buttons">
  <button id="editProfileBtn" class="btnEdit">Edit Profile</button>
  <button id="saveProfileBtn" style="display: none;" class="btnEdit">Save Changes</button>
  <button id="resetPasswordBtn" class="btnEdit" title="Email a reset link to this user">
    Reset Password
  </button>
  <span id="resetPwStatus" style="font-size:.9rem;color:#4b5563;"></span>
</div>

    <div class="user-details-grid" id="userInfo"></div>

    <!-- Vendor Info -->
    <div id="vendorSection" style="display: none; margin-top: 40px;">
      <div class="section-title">Vendor Information</div>
      <div class="user-details-grid">
        <div>
          <span class="label">Business Name</span>
          <span class="value" id="vendorBusiness">-</span>
          <input type="text" id="editBusiness" style="display: none; width: 100%;" />
        </div>
        <div>
          <span class="label">Category</span>
          <span class="value" id="vendorCategory">-</span>
          <input type="text" id="editCategory" style="display: none; width: 100%;" />
        </div>
        <div>
          <span class="label">Phone</span>
          <span class="value" id="vendorPhone">-</span>
          <input type="text" id="editPhone" style="display: none; width: 100%;" />
        </div>
      </div>
    </div>

    <!-- Parent Info -->
    <div id="parentSection" style="display: none; margin-top: 40px;">
      <div class="section-title">Parent Information</div>
      <div class="user-details-grid">
        <div>
          <span class="label">Name</span>
          <span class="value" id="parentName">-</span>
        </div>
        <div>
          <span class="label">Email</span>
          <span class="value" id="parentEmail">-</span>
        </div>
      </div>
    </div>

    <!-- Student Info -->
    <div id="studentInfoSection" style="display: none; margin-top: 40px;">
      <div class="section-title">Student Information</div>
      <div class="action-buttons">
        <button id="editStudentBtn" class="btnEdit">Edit Student</button>
        <button id="saveStudentBtn" class="btnEdit" style="display: none;">Save Student Info</button>
      </div>
      <div class="user-details-grid">
        <div>
          <span class="label">School Name</span>
          <span class="value" id="studentSchoolName">-</span>
          <input type="text" id="editSchoolName" style="display: none; width: 100%;" />
        </div>
        <div>
          <span class="label">Grade Level</span>
          <span class="value" id="studentGradeLevel">-</span>
          <input type="text" id="editGradeLevel" style="display: none; width: 100%;" />
        </div>
        <div>
          <span class="label">Expiry Date</span>
          <span class="value" id="studentExpiryDate">-</span>
          <input type="date" id="editExpiryDate" style="display: none; width: 100%;" />
        </div>
      </div>
    </div>

    <!-- Transaction History -->
    <div class="section-title">Transaction History</div>
    <div class="table-scroll-wrapper">
      <table class="transaction-table" id="transactionTable">
        <thead>
          <tr>
            <th>Date</th>
            <th>Amount</th>
            <th>Name</th>
            <th>Status</th>
            <th>Note</th>
            <th>ID</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="action-buttons" style="justify-content: center;">
      <button id="prevTransactions" class="btn-secondary">Previous</button>
      <span id="transactionPageIndicator">Page 1</span>
      <button id="nextTransactions" class="btn-secondary">Next</button>
    </div>

    <!-- Modal -->
    <div id="modal" class="modal" style="display: none;">
      <div class="modal-content">
        <p id="modalMessage"></p>
        <input type="text" id="modalInput" placeholder="Type DELETE to confirm" style="display: none;" />
        <div>
          <button id="confirmModalBtn">Confirm</button>
          <button id="cancelModalBtn">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    document.addEventListener("DOMContentLoaded", () => {
      const user = JSON.parse(localStorage.getItem("boopUser"));

      // Hide "Add Funds" link for treasury users
      if (user?.type === "treasury") {
        const addFundsLink = document.getElementById("addFundsLink");
        if (addFundsLink) addFundsLink.style.display = "none";
      }

      const logoutBtn = document.getElementById("logoutBtn");
      if (logoutBtn) {
        logoutBtn.addEventListener("click", (e) => {
          e.preventDefault();
          localStorage.clear();
          window.location.href = "../government-portal.html";
        });
      }

      // Mobile menu logic
      const hamburger = document.querySelector(".hamburger");
      const navRight = document.querySelector(".nav-right");
      const dropbtn = document.querySelector(".nav-dropdown .dropbtn");
      const dropdownContent = document.querySelector(".dropdown-content");

      if (hamburger && navRight) {
        hamburger.addEventListener("click", () => {
          hamburger.classList.toggle("active");
          navRight.classList.toggle("active");
        });
      }

      if (dropbtn && dropdownContent) {
        dropbtn.addEventListener("click", (e) => {
          if (window.innerWidth <= 768) {
            e.preventDefault();
            dropdownContent.classList.toggle("active");
          }
        });
      }

      navRight.querySelectorAll("a").forEach((link) => {
        link.addEventListener("click", () => {
          if (window.innerWidth <= 768) {
            hamburger.classList.remove("active");
            navRight.classList.remove("active");
            if (dropdownContent) {
              dropdownContent.classList.remove("active");
            }
          }
        });
      });
    });
  </script>
  <script type="module" src="user-profile.js"></script>
  <script type="module" src="../assets/hamburger.js"></script>
</body>
</html>
