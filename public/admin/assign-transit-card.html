<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Assign Transit Card – BOOP Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../assets/styles.css" />
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: #f4f7fa;
    }

    .container-small {
      max-width: 500px;
      background: white;
      margin: 50px auto;
      padding: 30px 40px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .input-group {
      margin-bottom: 20px;
    }

    input, select, button {
      width: 100%;
      padding: 10px;
      font-size: 1rem;
      box-sizing: border-box;
    }

    .status {
      text-align: center;
      margin-top: 20px;
      color: #333;
    }
  </style>
</head>
<body>

  <nav>
  <div class="nav-container">
    <div class="nav-left">
      <img src="../assets/Boop-Logo.png" alt="BOOP Logo" />
    </div>
    <div class="nav-right">
      <a href="index.html">Dashboard</a>
      <div class="nav-dropdown">
        <a href="#" class="dropbtn" style="color: white;">Add</a>
        <div class="dropdown-content">
          <a href="add-user.html">Add User</a>
          <a href="assign-card.html">Assign Card</a>
          <a href="assign-transit-card.html">Transit Card</a>
          <a href="assign-student.html">Assign Student</a>
        </div>
      </div>
      <a href="view-users.html">View Users</a>
      <a href="#" id="logoutBtn">Log Out</a>
    </div>
  </div>
</nav>

<div class="container-small">
  <h3>Assign Transit Card</h3>

  <!-- Card UID -->
  <div class="input-group">
    <label>Card UID</label>
    <input type="text" id="cardUID" placeholder="Auto-generated" readonly />
    <button type="button" id="generateUIDBtn">Generate</button>
  </div>

  <!-- User Type -->
  <div class="input-group">
    <label for="userTypeSelect">User Type</label>
    <select id="userTypeSelect">
      <option value="">-- Select user type --</option>
      <option value="existing">Assign to Existing User</option>
      <option value="temporary">Temporary User</option>
    </select>
  </div>

  <!-- Search User -->
  <div class="input-group" id="userSearchGroup" style="display: none;">
    <label for="userSearch">Search User</label>
    <input type="text" id="userSearch" placeholder="Search name or email..." autocomplete="off" />
    <div id="userSuggestions" style="border: 1px solid #ccc; display: none;"></div>
  </div>

  <!-- Transit Category -->
  <div class="input-group">
    <label for="passType">Transit Category</label>
    <select id="passType">
      <option value="">-- Select Category --</option>
      <option value="token">Tokens</option>
      <option value="ticket">Tickets</option>
      <option value="pass">Passes</option>
    </select>
  </div>

  <!-- Product Select -->
  <div class="input-group">
    <label for="productSelect">Transit Product</label>
    <select id="productSelect">
      <option value="">-- Select a product --</option>
    </select>
  </div>

  <!-- Price Display -->
  <div class="input-group">
    <label for="productPrice">Cost (BMD)</label>
    <input type="text" id="productPrice" readonly />
  </div>

  <!-- Assign Button -->
  <button id="assignBtn">Assign Transit Card</button>
  <div class="status" id="status"></div>
</div>

<script type="module">
const uidEl = document.getElementById("cardUID");
const generateBtn = document.getElementById("generateUIDBtn");
const assignBtn = document.getElementById("assignBtn");
const passType = document.getElementById("passType");
const productSelect = document.getElementById("productSelect");
const userSearch = document.getElementById("userSearch");
const userGroup = document.getElementById("userSearchGroup");
const suggestions = document.getElementById("userSuggestions");
const userTypeSelect = document.getElementById("userTypeSelect");
const statusEl = document.getElementById("status");

let selectedUser = null;

const productOptions = {
  token: [
    { label: "3 Zone Token – Adult", value: "3_zone_token_adult" },
    { label: "14 Zone Token – Motorcycle", value: "14_zone_token_motorcycle" }
  ],
  ticket: [
    { label: "3 Zone Tickets (Booklet)", value: "3_zone_ticket_booklet" },
    { label: "All Zone Tickets – Child", value: "all_zone_ticket_child" }
  ],
  pass: [
    { label: "1 Day Pass – Adult", value: "1_day_pass_adult" },
    { label: "7 Day Pass – Child", value: "7_day_pass_child" },
    { label: "Monthly Pass – Adult", value: "monthly_pass_adult" }
  ]
};

generateBtn.addEventListener("click", () => {
  uidEl.value = crypto.randomUUID().slice(0, 12).replace(/-/g, "").toUpperCase();
});

passType.addEventListener("change", () => {
  const type = passType.value;
  productSelect.innerHTML = `<option value="">Select a transit item</option>`;
  if (productOptions[type]) {
    productOptions[type].forEach(opt => {
      const option = document.createElement("option");
      option.value = opt.value;
      option.textContent = opt.label;
      productSelect.appendChild(option);
    });
  }
});

userTypeSelect.addEventListener("change", () => {
  if (userTypeSelect.value === "existing") {
    userGroup.style.display = "block";
  } else {
    userGroup.style.display = "none";
    selectedUser = null;
    userSearch.value = "";
  }
});

userSearch.addEventListener("input", async () => {
  const query = userSearch.value.trim();
  if (query.length < 2) {
    suggestions.style.display = "none";
    return;
  }
  const res = await fetch(`/api/users?search=${encodeURIComponent(query)}&hasWallet=true`);
  const users = await res.json();
  suggestions.innerHTML = users.length
    ? users.map(u => `
        <div class="user-suggestion" data-id="${u.id}" data-wallet="${u.wallet_id}">
          ${u.first_name} ${u.last_name} (${u.email})
        </div>
      `).join("")
    : "<div>No users found</div>";
  suggestions.style.display = "block";
});

suggestions.addEventListener("click", e => {
  const item = e.target.closest(".user-suggestion");
  if (!item) return;
  selectedUser = {
    id: item.dataset.id,
    wallet_id: item.dataset.wallet
  };
  userSearch.value = item.textContent;
  suggestions.style.display = "none";
});

document.addEventListener("click", (e) => {
  if (!suggestions.contains(e.target) && e.target !== userSearch) {
    suggestions.style.display = "none";
  }
});

assignBtn.addEventListener("click", async () => {
  const uid = uidEl.value.trim();
  const type = passType.value;
  const value = productSelect.value;
  const admin = JSON.parse(localStorage.getItem("boopUser"));

  if (!uid || !type || !value || !admin?.id) {
    statusEl.textContent = "Missing required fields.";
    statusEl.style.color = "red";
    return;
  }

  const body = {
    uid,
    product_type: type,
    product_code: value,
    issued_by: admin.id,
    type: "transit"
  };

  if (userTypeSelect.value === "existing") {
    if (!selectedUser?.wallet_id) {
      statusEl.textContent = "Please select a valid user.";
      statusEl.style.color = "red";
      return;
    }
    body.wallet_id = selectedUser.wallet_id;
  } else {
    body.temporary_user = { email: `guest-${Date.now()}@boop.local` };
  }

  try {
    const res = await fetch("/api/cards", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body)
    });
    const result = await res.json();
    if (res.ok) {
      statusEl.textContent = "✅ Transit card assigned!";
      statusEl.style.color = "green";
      uidEl.value = "";
      userSearch.value = "";
      selectedUser = null;
    } else {
      statusEl.textContent = `❌ ${result.error || "Assignment failed."}`;
      statusEl.style.color = "red";
    }
  } catch (err) {
    console.error(err);
    statusEl.textContent = "❌ Server error occurred.";
    statusEl.style.color = "red";
  }
});
</script>

</body>
</html>
