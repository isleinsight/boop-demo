<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Assign Card - BOOP Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../assets/styles.css" />
  <style>
    :root { --ink:#1a2b4a; --muted:#6b7280; --stroke:#e6ebf1; }

    /* Container */
    .container-small{
      max-width: 760px;
      margin: 28px auto 60px;
      padding: 0 20px;
    }
    h1{ font-family:'Poppins',sans-serif; color:var(--ink); margin:0 0 8px; }
    .sub{ color:#4b5563; margin:0 0 20px; }

    /* Form */
    label{ display:block; margin:14px 0 6px; color:var(--ink); font-weight:600; }
    input, select{
      width:100%; box-sizing:border-box;
      padding:12px 14px; border:1px solid var(--stroke); border-radius:8px;
      font-size:0.95rem; background:#fff;
    }
    input:focus, select:focus{ outline:none; border-color:#2f80ed; }

    .row{ display:grid; grid-template-columns:1fr 1fr; gap:14px; }
    @media (max-width:720px){ .row{ grid-template-columns:1fr; } }

    .hint{ color:var(--muted); font-size:0.9rem; margin-top:6px; }

    button.primary{
      margin-top:20px; width:100%;
      background:#2f80ed; color:#fff; border:0; border-radius:8px;
      padding:12px 16px; font-weight:600; cursor:pointer;
      transition:background .2s ease;
    }
    button.primary:hover{ background:#1c6fd8; }
    button.primary:disabled{ opacity:.6; cursor:not-allowed; }

    .status{
      display:none; margin-top:14px; padding:12px 14px; border-radius:8px; font-size:.95rem; text-align:center;
    }
    .status.show{ display:block; }
    .status.success{ background:#f0fdf4; color:#166534; border:1px solid #bbf7d0; }
    .status.error{ background:#fef2f2; color:#991b1b; border:1px solid #fecaca; }

    /* ── Navigation (same pattern as dashboard) ───────────────────────── */
    nav{ background:var(--ink); }
    .nav-container{
      display:flex; align-items:center; gap:16px; justify-content:flex-start;
      position:relative; padding:10px 20px; min-height:60px; box-sizing:border-box;
    }
    .nav-left img{ height:34px; display:block; }
    .nav-right{ display:flex; gap:20px; margin-left:auto; }
    .nav-right a{ color:#fff; text-decoration:none; }

    .nav-dropdown{ position:relative; display:inline-block; }
    .dropbtn{ padding:10px 16px; color:#fff; text-decoration:none; }
    .dropdown-content{
      display:none; position:absolute; background:#fff; min-width:160px;
      border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,.15); z-index:1;
    }
    .dropdown-content a{
      color:#333; padding:12px 16px; display:block; text-decoration:none; font-size:.95rem;
    }
    .dropdown-content a:hover{ color:#2f80ed; }
    .nav-dropdown:hover .dropdown-content{ display:block; }

    /* Hamburger */
    .hamburger{
      display:none; margin-left:auto; width:28px; height:22px; padding:0; border:0; background:transparent; cursor:pointer;
      display:flex; flex-direction:column; justify-content:space-between;
    }
    .hamburger span{ display:block; width:100%; height:3px; background:#fff; border-radius:1px; transition:all .3s ease; }
    .hamburger.active span:nth-child(1){ transform:rotate(45deg) translate(5px,5px); }
    .hamburger.active span:nth-child(2){ opacity:0; }
    .hamburger.active span:nth-child(3){ transform:rotate(-45deg) translate(7px,-7px); }

    @media (max-width:768px){
      .hamburger{ display:flex; }
      .nav-right{ display:none; }
      .nav-right.active{
        display:flex; flex-direction:column; position:fixed; top:0; right:0; width:260px; height:100%;
        padding:80px 20px; background:#fff; box-shadow:-4px 0 12px rgba(0,0,0,.15); gap:12px; z-index:1000;
      }
      .nav-right.active a{ color:#333; }
      .dropdown-content{ position:static; background:none; box-shadow:none; display:none; }
      .nav-right.active .dropdown-content.active{ display:block; }
      .nav-dropdown:hover .dropdown-content{ display:none; }
    }
  </style>
</head>
<body>
  <!-- Top Nav -->
  <nav>
    <div class="nav-container">
      <div class="nav-left">
        <img src="../assets/Boop-Logo.png" alt="BOOP Logo" />
      </div>
      <button class="hamburger" aria-label="Toggle navigation">
        <span></span><span></span><span></span>
      </button>
      <div class="nav-right">
        <a href="index.html">Dashboard</a>
        <a href="admin-actions.html">Admin Actions</a>
        <div class="nav-dropdown">
          <a href="#" class="dropbtn">Add</a>
          <div class="dropdown-content">
            <a href="add-user.html" id="addUserLink">Add User</a>
            <a href="assign-card.html" id="assignCardLink">Assign Card</a>
            <a href="assign-student.html">Assign Student</a>
          </div>
        </div>
        <a href="view-users.html">View Users</a>
        <a href="#" id="logoutBtn">Log Out</a>
      </div>
    </div>
  </nav>

  <div class="container-small">
    <h1>Assign Card</h1>
    <p class="sub">Link a physical card UID to a user. You can target by <strong>User ID</strong> (preferred) or by <strong>Email</strong>.</p>

    <form id="assignForm" novalidate>
      <div class="row">
        <div>
          <label for="userId">User ID</label>
          <input type="text" id="userId" placeholder="e.g. 172c05b7-..." />
          <div class="hint">If provided, email is ignored.</div>
        </div>
        <div>
          <label for="email">Email (optional)</label>
          <input type="email" id="email" placeholder="user@example.com" />
        </div>
      </div>

      <label for="cardUid">Card UID</label>
      <input type="text" id="cardUid" required placeholder="Scan or paste card UID" />

      <div class="row">
        <div>
          <label for="cardType">Card Type</label>
          <select id="cardType" required>
            <option value="">Select type</option>
            <option value="transit">Transit</option>
            <option value="spending">Spending</option>
          </select>
        </div>
        <div>
          <label for="note">Note (optional)</label>
          <input type="text" id="note" placeholder="Internal note" />
        </div>
      </div>

      <button type="submit" class="primary" id="assignBtn">Assign Card</button>
      <div id="status" class="status" role="alert"></div>
    </form>
  </div>

  <script>
    // --- Auth gate: only super_admin/admin can access this page
    const me = JSON.parse(localStorage.getItem("boopUser"));
    const canManageUsers = me && me.role === "admin" && (me.type === "super_admin" || me.type === "admin");
    if (!canManageUsers) {
      window.location.href = "login.html";
    }

    // Hide Add menu entirely for non-managers (defensive, in case someone bookmarks)
    if (!canManageUsers) {
      const addMenu = document.querySelector(".nav-dropdown");
      if (addMenu) addMenu.style.display = "none";
    }

    // Logout
    document.getElementById("logoutBtn")?.addEventListener("click", async (e) => {
      e.preventDefault();
      try { await fetch("/logout", { method: "POST" }); } catch {}
      localStorage.removeItem("boop_jwt");
      localStorage.removeItem("boopUser");
      window.location.href = "login.html";
    });

    // Mobile nav
    (function mobileNav(){
      const hamburger = document.querySelector(".hamburger");
      const navRight  = document.querySelector(".nav-right");
      const dropbtn   = document.querySelector(".nav-dropdown .dropbtn");
      const dropdown  = document.querySelector(".dropdown-content");

      hamburger?.addEventListener("click", () => {
        const active = hamburger.classList.toggle("active");
        navRight.classList.toggle("active", active);
        hamburger.setAttribute("aria-expanded", active ? "true" : "false");
      });

      dropbtn?.addEventListener("click", (e) => {
        if (window.innerWidth <= 768) {
          e.preventDefault();
          dropdown?.classList.toggle("active");
        }
      });

      navRight?.querySelectorAll("a").forEach(a => {
        a.addEventListener("click", () => {
          hamburger?.classList.remove("active");
          navRight.classList.remove("active");
          dropdown?.classList.remove("active");
        });
      });
    })();

    // --- Assign form logic
    const API_PATH = "/api/cards/assign"; // <-- change if your backend uses a different endpoint
    const form   = document.getElementById("assignForm");
    const status = document.getElementById("status");
    const btn    = document.getElementById("assignBtn");

    function showStatus(msg, ok){
      status.textContent = msg;
      status.className = "status show " + (ok ? "success" : "error");
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      status.className = "status"; status.textContent = "";

      const token   = localStorage.getItem("boop_jwt");
      const user_id = document.getElementById("userId").value.trim();
      const email   = document.getElementById("email").value.trim().toLowerCase();
      const card_uid= document.getElementById("cardUid").value.trim();
      const type    = document.getElementById("cardType").value;
      const note    = document.getElementById("note").value.trim();

      if (!card_uid || !type){
        showStatus("Card UID and Card Type are required.", false);
        return;
      }
      if (!user_id && !email){
        showStatus("Provide either a User ID or an Email.", false);
        return;
      }

      const payload = { card_uid, type };
      if (user_id) payload.user_id = user_id;
      else payload.email = email;
      if (note) payload.note = note;

      btn.disabled = true;

      try{
        const res = await fetch(API_PATH, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${token}`
          },
          body: JSON.stringify(payload)
        });

        if (!res.ok){
          const text = await res.text();
          throw new Error(text || "Assignment failed");
        }

        const data = await res.json().catch(()=>({}));
        showStatus("✅ Card assigned successfully.", true);

        // Optional: clear only card fields, keep user field
        document.getElementById("cardUid").value = "";
        document.getElementById("cardType").value = "";
        document.getElementById("note").value = "";

        // If API returns the assigned card, you could show it here.
        console.log("Assigned:", data);

      } catch(err){
        console.error(err);
        showStatus("❌ " + (err.message || "Assignment failed."), false);
      } finally{
        btn.disabled = false;
      }
    });
  </script>
</body>
</html>
