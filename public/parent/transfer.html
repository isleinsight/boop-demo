<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Parent Transfer – BOOP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <meta name="description" content="Request a transfer from your student's BOOP wallet to a bank account." />
  <style>
    :root{
      --ink:#0b1220; --muted:#6b7280; --blue:#2f80ed; --blue-dark:#1c6fd8;
      --bg:#f5f8fb; --panel:#ffffff; --stroke:#e5e7eb; --soft:#f8fafc;
      --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{ margin:0; font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background:var(--bg); color:#1f2937; }

    /* HEADER (dark strip w/ logo) */
    .site-head{ background:#0b1220; }
    .site-head__inner{ max-width:1100px; margin:0 auto; padding:12px 18px; }
    .brand{ display:flex; align-items:center; gap:10px; }
    .brand img{ height:32px; display:block; }

    /* SUBBAR (matches Parent Portal index) */
    .subbar{ background:#eef2f7; border-bottom:1px solid var(--stroke); }
    .subbar__inner{ max-width:1100px; margin:0 auto; padding:10px 16px; display:flex; align-items:center; justify-content:space-between; gap:10px;}
    .subnav-left{ display:flex; gap:14px; flex-wrap:wrap; }
    .subnav-left a{ color:#111827; text-decoration:none; font-weight:600; padding:6px 10px; border-radius:8px; }
    .subnav-left a.active{ background:#e5e7eb; }
    .logout-link{ font-weight:600; color:#2f80ed; text-decoration:underline; }

    /* PAGE HEADER */
    .header{ max-width:1100px; margin:18px auto 0; padding:0 18px; }
    .header h1{ margin:16px 0 6px; font-size:clamp(22px,3vw,28px); color:#111827; }
    .sub{ color:var(--muted); margin:0; }

    /* LAYOUT */
    .container{ max-width:1100px; margin:16px auto 40px; padding:0 18px; }
    .grid{ display:grid; grid-template-columns:1.1fr .9fr; gap:16px; align-items:start; }
    @media (max-width: 900px){ .grid{ grid-template-columns:1fr; } }

    /* CARDS + FORM */
    .card{
      background:var(--panel); border:1px solid var(--stroke); border-radius:14px; padding:18px;
      box-shadow:0 8px 24px rgba(0,0,0,.06);
    }
    .card h2{ margin:0 0 10px; font-size:1.12rem; color:#111827; }
    label{ display:block; color:var(--muted); font-size:.92rem; margin:10px 0 6px; }
    input, select{
      width:100%; padding:12px; border-radius:10px; border:1px solid var(--stroke);
      background:#fff; color:#111827; font-size:1rem;
    }
    input:disabled, select:disabled{ opacity:.75; }

    .row{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .row > div{ flex:1; min-width:220px; }

    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      padding:12px 16px; border-radius:10px; text-decoration:none; font-weight:700;
      border:1px solid transparent; cursor:pointer;
    }
    .btn.primary{ background:var(--blue); color:#fff; border-color:var(--blue); }
    .btn.primary:hover{ background:var(--blue-dark); border-color:var(--blue-dark); }
    .btn.ghost{ background:#fff; border:1px solid var(--stroke); color:#111827; }
    .btn.ghost:hover{ border-color:#cbd5e1; }

    .summary{ border:1px dashed var(--stroke); border-radius:12px; padding:12px; background:var(--soft); margin-top:10px; }
    .summary .line{ display:flex; justify-content:space-between; margin:6px 0; }

    .alert{ padding:10px 12px; border-radius:10px; border:1px solid var(--stroke); background:#f9fafb; display:none; }
    .alert.ok{ border-color:#dcfce7; background:#f0fdf4; color:#166534; display:block; }
    .alert.bad{ border-color:#fee2e2; background:#fef2f2; color:#991b1b; display:block; }
    .help{ font-size:.9rem; color:var(--muted); margin-top:8px; }

    footer{padding:22px;color:#6b7280;text-align:center;margin-top:20px}
    footer a{color:#2f80ed;text-decoration:none;font-weight:600}
  </style>
</head>
<body>

  <!-- Header -->
  <header class="site-head">
    <div class="site-head__inner">
      <a class="brand" href="../index.html" aria-label="BOOP home">
        <img src="../assets/Boop-Logo.png" alt="BOOP Logo" />
      </a>
    </div>
  </header>

  <!-- Subbar (Home • Transfer • Logout) -->
  <div class="subbar">
    <div class="subbar__inner">
      <nav class="subnav-left" aria-label="Parent navigation">
        <a href="index.html">Home</a>
        <a href="transfer.html" class="active" aria-current="page">Transfer</a>
      </nav>
      <a href="#" id="logoutBtn" class="logout-link">Log out</a>
    </div>
  </div>

  <!-- Page header -->
  <header class="header">
    <h1>Request a bank transfer</h1>
    <p class="sub">Move money from a student’s BOOP wallet to a linked bank account.</p>
  </header>

  <!-- Main -->
  <main class="container">
    <div id="flash" class="alert"></div>

    <div class="grid">
      <!-- Left: Request form -->
      <section class="card">
        <h2>Create request</h2>

        <!-- Choose student first -->
        <label for="studentSelect">Student</label>
        <select id="studentSelect"><option>Loading…</option></select>

        <!-- Destination bank -->
        <label for="destination">Destination account</label>
        <select id="destination"></select>
        <div class="help">Saved accounts are masked for your security.</div>
        <button id="addBankBtn" class="btn ghost" type="button" style="margin-top:8px;">Add bank</button>

        <!-- Amount + memo -->
        <label for="amount">Amount (BMD)</label>
        <input id="amount" type="number" step="0.01" min="0.01" placeholder="0.00" />

        <label for="memo">Memo (optional)</label>
        <input id="memo" type="text" maxlength="80" placeholder="e.g., Return remaining funds" />

        <!-- Preview -->
        <div class="summary" id="previewBox" style="display:none;">
          <div class="line"><span>Amount</span><strong id="pAmount">—</strong></div>
          <div class="line"><span>Fees</span><strong id="pFee">$0.00</strong></div>
          <div class="line"><span>Net to bank</span><strong id="pNet">—</strong></div>
          <div class="line"><span>Arrival estimate</span><strong id="pArrival">1–2 business days</strong></div>
        </div>

        <div class="row" style="margin-top:12px;">
          <button id="reviewBtn" class="btn primary" disabled>Review request</button>
          <div id="formMsg" class="help"></div>
        </div>
      </section>

      <!-- Right: Balance + latest -->
      <section class="card">
        <h2>Wallet</h2>
        <div class="summary">
          <div class="line"><span>Student</span><strong id="studentName">—</strong></div>
          <div class="line"><span>Available</span><strong id="balanceTxt">—</strong></div>
        </div>

        <h2 style="margin-top:16px;">Latest request</h2>
        <p class="help" style="margin-top:-4px; margin-bottom:8px;">
          Pending amounts aren’t deducted until the transfer is completed.
        </p>
        <div id="latestBox" class="help">No requests yet.</div>
      </section>
    </div>
  </main>

  <!-- Review Modal -->
  <div id="reviewModal" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:1000;">
    <div style="background:#fff;color:#111827;border:1px solid #e5e7eb;border-radius:12px;padding:18px;max-width:480px;width:92%;">
      <h3 style="margin:0 0 10px;">Confirm request</h3>
      <div class="summary" style="background:#f8fafc;border-color:#e5e7eb;">
        <div class="line"><span>Student</span><strong id="mStudent">—</strong></div>
        <div class="line"><span>To</span><strong id="mTo">—</strong></div>
        <div class="line"><span>Amount</span><strong id="mAmount">—</strong></div>
        <div class="line"><span>Fees</span><strong id="mFee">$0.00</strong></div>
        <div class="line"><span>Net</span><strong id="mNet">—</strong></div>
        <div class="line"><span>Arrival</span><strong id="mArrival">1–2 business days</strong></div>
        <div class="line"><span>Memo</span><strong id="mMemo">—</strong></div>
      </div>
      <div class="row" style="margin-top:12px;">
        <button id="confirmBtn" class="btn primary">Submit request</button>
        <button id="cancelBtn" class="btn ghost">Cancel</button>
        <div id="modalMsg" class="help"></div>
      </div>
    </div>
  </div>

  <footer>
    © <span id="year"></span> BOOP. All rights reserved.
    &nbsp;•&nbsp; <a href="../terms.html">Terms &amp; Conditions</a>
    &nbsp;•&nbsp; <a href="../privacy.html">Privacy Policy</a>
  </footer>

  <script>
    // Year
    document.getElementById('year').textContent = new Date().getFullYear();

    (function(){
      // --- Auth guard (parent only) ---
      const token = localStorage.getItem('boop_jwt');
      if (!token) { window.location.href = '../index.html'; return; }

      // --- Elements ---
      const logoutBtn = document.getElementById('logoutBtn');

      const studentSelect = document.getElementById('studentSelect');
      const studentName = document.getElementById('studentName');
      const destination = document.getElementById('destination');
      const addBankBtn = document.getElementById('addBankBtn');

      const amountEl = document.getElementById('amount');
      const memoEl = document.getElementById('memo');

      const previewBox = document.getElementById('previewBox');
      const pAmount = document.getElementById('pAmount');
      const pFee = document.getElementById('pFee');
      const pNet = document.getElementById('pNet');
      const pArrival = document.getElementById('pArrival');

      const reviewBtn = document.getElementById('reviewBtn');
      const formMsg = document.getElementById('formMsg');

      const reviewModal = document.getElementById('reviewModal');
      const mStudent = document.getElementById('mStudent');
      const mTo = document.getElementById('mTo');
      const mAmount = document.getElementById('mAmount');
      const mFee = document.getElementById('mFee');
      const mNet = document.getElementById('mNet');
      const mArrival = document.getElementById('mArrival');
      const mMemo = document.getElementById('mMemo');
      const confirmBtn = document.getElementById('confirmBtn');
      const cancelBtn = document.getElementById('cancelBtn');
      const modalMsg = document.getElementById('modalMsg');

      const balanceTxt = document.getElementById('balanceTxt');
      const latestBox = document.getElementById('latestBox');
      const flash = document.getElementById('flash');

      // --- State ---
      let parentId = null;
      let students = [];
      let currentStudentId = null;
      let currentWalletId = null;
      let balanceCents = 0;
      let banks = [];
      let selectedBank = null;

      // --- Helpers ---
      function dollars(c){ return `$${(Number(c||0)/100).toFixed(2)}`; }
      function showFlash(msg, ok=true){
        flash.textContent = msg;
        flash.className = "alert " + (ok ? "ok" : "bad");
        flash.style.display = "block";
        setTimeout(()=> flash.style.display = "none", 4000);
      }
      async function fetchJSON(url, opts = {}){
        const res = await fetch(url, {
          ...opts,
          headers:{
            'Content-Type':'application/json',
            'Authorization':`Bearer ${token}`,
            ...(opts.headers||{})
          }
        });
        if (!res.ok) throw new Error(await res.text().catch(()=> 'HTTP error'));
        return res.json();
      }

      // --- Logout ---
      logoutBtn?.addEventListener('click', async (e)=>{
        e.preventDefault();
        try {
          const me = JSON.parse(localStorage.getItem('boopUser') || '{}');
          if (me.id && token) {
            await fetch(`/api/users/${me.id}/signout`, { method:'POST', headers:{ Authorization:`Bearer ${token}` } }).catch(()=>{});
          }
        } finally {
          localStorage.removeItem('boop_jwt');
          localStorage.removeItem('boopUser');
          sessionStorage.clear();
          window.location.href = '../index.html';
        }
      });

      // --- Load parent + students ---
      async function loadMe(){
        const me = await fetchJSON('/api/me');
        if ((me.role || '').toLowerCase() !== 'parent'){ window.location.href='../index.html'; return; }
        parentId = me.id;
      }
      async function loadAssignedStudents(){
        const detail = await fetchJSON(`/api/users/${parentId}`);
        students = detail.assigned_students || [];
        studentSelect.innerHTML = students.length
          ? students.map(s => `<option value="${s.id}">${(s.first_name||'') + ' ' + (s.last_name||'')}</option>`).join('')
          : '<option>No students linked</option>';
        if (students.length) selectStudent(students[0].id);
      }

      async function selectStudent(studentId){
        currentStudentId = studentId;
        const stu = await fetchJSON(`/api/users/${studentId}`);
        currentWalletId = stu.wallet_id || null;
        const full = `${stu.first_name||''} ${stu.last_name||''}`.trim() || 'Student';
        studentName.textContent = full;
        await Promise.all([loadBalance(), loadBanks(), loadLatest()]);
        updatePreview();
      }
      studentSelect.addEventListener('change', (e)=> selectStudent(e.target.value));

      // --- Balance for selected student ---
      async function loadBalance(){
        if (!currentStudentId){ balanceCents = 0; balanceTxt.textContent = '—'; return; }
        try{
          const j = await fetchJSON(`/api/wallets/user/${currentStudentId}`);
          balanceCents = Number(j?.balance_cents||0);
          balanceTxt.textContent = dollars(balanceCents);
        }catch{ balanceCents = 0; balanceTxt.textContent = '—'; }
      }

      // --- Parent's saved bank accounts (yours or shared endpoint) ---
      async function loadBanks(){
        destination.innerHTML = `<option disabled selected>Loading…</option>`;
        try{
          const j = await fetchJSON('/api/bank-accounts/mine');
          banks = Array.isArray(j) ? j : [];
          if (!banks.length){
            destination.innerHTML = `<option disabled selected>No bank accounts yet</option>`;
            selectedBank = null;
            return;
          }
          destination.innerHTML = banks.map(b => `<option value="${b.id}">${b.bank_name} •••• ${b.last4}</option>`).join('');
          selectedBank = banks[0]?.id || null;
        }catch{
          destination.innerHTML = `<option disabled selected>Failed to load</option>`;
        }
      }
      destination.addEventListener('change', (e)=> selectedBank = e.target.value);

      // Add Bank modal (simple inline version for now)
      const addBankModal = document.createElement('div');
      addBankModal.style.cssText = 'position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:1000;';
      addBankModal.innerHTML = `
        <div style="background:#fff;color:#111827;border:1px solid #e5e7eb;border-radius:12px;padding:18px;max-width:520px;width:92%;">
          <h3 style="margin:0 0 10px;">Add bank account</h3>
          <label style="display:block;color:#6b7c93;font-size:.92rem;margin:10px 0 6px;">Bank</label>
          <select id="abBank" style="width:100%;padding:12px;border-radius:10px;border:1px solid #e5e7eb;">
            <option value="Butterfield">Butterfield (Bank of N.T. Butterfield & Son)</option>
            <option value="HSBC Bermuda">HSBC Bermuda</option>
            <option value="Clarien Bank">Clarien Bank</option>
          </select>
          <label style="display:block;color:#6b7c93;font-size:.92rem;margin:10px 0 6px;">Account holder name</label>
          <input id="abHolder" type="text" placeholder="Full name on account" style="width:100%;padding:12px;border-radius:10px;border:1px solid #e5e7eb;">
          <label style="display:block;color:#6b7c93;font-size:.92rem;margin:10px 0 6px;">Account number</label>
          <input id="abAccount" type="text" inputmode="numeric" placeholder="e.g. 0123456789" style="width:100%;padding:12px;border-radius:10px;border:1px solid #e5e7eb;">
          <div id="abMsg" class="help" style="margin-top:8px;"></div>
          <div class="row" style="margin-top:12px;">
            <button id="abSave" class="btn primary">Save bank</button>
            <button id="abCancel" class="btn ghost">Cancel</button>
          </div>
        </div>
      `;
      document.body.appendChild(addBankModal);

      function openAddBank(){ addBankModal.style.display='flex'; }
      function closeAddBank(){ addBankModal.style.display='none'; }
      addBankBtn.addEventListener('click', openAddBank);
      addBankModal.addEventListener('click', (e)=>{ if (e.target === addBankModal) closeAddBank(); });
      addBankModal.querySelector('#abCancel').addEventListener('click', closeAddBank);
      addBankModal.querySelector('#abSave').addEventListener('click', async ()=>{
        const abMsg = addBankModal.querySelector('#abMsg');
        const holder = addBankModal.querySelector('#abHolder').value.trim();
        const bank = addBankModal.querySelector('#abBank').value;
        const account = addBankModal.querySelector('#abAccount').value.trim();
        if (!holder || !bank || !account){ abMsg.textContent='Please fill in all fields.'; return; }
        try{
          const res = await fetch('/api/bank-accounts', {
            method:'POST',
            headers:{ 'Content-Type':'application/json', Authorization:`Bearer ${token}` },
            body: JSON.stringify({ holder_name: holder, bank_name: bank, account_number: account })
          });
          const saved = await res.json();
          if (!res.ok) throw new Error(saved.message || 'Failed to add bank.');
          closeAddBank();
          showFlash('Bank account saved.', true);
          await loadBanks();
        }catch(e){ abMsg.textContent = e.message || 'Could not save bank.'; }
      });

      // Preview calculation
      function updatePreview(){
        const amt = Number(amountEl.value);
        if (!currentWalletId || !selectedBank || !amt || amt <= 0){
          previewBox.style.display='none'; reviewBtn.disabled = true; return;
        }
        if (amt*100 > balanceCents){
          formMsg.textContent = "Amount exceeds available balance.";
          reviewBtn.disabled = true;
          previewBox.style.display = 'none';
          return;
        }
        formMsg.textContent = "";
        const fee = 0;
        pAmount.textContent = dollars(amt*100);
        pFee.textContent = dollars(fee);
        pNet.textContent = dollars(amt*100 - fee);
        pArrival.textContent = "1–2 business days";
        previewBox.style.display = 'block';
        reviewBtn.disabled = false;
      }
      amountEl.addEventListener('input', updatePreview);

      // Review modal open/close
      reviewBtn.addEventListener('click', ()=>{
        const s = students.find(x => x.id === currentStudentId);
        const b = banks.find(x => x.id === selectedBank);
        if (!s || !b) return;
        mStudent.textContent = `${s.first_name||''} ${s.last_name||''}`.trim() || 'Student';
        mTo.textContent = `${b.bank_name} •••• ${b.last4}`;
        mAmount.textContent = pAmount.textContent;
        mFee.textContent = pFee.textContent;
        mNet.textContent = pNet.textContent;
        mArrival.textContent = pArrival.textContent;
        mMemo.textContent = memoEl.value || "—";
        reviewModal.style.display='flex';
      });
      cancelBtn.addEventListener('click', ()=> reviewModal.style.display='none');

      // Submit transfer (backend must accept student context)
      function randomKey(){ return 'ikey_' + Math.random().toString(36).slice(2) + Date.now().toString(36); }
      document.getElementById('confirmBtn').addEventListener('click', async ()=>{
        confirmBtn.disabled = true; modalMsg.textContent = "Submitting…";
        try{
          const amtCents = Math.round(Number(amountEl.value) * 100);
          const res = await fetch('/api/transfers', {
            method:'POST',
            headers:{
              'Content-Type':'application/json',
              'X-Idempotency-Key': randomKey(),
              Authorization:`Bearer ${token}`
            },
            body: JSON.stringify({
              student_user_id: currentStudentId,   // <- make sure your backend reads this for parents
              bank_account_id: selectedBank,
              amount_cents: amtCents,
              memo: memoEl.value || ""
            })
          });
          const json = await res.json();
          if (!res.ok) throw new Error(json.message || 'Request failed.');
          reviewModal.style.display='none';
          showFlash('Transfer request submitted for review.', true);
          amountEl.value = ""; memoEl.value = ""; updatePreview();
          loadLatest(); loadBalance();
        }catch(e){
          modalMsg.textContent = e.message || "Error";
        }finally{
          confirmBtn.disabled = false;
        }
      });

      // Latest (optional)
      async function loadLatest(){
        try{
          const j = await fetchJSON(`/api/transfers/mine/latest?student=${encodeURIComponent(currentStudentId)}`);
          if (!j || !j.id){ latestBox.textContent = "No requests yet."; return; }
          latestBox.innerHTML = `
            <div class="summary">
              <div class="line"><span>Requested</span><strong>${new Date(j.created_at).toLocaleString()}</strong></div>
              <div class="line"><span>Amount</span><strong>${dollars(j.amount_cents)}</strong></div>
              <div class="line"><span>Status</span><strong>${(j.status||'submitted')}</strong></div>
            </div>
          `;
        }catch{ latestBox.textContent = "No requests yet."; }
      }

      // Init
      (async function init(){
        try{
          const me = await fetchJSON('/api/me');
          if ((me.role || '').toLowerCase() !== 'parent'){ throw new Error('Not a parent'); }
          localStorage.setItem('boopUser', JSON.stringify(me));
          await loadMe();
          await loadAssignedStudents();
        }catch{
          localStorage.clear();
          window.location.href = '../index.html';
        }
      })();

    })();
  </script>
</body>
</html>
