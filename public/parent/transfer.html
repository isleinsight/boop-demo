<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Parent Transfer — BOOP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Parents can request a transfer of remaining student funds to their bank." />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --ink:#0b1220; --boop:#2f80ed; --boop-dark:#1c6fd8; --muted:#6b7280; --text:#1f2937;
      --stroke:#e5e7eb; --bg:#f5f8fb; --card:#ffffff; --ok:#10b981; --warn:#f59e0b; --danger:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    a{color:var(--boop);text-decoration:underline}
    img{max-width:100%;display:block}

    /* Header with logo only (same pattern as your Parent pages) */
    .site-head{background:#0b1220}
    .site-head__inner{max-width:1120px;margin:0 auto;padding:12px 16px}
    .brand{display:flex;align-items:center;gap:10px}
    .brand img{height:28px}

    /* Subbar with links under the header */
    .subbar{background:#eef2f7;border-bottom:1px solid var(--stroke)}
    .subbar__inner{max-width:1120px;margin:0 auto;padding:10px 16px;display:flex;gap:18px;justify-content:flex-end;flex-wrap:wrap}
    .subbar__inner a{font-weight:600;text-decoration:underline;color:#1c6fd8}

    /* Page layout */
    .wrap{max-width:1120px;margin:0 auto;padding:16px}
    .page-head{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-wrap:wrap;margin:6px 0 14px}
    .page-head h1{margin:0;font-size:clamp(22px,3vw,28px)}
    .sub{margin:6px 0 0;color:var(--muted)}

    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:16px;align-items:start}
    @media (max-width: 900px){ .grid{grid-template-columns:1fr} }

    /* Cards */
    .card{background:var(--card);border:1px solid var(--stroke);border-radius:14px;box-shadow:0 8px 24px rgba(16,24,40,.06)}
    .card__head{padding:12px 14px;border-bottom:1px solid var(--stroke);display:flex;align-items:center;justify-content:space-between;gap:10px}
    .card__body{padding:14px}
    .pill{font-size:.8rem;background:#eef2ff;color:#374151;border-radius:999px;padding:4px 10px;border:1px solid #dbeafe;white-space:nowrap}

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .select,input,select.input{width:100%;padding:12px 14px;border:1px solid var(--stroke);border-radius:10px;outline:none;font-size:.95rem;background:#fff}
    .select{min-width:220px}
    .input:focus,.select:focus{border-color:var(--boop)}

    .btn{display:inline-flex;align-items:center;justify-content:center;font-weight:700;border-radius:10px;border:1px solid transparent;cursor:pointer;padding:10px 14px}
    .btn.primary{background:var(--boop);color:#fff}
    .btn.primary:hover{background:var(--boop-dark)}
    .btn.ghost{background:#fff;border:1px solid var(--stroke);color:#111827}
    .btn.ghost:hover{border-color:#cbd5e1}

    .summary{border:1px dashed var(--stroke);border-radius:12px;padding:12px;background:#f8fafc;margin-top:10px}
    .summary .line{display:flex;justify-content:space-between;margin:6px 0}

    .alert{padding:10px 12px;border-radius:10px;border:1px solid var(--stroke);background:#f9fafb;display:none}
    .alert.ok{border-color:#dcfce7;background:#f0fdf4;color:#166534;display:block}
    .alert.bad{border-color:#fee2e2;background:#fef2f2;color:#991b1b;display:block}

    .muted{color:var(--muted)}
    .spacer{height:32px}

    /* Modal */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:1000;padding:16px}
    .modal__card{background:#fff;color:#111827;border:1px solid #e5e7eb;border-radius:12px;box-shadow:0 20px 50px rgba(0,0,0,.15);padding:18px;max-width:520px;width:100%}
    .modal h3{margin:0 0 10px;font-size:1.1rem}

    footer{padding:22px;color:#6b7280;text-align:center;margin-top:20px}
    footer a{color:#1c6fd8;text-decoration:underline;font-weight:600}
  </style>
</head>
<body>
  <!-- Header with logo only -->
  <header class="site-head">
    <div class="site-head__inner">
      <div class="brand">
        <a href="/index.html" aria-label="BOOP home"><img src="/assets/Boop-Logo.png" alt="BOOP Logo" /></a>
      </div>
    </div>
  </header>

  <!-- Subbar with Logout + Transfer link -->
  <div class="subbar">
    <div class="subbar__inner">
      <a href="/parent/index.html">Parent Portal</a>
      <a href="/parent/transfer.html" aria-current="page">Transfer</a>
      <a href="#" id="logoutBtn">Log out</a>
    </div>
  </div>

  <main class="wrap">
    <div class="page-head">
      <div>
        <h1>Transfer remaining student funds</h1>
        <p class="sub">Move money from a student’s BOOP wallet to your saved bank account.</p>
      </div>
    </div>

    <div id="flash" class="alert"></div>

    <section class="grid">
      <!-- LEFT: form -->
      <div class="card">
        <div class="card__head">
          <strong>Create request</strong>
          <span id="studentSchoolPill" class="pill" style="display:none"></span>
        </div>
        <div class="card__body">
          <div class="row">
            <label for="studentSelect" style="font-weight:600">Student</label>
            <select id="studentSelect" class="select" aria-label="Choose student">
              <option>Loading…</option>
            </select>
          </div>

          <div style="margin-top:10px">
            <label for="bankSelect" style="font-weight:600">Destination account</label>
            <select id="bankSelect" class="select"></select>
            <div class="muted" style="margin-top:6px">Saved accounts are masked for your security.</div>
            <button id="addBankBtn" class="btn ghost" type="button" style="margin-top:8px">Add bank</button>
          </div>

          <div style="margin-top:10px">
            <label for="amount" style="font-weight:600">Amount (BMD)</label>
            <input id="amount" class="input" type="number" inputmode="decimal" min="0.01" step="0.01" placeholder="0.00" />
          </div>

          <div style="margin-top:10px">
            <label for="memo" style="font-weight:600">Memo (optional)</label>
            <input id="memo" class="input" type="text" maxlength="80" placeholder="e.g., Transfer after graduation" />
          </div>

          <div id="previewBox" class="summary" style="display:none">
            <div class="line"><span>Amount</span><strong id="pAmount">—</strong></div>
            <div class="line"><span>Fees</span><strong id="pFee">$0.00</strong></div>
            <div class="line"><span>Net to bank</span><strong id="pNet">—</strong></div>
            <div class="line"><span>Arrival estimate</span><strong id="pArrival">1–2 business days</strong></div>
          </div>

          <div class="row" style="margin-top:12px">
            <button id="reviewBtn" class="btn primary" disabled>Review request</button>
            <div id="formMsg" class="muted"></div>
          </div>
        </div>
      </div>

      <!-- RIGHT: balances / latest -->
      <aside class="card">
        <div class="card__head"><strong>Overview</strong></div>
        <div class="card__body">
          <div class="summary">
            <div class="line"><span>Student</span><strong id="studentName">—</strong></div>
            <div class="line"><span>Available balance</span><strong id="balanceTxt">—</strong></div>
            <div id="freezeLine" class="line" style="display:none"><span>Status</span><strong id="freezeTxt">—</strong></div>
          </div>

          <h3 style="margin:16px 0 6px;font-size:1.05rem">Latest request</h3>
          <p class="muted" style="margin-top:0">Pending amounts are not deducted until the transfer is completed.</p>
          <div id="latestBox" class="muted">No requests yet.</div>
        </div>
      </aside>
    </section>

    <div class="spacer"></div>
  </main>

  <!-- Review Modal -->
  <div id="reviewModal" class="modal" aria-hidden="true">
    <div class="modal__card" role="dialog" aria-modal="true">
      <h3>Confirm transfer</h3>
      <div class="summary" style="background:#f8fafc;border-color:#e5e7eb">
        <div class="line"><span>Student</span><strong id="mStudent">—</strong></div>
        <div class="line"><span>To</span><strong id="mTo">—</strong></div>
        <div class="line"><span>Amount</span><strong id="mAmount">—</strong></div>
        <div class="line"><span>Fees</span><strong id="mFee">$0.00</strong></div>
        <div class="line"><span>Net</span><strong id="mNet">—</strong></div>
        <div class="line"><span>Arrival</span><strong id="mArrival">1–2 business days</strong></div>
        <div class="line"><span>Memo</span><strong id="mMemo">—</strong></div>
      </div>
      <div class="row" style="margin-top:12px">
        <button id="confirmBtn" class="btn primary">Submit request</button>
        <button id="cancelBtn" class="btn ghost">Cancel</button>
        <div id="modalMsg" class="muted"></div>
      </div>
    </div>
  </div>

  <!-- Add Bank Modal -->
  <div id="addBankModal" class="modal" aria-hidden="true">
    <div class="modal__card" role="dialog" aria-modal="true">
      <h3>Add bank account</h3>

      <label style="display:block;font-weight:600;margin-top:6px">Bank</label>
      <select id="abBank" class="select">
        <option value="Butterfield">Butterfield (Bank of N.T. Butterfield & Son)</option>
        <option value="HSBC Bermuda">HSBC Bermuda</option>
        <option value="Clarien Bank">Clarien Bank</option>
      </select>

      <label style="display:block;font-weight:600;margin-top:10px">Account holder name</label>
      <input id="abHolder" class="input" type="text" placeholder="Full name on account">

      <label style="display:block;font-weight:600;margin-top:10px">Account number</label>
      <input id="abAccount" class="input" type="text" inputmode="numeric" placeholder="e.g. 0123456789">

      <div id="abMsg" class="muted" style="margin-top:8px"></div>

      <div class="row" style="margin-top:12px">
        <button id="abSave" class="btn primary">Save bank</button>
        <button id="abCancel" class="btn ghost">Cancel</button>
      </div>
    </div>
  </div>

  <footer>
    © <span id="year"></span> BOOP. All rights reserved.
    &nbsp;•&nbsp; <a href="/terms.html">Terms &amp; Conditions</a> &nbsp;•&nbsp; <a href="/privacy.html">Privacy Policy</a>
  </footer>

  <script>
    // ===== Config: choose the POST route style you implemented =====
    const API_PARENT_TRANSFER_STYLE = "student-path"; // "student-path" OR "generic-body"
    // "student-path" -> POST /api/transfers/students/:studentId
    // "generic-body" -> POST /api/transfers with { source_user_id: <studentId>, ... }

    // ===== Utilities =====
    const token = localStorage.getItem('boop_jwt');
    function dollars(c){ return 'BMD $' + (Number(c||0)/100).toFixed(2); }
    function idek(){ return 'ikey_' + Math.random().toString(36).slice(2) + Date.now().toString(36); }
    function show(el){ el.style.display = ''; }
    function hide(el){ el.style.display = 'none'; }
    function setFlash(msg, ok=true){
      const flash = document.getElementById('flash');
      flash.textContent = msg;
      flash.className = 'alert ' + (ok ? 'ok' : 'bad');
      flash.style.display = 'block';
      setTimeout(()=> flash.style.display = 'none', 4000);
    }
    async function getJSON(url){
      const res = await fetch(url, { headers:{ 'Authorization':'Bearer '+token }});
      if(!res.ok) throw new Error(await res.text().catch(()=> 'HTTP '+res.status));
      return res.json();
    }
    async function postJSON(url, body){
      const res = await fetch(url, {
        method:'POST',
        headers:{ 'Content-Type':'application/json','Authorization':'Bearer '+token, 'X-Idempotency-Key': idek() },
        body: JSON.stringify(body || {})
      });
      const json = await res.json().catch(()=> ({}));
      if(!res.ok) throw new Error(json.message || ('HTTP '+res.status));
      return json;
    }

    // ===== Auth guard (Parent only) =====
    (async function guard(){
      if(!token){ window.location.href = '/index.html'; return; }
      try{
        const me = await getJSON('/api/me');
        if ((me.role||'').toLowerCase() !== 'parent'){
          localStorage.clear();
          window.location.href = '/index.html';
          return;
        }
        localStorage.setItem('boopUser', JSON.stringify(me));
      }catch{
        localStorage.clear();
        window.location.href = '/index.html';
      }
    })();

    // ===== Elements =====
    const yearEl = document.getElementById('year');
    yearEl.textContent = new Date().getFullYear();

    const logoutBtn = document.getElementById('logoutBtn');
    logoutBtn?.addEventListener('click', async (e)=>{
      e.preventDefault();
      try{
        const me = JSON.parse(localStorage.getItem('boopUser')||'{}');
        if (me.id && token){
          await fetch('/api/users/'+me.id+'/signout', { method:'POST', headers:{ 'Authorization':'Bearer '+token } }).catch(()=>{});
        }
      } finally {
        localStorage.removeItem('boop_jwt');
        localStorage.removeItem('boopUser');
        sessionStorage.clear();
        window.location.href = '/index.html';
      }
    });

    const studentSelect = document.getElementById('studentSelect');
    const studentSchoolPill = document.getElementById('studentSchoolPill');
    const studentNameEl = document.getElementById('studentName');
    const balanceTxt = document.getElementById('balanceTxt');
    const freezeLine = document.getElementById('freezeLine');
    const freezeTxt = document.getElementById('freezeTxt');

    const bankSelect = document.getElementById('bankSelect');
    const addBankBtn = document.getElementById('addBankBtn');

    const amountEl = document.getElementById('amount');
    const memoEl = document.getElementById('memo');
    const previewBox = document.getElementById('previewBox');
    const pAmount = document.getElementById('pAmount');
    const pFee = document.getElementById('pFee');
    const pNet = document.getElementById('pNet');
    const pArrival = document.getElementById('pArrival');
    const reviewBtn = document.getElementById('reviewBtn');
    const formMsg = document.getElementById('formMsg');

    const latestBox = document.getElementById('latestBox');

    // Review modal
    const reviewModal = document.getElementById('reviewModal');
    const mStudent = document.getElementById('mStudent');
    const mTo = document.getElementById('mTo');
    const mAmount = document.getElementById('mAmount');
    const mFee = document.getElementById('mFee');
    const mNet = document.getElementById('mNet');
    const mArrival = document.getElementById('mArrival');
    const mMemo = document.getElementById('mMemo');
    const confirmBtn = document.getElementById('confirmBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const modalMsg = document.getElementById('modalMsg');

    // Add bank modal
    const addBankModal = document.getElementById('addBankModal');
    const abBank = document.getElementById('abBank');
    const abHolder = document.getElementById('abHolder');
    const abAccount = document.getElementById('abAccount');
    const abMsg = document.getElementById('abMsg');
    const abSave = document.getElementById('abSave');
    const abCancel = document.getElementById('abCancel');

    // ===== State =====
    let parentId = null;
    let students = [];
    let currentStudentId = null;
    let currentStudent = null;
    let balanceCents = 0;
    let banks = [];
    let selectedBankId = null;

    // ===== Loaders =====
    async function loadParentAndStudents(){
      const me = await getJSON('/api/me');
      parentId = me.id;

      const detail = await getJSON(`/api/users/${parentId}`);
      students = detail.assigned_students || [];
      renderStudentOptions();
      if (students.length){
        selectStudent(students[0].id);
      } else {
        studentSelect.innerHTML = '<option>No students linked</option>';
        setFlash('No students linked to this parent account.', false);
      }
    }

    function renderStudentOptions(){
      studentSelect.innerHTML = students.map(s => {
        const full = `${s.first_name||''} ${s.last_name||''}`.trim() || 'Student';
        return `<option value="${s.id}">${full}</option>`;
      }).join('');
      studentSelect.onchange = ()=> selectStudent(studentSelect.value);
    }

    async function selectStudent(studentId){
      currentStudentId = studentId;
      currentStudent = await getJSON(`/api/users/${studentId}`);

      const fullName = `${currentStudent.first_name||''} ${currentStudent.last_name||''}`.trim() || 'Student';
      studentNameEl.textContent = fullName;

      const prof = currentStudent.student_profile || {};
      if (prof.school_name){
        studentSchoolPill.textContent = `School: ${prof.school_name}`;
        studentSchoolPill.style.display = 'inline-block';
      } else {
        studentSchoolPill.style.display = 'none';
      }

      await loadBalance();
      await loadLatest();
      updatePreview(); // in case amount already typed
    }

    async function loadBalance(){
      balanceTxt.textContent = '—';
      try{
        const w = await getJSON(`/api/wallets/user/${currentStudentId}`);
        balanceCents = Number(w.balance_cents||0);
        balanceTxt.textContent = dollars(balanceCents);
        if (typeof w.is_frozen !== 'undefined'){
          if (w.is_frozen){
            freezeTxt.textContent = 'FROZEN';
            show(freezeLine);
          } else {
            hide(freezeLine);
          }
        }
      }catch{
        balanceTxt.textContent = 'Unavailable';
      }
    }

    async function loadBanks(){
      bankSelect.innerHTML = `<option disabled selected>Loading…</option>`;
      try{
        const list = await getJSON('/api/bank-accounts/mine');
        banks = Array.isArray(list) ? list : [];
        if(!banks.length){
          bankSelect.innerHTML = `<option disabled selected>No bank accounts yet</option>`;
          selectedBankId = null;
          return;
        }
        bankSelect.innerHTML = banks.map(b => `<option value="${b.id}">${b.bank_name} •••• ${b.last4}</option>`).join('');
        selectedBankId = banks[0].id;
        bankSelect.onchange = (e)=> selectedBankId = e.target.value;
      }catch{
        bankSelect.innerHTML = `<option disabled selected>Failed to load</option>`;
        selectedBankId = null;
      }
    }

    async function loadLatest(){
      try{
        // You can make a parent-scoped endpoint if you like; here we reuse the same “mine” list but filter in backend by role.
        const r = await fetch(`/api/transfers/mine/latest?student_id=${encodeURIComponent(currentStudentId)}`, {
          headers:{ 'Authorization':'Bearer '+token }
        });
        if(!r.ok){ latestBox.textContent = 'No requests yet.'; return; }
        const j = await r.json();
        if(!j || !j.id){ latestBox.textContent = 'No requests yet.'; return; }
        latestBox.innerHTML = `
          <div class="summary">
            <div class="line"><span>Requested</span><strong>${new Date(j.created_at).toLocaleString()}</strong></div>
            <div class="line"><span>Amount</span><strong>${dollars(j.amount_cents)}</strong></div>
            <div class="line"><span>Status</span><strong>${(j.status||'submitted')}</strong></div>
          </div>
        `;
      }catch{ latestBox.textContent = 'No requests yet.'; }
    }

    // ===== Add bank modal =====
    function openAddBank(){ abMsg.textContent=''; abHolder.value=''; abAccount.value=''; document.getElementById('addBankModal').style.display='flex'; }
    function closeAddBank(){ document.getElementById('addBankModal').style.display='none'; }
    addBankBtn.addEventListener('click', openAddBank);
    abCancel.addEventListener('click', closeAddBank);
    document.getElementById('addBankModal').addEventListener('click', (e)=>{ if (e.target === e.currentTarget) closeAddBank(); });

    abSave.addEventListener('click', async ()=>{
      abMsg.textContent='';
      const holder = abHolder.value.trim();
      const bank = abBank.value;
      const account = abAccount.value.trim();
      if(!holder || !bank || !account){ abMsg.textContent='Please fill in all fields.'; return; }
      try{
        const saved = await postJSON('/api/bank-accounts', {
          holder_name: holder, bank_name: bank, account_number: account
        });
        closeAddBank();
        setFlash('Bank account saved.', true);
        await loadBanks();
      }catch(e){ abMsg.textContent = e.message || 'Could not save bank.'; }
    });

    // ===== Preview + Review modal =====
    function updatePreview(){
      const amt = Number(amountEl.value);
      const cents = Math.round((Number.isFinite(amt) ? amt : 0) * 100);
      if (!selectedBankId || !cents || cents <= 0){
        hide(previewBox); reviewBtn.disabled = true; return;
      }
      if (cents > balanceCents){
        formMsg.textContent = 'Amount exceeds available balance.';
        hide(previewBox); reviewBtn.disabled = true; return;
      }
      formMsg.textContent = '';
      pAmount.textContent = dollars(cents);
      pFee.textContent = dollars(0);
      pNet.textContent = dollars(cents);
      pArrival.textContent = '1–2 business days';
      show(previewBox);
      reviewBtn.disabled = false;
    }
    amountEl.addEventListener('input', updatePreview);

    reviewBtn.addEventListener('click', ()=>{
      const stu = students.find(s => s.id === currentStudentId);
      const bank = banks.find(b => b.id === selectedBankId);
      if (!stu || !bank) return;
      mStudent.textContent = `${(stu.first_name||'') +' '+ (stu.last_name||'')}`.trim() || 'Student';
      mTo.textContent = `${bank.bank_name} •••• ${bank.last4}`;
      mAmount.textContent = pAmount.textContent;
      mFee.textContent = pFee.textContent;
      mNet.textContent = pNet.textContent;
      mArrival.textContent = pArrival.textContent;
      mMemo.textContent = memoEl.value || '—';
      document.getElementById('reviewModal').style.display = 'flex';
    });
    cancelBtn.addEventListener('click', ()=> document.getElementById('reviewModal').style.display='none');

    // ===== Submit transfer =====
    confirmBtn.addEventListener('click', async ()=>{
      confirmBtn.disabled = true; modalMsg.textContent = 'Submitting…';
      const amt = Number(amountEl.value);
      const amount_cents = Math.round((Number.isFinite(amt) ? amt : 0) * 100);
      try{
        let json;
        if (API_PARENT_TRANSFER_STYLE === 'student-path'){
          json = await postJSON(`/api/transfers/students/${encodeURIComponent(currentStudentId)}`, {
            bank_account_id: selectedBankId,
            amount_cents,
            memo: memoEl.value || ''
          });
        } else {
          json = await postJSON(`/api/transfers`, {
            source_user_id: currentStudentId,   // <- tells backend to debit the student’s wallet
            bank_account_id: selectedBankId,
            amount_cents,
            memo: memoEl.value || ''
          });
        }
        document.getElementById('reviewModal').style.display='none';
        amountEl.value=''; memoEl.value=''; updatePreview();
        setFlash('Transfer request submitted for review.', true);
        await Promise.all([loadBalance(), loadLatest()]);
      }catch(e){
        modalMsg.textContent = e.message || 'Request failed.';
      }finally{
        confirmBtn.disabled = false;
      }
    });

    // ===== Init =====
    (async function init(){
      try{
        await Promise.all([loadParentAndStudents(), loadBanks()]);
      }catch(e){
        setFlash('Unable to load your account. Please sign in again.', false);
        console.error(e);
      }
    })();
  </script>
</body>
</html>
