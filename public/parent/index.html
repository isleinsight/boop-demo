<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Parent Portal — BOOP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Parents can track spending, add funds, and manage their child's BOOP Card." />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../assets/styles.css" />
  <style>
    :root{
      --ink:#0b1220; --boop:#2f80ed; --boop-dark:#1c6fd8; --muted:#6b7280; --text:#1f2937;
      --stroke:#e5e7eb; --bg:#f5f8fb; --card:#ffffff; --ok:#10b981; --warn:#f59e0b; --danger:#ef4444;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}

    /* NAV */
    .nav{background:#0b1220;}
    .nav__inner{max-width:1120px;margin:0 auto;padding:12px 18px;display:flex;align-items:center}
    .nav__brand img{height:32px;display:block}

    /* NEW logout bar */
    .logout-bar{
      margin: 10px 0 18px;
      text-align: right;
    }
    .logout-bar a{
      color: var(--boop-dark);
      font-weight: 600;
      text-decoration: underline;
    }
    .logout-bar a:hover{color:var(--boop)}

    /* LAYOUT */
    .wrap{max-width:1120px;margin:0 auto;padding:24px 18px}
    .layout{display:grid;grid-template-columns:2fr 1fr;gap:18px;align-items:start}
    @media (max-width:900px){ .layout{grid-template-columns:1fr} }

    .card{background:var(--card);border:1px solid var(--stroke);border-radius:14px;box-shadow:0 10px 24px rgba(16,24,40,.06)}
    .card__head{padding:14px 16px;border-bottom:1px solid var(--stroke);display:flex;align-items:center;justify-content:space-between;gap:10px}
    .card__body{padding:16px}

    .pill{font-size:.8rem;background:#eef2ff;color:#374151;border-radius:999px;padding:4px 10px;border:1px solid #dbeafe}

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .select{padding:10px 12px;border:1px solid var(--stroke);border-radius:10px;background:#fff;font-size:.95rem;min-width:220px}

    .balance{display:flex;align-items:center;gap:16px;flex-wrap:wrap}
    .balance__amount{font-size:2rem;font-weight:700;color:var(--ink)}
    .balance__status{color:var(--muted);font-size:.95rem}

    .actions{display:flex;gap:8px;flex-wrap:wrap}

    table{width:100%;border-collapse:collapse}
    th, td{padding:12px 10px;border-bottom:1px solid var(--stroke);text-align:left}
    th{font-weight:600;color:#374151}
    td.small{color:var(--muted);font-size:.92rem}
    .tag{display:inline-block;padding:4px 8px;border-radius:999px;font-size:.8rem;font-weight:600;background:#eef2ff;color:#1f2937;border:1px solid #dbeafe}
    .empty{color:var(--muted);text-align:center;padding:30px 8px}

    .pager{display:flex;justify-content:flex-end;gap:8px;padding-top:10px}
    .pager button{border:1px solid var(--stroke);background:#fff;color:#111827;border-radius:8px;padding:8px 10px;cursor:pointer}
    .pager button:disabled{opacity:.5;cursor:not-allowed}

    .summary h3{margin:0 0 6px}
    .summary p{margin:0;color:var(--muted)}

    .controls .row{align-items:center}
    .controls label{display:block;font-weight:600;margin-bottom:6px}
    .input, select.input{width:100%;padding:12px 14px;border:1px solid var(--stroke);border-radius:10px;outline:none;font-size:.95rem}
    .input:focus{border-color:var(--boop)}

    .switch{display:flex;align-items:center;gap:10px;margin:6px 0}
    .switch input{transform:scale(1.1)}

    .msg{font-size:.92rem;margin-top:6px;display:none}
    .msg.error{color:var(--danger)} .msg.ok{color:var(--ok)}

    .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.45);z-index:50;padding:16px}
    .modal__card{width:100%;max-width:520px;background:#fff;border-radius:14px;border:1px solid var(--stroke);box-shadow:0 20px 50px rgba(0,0,0,.15);overflow:hidden}
    .modal__head{padding:14px 16px;border-bottom:1px solid var(--stroke);display:flex;align-items:center;justify-content:space-between}
    .modal__body{padding:16px;display:grid;gap:12px}
    .modal__foot{padding:14px 16px;border-top:1px solid var(--stroke);display:flex;gap:10px;justify-content:flex-end}
    .close{background:#f3f4f6;border:1px solid var(--stroke);color:#111827;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer}

    footer{padding:22px;color:#6b7280;text-align:center;margin-top:20px}
    footer a{color:var(--boop);text-decoration:none;font-weight:600}
  </style>
</head>
<body>
  <!-- NAV -->
  <header class="nav">
    <div class="nav__inner nav-container">
      <div class="nav__brand nav-left">
        <img src="../assets/Boop-Logo.png" alt="BOOP Logo" />
      </div>
    </div>
  </header>

  <!-- LOGOUT bar -->
  <main class="wrap">
    <div class="logout-bar">
      <a href="#" id="logoutBtn">Log Out</a>
    </div>

    <section class="layout">
      <!-- LEFT -->
      <div>
        <div class="card" id="studentCard">
          <div class="card__head">
            <div class="row">
              <strong>Student</strong>
              <select id="studentSelect" class="select" aria-label="Choose student">
                <option>Loading…</option>
              </select>
            </div>
            <span id="schoolPill" class="pill" style="display:none"></span>
          </div>
          <div class="card__body">
            <div class="balance">
              <div class="balance__amount" id="balanceAmount">—</div>
              <div class="balance__status" id="balanceStatus">Balance</div>
            </div>
            <div class="actions" style="margin-top:12px">
              <button id="addFundsBtn" class="btn-primary" type="button">Add Funds</button>
              <a id="freezeBtn" class="btn-light" href="javascript:void(0)">Freeze Card</a>
            </div>
            <div id="balanceMsg" class="msg" aria-live="polite"></div>
          </div>
        </div>

        <div class="card" style="margin-top:16px">
          <div class="card__head">
            <strong>Recent activity</strong>
            <span class="pill" id="activityCountPill" style="display:none"></span>
          </div>
          <div class="card__body" id="activityWrap">
            <div class="empty" id="activityEmpty">No recent transactions.</div>
            <div style="overflow:auto">
              <table id="activityTable" style="display:none">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Merchant</th>
                    <th>Category</th>
                    <th>Amount</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody id="activityTbody"></tbody>
              </table>
            </div>
            <div class="pager">
              <button id="prevPage">Prev</button>
              <button id="nextPage">Next</button>
            </div>
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <aside>
        <div class="card summary">
          <div class="card__head"><strong>Overview</strong></div>
          <div class="card__body">
            <h3 id="studentName">—</h3>
            <p id="studentInfo" class="small">Loading student details…</p>
            <p id="cardStatus" class="small" style="margin-top:6px;color:var(--muted)"></p>
          </div>
        </div>

        <div class="card controls" style="margin-top:16px">
          <div class="card__head"><strong>Controls</strong></div>
          <div class="card__body">
            <div>
              <label for="limitInput">Monthly spending limit (BMD)</label>
              <input id="limitInput" class="input" type="number" inputmode="decimal" min="0" step="0.01" placeholder="e.g. 150.00" />
              <div style="display:flex;gap:8px;margin-top:10px">
                <button id="saveLimitBtn" class="btn-primary" type="button">Save limit</button>
                <button id="clearLimitBtn" class="btn-light" type="button">Clear</button>
              </div>
              <div id="limitMsg" class="msg" aria-live="polite"></div>
            </div>

            <hr style="border:none;border-top:1px solid var(--stroke);margin:16px 0">

            <div>
              <label>Category safeguards</label>
              <div class="switch"><input id="cat_food" type="checkbox"> <span>Allow: Groceries & Essentials</span></div>
              <div class="switch"><input id="cat_fastfood" type="checkbox"> <span>Allow: Fast food</span></div>
              <div class="switch"><input id="cat_electronics" type="checkbox"> <span>Allow: Electronics</span></div>
              <div class="switch"><input id="cat_entertainment" type="checkbox"> <span>Allow: Entertainment</span></div>
              <div class="switch"><input id="cat_other" type="checkbox"> <span>Allow: Other</span></div>
              <div style="display:flex;gap:8px;margin-top:10px">
                <button id="saveCatsBtn" class="btn-primary" type="button">Save categories</button>
                <button id="resetCatsBtn" class="btn-light" type="button">Reset</button>
              </div>
              <div id="catsMsg" class="msg" aria-live="polite"></div>
            </div>
          </div>
        </div>
      </aside>
    </section>
  </main>

  <!-- Add Funds Modal -->
  <div id="fundsModal" class="modal" aria-hidden="true">
    <div class="modal__card" role="dialog" aria-modal="true" aria-labelledby="fundsTitle">
      <div class="modal__head">
        <strong id="fundsTitle">Add Funds</strong>
        <button class="close" id="closeFunds">Close</button>
      </div>
      <div class="modal__body">
        <label>Amount (BMD)
          <input id="amountInput" class="input" type="number" inputmode="decimal" min="1" step="0.01" placeholder="25.00" />
        </label>
        <label>Note (optional)
          <input id="noteInput" class="input" type="text" placeholder="Top-up for lunches" />
        </label>
        <div id="fundsMsg" class="msg" aria-live="polite"></div>
      </div>
      <div class="modal__foot">
        <button id="confirmFunds" class="btn-primary">Add Funds</button>
      </div>
    </div>
  </div>

  <footer>
    © <span id="year"></span> BOOP. All rights reserved.
    &nbsp;•&nbsp; <a href="/terms.html">Terms</a> &nbsp;•&nbsp; <a href="/privacy.html">Privacy</a>
  </footer>

  <script>
  (function () {
    const yearEl = document.getElementById('year');
    if (yearEl) yearEl.textContent = new Date().getFullYear();

    const token = localStorage.getItem('boop_jwt');
    if (!token) { window.location.href = '../index.html'; return; }

    // --- Logout ---
    const logoutBtn = document.getElementById('logoutBtn');
    if (logoutBtn) {
      logoutBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        try {
          const me = JSON.parse(localStorage.getItem('boopUser') || '{}');
          if (me.id && token) {
            await fetch(`/api/users/${me.id}/signout`, {
              method: 'POST',
              headers: { 'Authorization': `Bearer ${token}` }
            }).catch(() => {});
          }
        } finally {
          localStorage.removeItem('boop_jwt');
          localStorage.removeItem('boopUser');
          sessionStorage.clear();
          window.location.href = '../index.html';
        }
      });
    }

    // … (rest of your script: loadMe, loadAssignedStudents, add funds modal, etc.)
  })();
  </script>
</body>
</html>
