<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Parent Portal — Payulot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Parents can track spending, add funds, and manage their child's Payulot Card." />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --ink:#0b1220; --boop:#2f80ed; --boop-dark:#1c6fd8; --muted:#6b7280; --text:#1f2937;
      --stroke:#e5e7eb; --bg:#f5f8fb; --card:#ffffff; --ok:#10b981; --warn:#f59e0b; --danger:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    img{max-width:100%;display:block}
    a{color:var(--boop)}

    /* Header (logo) */
    .site-head{background:#0b1220}
    .site-head__inner{max-width:1120px;margin:0 auto;padding:12px 16px}
    .brand{display:flex;align-items:center;gap:10px}
    .brand img{height:28px}

    /* Subbar (MATCHES transfer page) */
    .subbar{background:#eef2f7;border-bottom:1px solid var(--stroke)}
    .subbar__inner{
      max-width:1120px;margin:0 auto;padding:10px 16px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .subnav-left{display:flex;gap:14px;flex-wrap:wrap}
    .subnav-left a{
      color:#111827;text-decoration:none;font-weight:600;
      padding:6px 10px;border-radius:8px;
    }
    .subnav-left a.active{background:#e5e7eb}
    .logout-link{font-weight:600;color:#2f80ed;text-decoration:underline}

    /* Main layout */
    .wrap{max-width:1120px;margin:0 auto;padding:16px}
    .grid{display:grid;grid-template-columns:2fr 1fr;gap:16px;align-items:start}
    @media (max-width:1024px){ .grid{grid-template-columns:1.3fr .9fr} }
    @media (max-width:860px){ .grid{grid-template-columns:1fr} }

    /* Cards */
    .card{background:var(--card);border:1px solid var(--stroke);border-radius:14px;box-shadow:0 8px 20px rgba(16,24,40,.06)}
    .card__head{padding:12px 14px;border-bottom:1px solid var(--stroke);display:flex;align-items:center;justify-content:space-between;gap:10px}
    .card__body{padding:14px}
    .pill{font-size:.8rem;background:#eef2ff;color:#374151;border-radius:999px;padding:4px 10px;border:1px solid #dbeafe;white-space:nowrap}

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .select{padding:10px 12px;border:1px solid var(--stroke);border-radius:10px;background:#fff;font-size:.95rem;min-width:220px}

    .balance{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .balance__amount{font-size:2rem;font-weight:700;color:var(--ink)}
    .balance__status{color:var(--muted);font-size:.95rem}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .actions .btn-light{white-space:nowrap}

    .btn-primary{background:var(--boop);color:#fff;border:0;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer}
    .btn-primary:hover{background:var(--boop-dark)}
    .btn-light{background:#fff;color:var(--boop);border:1px solid var(--stroke);border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer}

    .input, select.input{width:100%;padding:12px 14px;border:1px solid var(--stroke);border-radius:10px;outline:none;font-size:.95rem;background:#fff}
    .input:focus{border-color:var(--boop)}
    .msg{font-size:.92rem;margin-top:6px;display:none}
    .msg.error{color:var(--danger)} .msg.ok{color:var(--ok)}

    .empty{color:var(--muted);text-align:center;padding:20px 8px}

    .pager{display:flex;justify-content:flex-end;gap:8px;padding-top:10px}
    .pager button{border:1px solid var(--stroke);background:#fff;color:#111827;border-radius:8px;padding:8px 10px;cursor:pointer}
    .pager button:disabled{opacity:.5;cursor:not-allowed}

    /* Activity feed */
    .activity-feed { display: grid; gap: 10px; }
    .activity-item {
      display: grid; grid-template-columns: 1fr auto; gap: 6px 10px;
      padding: 10px 12px; border: 1px solid var(--stroke); border-radius: 12px; background: #fff;
    }
    .activity-title { font-weight: 600; color: var(--ink); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .activity-amount { font-weight: 700; justify-self: end; }
    .activity-amount.pos { color: var(--ok); }
    .activity-amount.neg { color: var(--danger); }
    .activity-meta { grid-column: 1 / -1; display: flex; flex-wrap: wrap; gap: 8px 14px; font-size: .9rem; color: var(--muted); }
    .activity-tag { padding: 2px 8px; border-radius: 999px; font-size: .8rem; border: 1px solid #dbeafe; background: #eef2ff; color: #1f2937; }
    @media (max-width: 520px){
      .activity-item{ padding: 10px; }
      .activity-title{ font-size: .95rem; }
      .activity-meta{ font-size: .85rem; }
    }

    body{overflow-x:hidden}
    footer{padding:22px;color:#6b7280;text-align:center;margin-top:20px}
    footer a{color:#2f80ed;text-decoration:none;font-weight:600}
  </style>
</head>
<body>
  <!-- Header -->
  <header class="site-head">
    <div class="site-head__inner">
      <a class="brand" href="../index.html" aria-label="Payulot home">
        <img src="../assets/logo-white.png" alt="Payulot Logo" />
      </a>
    </div>
  </header>

  <!-- Subbar (Home • Transfer • Logout) -->
  <div class="subbar">
    <div class="subbar__inner">
      <nav class="subnav-left" aria-label="Parent navigation">
        <a href="index.html" class="active" aria-current="page">Home</a>
        <a href="transfer.html">Transfer</a>
      </nav>
      <a href="#" id="logoutBtn" class="logout-link">Log out</a>
    </div>
  </div>

  <main class="wrap">
    <section class="grid">
      <div>
        <!-- Student & Balance -->
        <div class="card" id="studentCard">
          <div class="card__head">
            <div class="row">
              <strong>Student</strong>
              <select id="studentSelect" class="select"><option>Loading…</option></select>
            </div>
            <span id="schoolPill" class="pill" style="display:none"></span>
          </div>
          <div class="card__body">
            <div class="balance">
              <div>
                <div class="balance__amount" id="balanceAmount">—</div>
                <div class="balance__status" id="balanceStatus">Balance</div>
              </div>
              <div class="actions">
                <button id="addFundsBtn" class="btn-primary" type="button">Add Funds</button>
                <button id="freezeBtn" class="btn-light" type="button">Freeze Card</button>
              </div>
            </div>
            <div id="balanceMsg" class="msg" aria-live="polite"></div>
          </div>
        </div>

        <!-- Activity -->
        <div class="card" style="margin-top:16px">
          <div class="card__head"><strong>Recent activity</strong><span class="pill" id="activityCountPill" style="display:none"></span></div>
          <div class="card__body" id="activityWrap">
            <div class="empty" id="activityEmpty">No recent transactions.</div>
            <div id="activityFeed" class="activity-feed" style="display:none"></div>
            <div class="pager"><button id="prevPage">Prev</button><button id="nextPage">Next</button></div>
          </div>
        </div>
      </div>

      <!-- Right -->
      <aside>
        <!-- Overview -->
        <div class="card summary">
          <div class="card__head"><strong>Overview</strong></div>
          <div class="card__body">
            <h3 id="studentName">—</h3>
            <p id="studentInfo">Loading student details…</p>
            <p id="cardStatus" style="margin-top:6px;color:var(--muted)"></p>
          </div>
        </div>

        <!-- Controls (Limits + Categories) -->
        <div class="card controls" style="margin-top:16px">
          <div class="card__head"><strong>Controls</strong></div>
          <div class="card__body">
            <!-- Monthly Limit -->
            <div style="margin-bottom:14px">
              <label for="limitInput" style="display:block;font-weight:600;margin-bottom:6px">Monthly spending limit (BMD)</label>
              <input id="limitInput" class="input" type="number" inputmode="decimal" min="0" step="0.01" placeholder="e.g. 150.00" />
              <div style="display:flex;gap:8px;margin-top:10px">
                <button id="saveLimitBtn" class="btn-primary" type="button">Save limit</button>
                <button id="clearLimitBtn" class="btn-light" type="button">Clear</button>
              </div>
              <div id="limitMsg" class="msg" aria-live="polite"></div>
            </div>

            <hr style="border:none;border-top:1px solid var(--stroke);margin:12px 0">

            <!-- Category Safeguards -->
            <div>
              <label style="display:block;font-weight:600;margin-bottom:6px">Category safeguards</label>
              <div class="row" style="flex-direction:column;align-items:flex-start">
                <label class="row"><input id="cat_food" type="checkbox" style="transform:scale(1.1)"> <span>Allow: Groceries & Essentials</span></label>
                <label class="row"><input id="cat_fastfood" type="checkbox" style="transform:scale(1.1)"> <span>Allow: Fast food</span></label>
                <label class="row"><input id="cat_electronics" type="checkbox" style="transform:scale(1.1)"> <span>Allow: Electronics</span></label>
                <label class="row"><input id="cat_entertainment" type="checkbox" style="transform:scale(1.1)"> <span>Allow: Entertainment</span></label>
                <label class="row"><input id="cat_other" type="checkbox" style="transform:scale(1.1)"> <span>Allow: Other</span></label>
              </div>
              <div style="display:flex;gap:8px;margin-top:10px">
                <button id="saveCatsBtn" class="btn-primary" type="button">Save categories</button>
                <button id="resetCatsBtn" class="btn-light" type="button">Reset</button>
              </div>
              <div id="catsMsg" class="msg" aria-live="polite"></div>
            </div>
          </div>
        </div>
      </aside>
    </section>
  </main>

  <!-- Add Funds Modal -->
  <div id="fundsModal" class="modal" aria-hidden="true" style="position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.45);z-index:50;padding:16px">
    <div class="modal__card" role="dialog" aria-modal="true" aria-labelledby="fundsTitle" style="width:100%;max-width:520px;background:#fff;border-radius:14px;border:1px solid var(--stroke);box-shadow:0 20px 50px rgba(0,0,0,.15);overflow:hidden">
      <div class="modal__head" style="padding:14px 16px;border-bottom:1px solid var(--stroke);display:flex;align-items:center;justify-content:space-between">
        <strong id="fundsTitle">Add Funds</strong>
        <button class="btn-light" id="closeFunds">Close</button>
      </div>
      <div class="modal__body" style="padding:16px;display:grid;gap:12px">
        <label>Amount (BMD)
          <input id="amountInput" class="input" type="number" inputmode="decimal" min="1" step="0.01" placeholder="25.00" />
        </label>
        <label>Note (optional)
          <input id="noteInput" class="input" type="text" placeholder="Top-up for lunches" />
        </label>
        <div id="fundsMsg" class="msg" aria-live="polite"></div>
      </div>
      <div class="modal__foot" style="padding:14px 16px;border-top:1px solid var(--stroke);display:flex;gap:10px;justify-content:flex-end">
        <button id="confirmFunds" class="btn-primary">Add Funds</button>
      </div>
    </div>
  </div>

  <footer style="padding:22px;color:#6b7280;text-align:center;margin-top:20px">
    © <span id="year"></span> Payulot. All rights reserved.
    &nbsp;•&nbsp; <a href="../terms.html" style="color:#2f80ed;text-decoration:none;font-weight:600">Terms and Conditions</a>
    &nbsp;•&nbsp; <a href="../privacy.html" style="color:#2f80ed;text-decoration:none;font-weight:600">Privacy Policy</a>
  </footer>

<script>
(function () {
  // --- Year ---
  const yearEl = document.getElementById('year');
  if (yearEl) yearEl.textContent = new Date().getFullYear();

  // --- Auth guard ---
  const token = localStorage.getItem('boop_jwt'); // left as-is to avoid breaking existing auth
  if (!token) { window.location.href = '../index.html'; return; }

  // --- State ---
  let parentId = null;
  let students = [];
  let currentStudentId = null;
  let currentWalletId = null;
  let txns = [];
  let page = 0;
  const PAGE_SIZE = 8;

  // --- Refs ---
  const studentSelect = document.getElementById('studentSelect');
  const schoolPill = document.getElementById('schoolPill');
  const studentNameEl = document.getElementById('studentName');
  const studentInfoEl = document.getElementById('studentInfo');
  const cardStatusEl = document.getElementById('cardStatus');

  const balanceAmount = document.getElementById('balanceAmount');
  const balanceStatus = document.getElementById('balanceStatus');
  const balanceMsg = document.getElementById('balanceMsg');

  const activityEmpty = document.getElementById('activityEmpty');
  const activityFeed = document.getElementById('activityFeed');
  const activityCountPill = document.getElementById('activityCountPill');
  const prevBtn = document.getElementById('prevPage');
  const nextBtn = document.getElementById('nextPage');

  const addFundsBtn = document.getElementById('addFundsBtn');
  const fundsModal = document.getElementById('fundsModal');
  const closeFunds = document.getElementById('closeFunds');
  const confirmFunds = document.getElementById('confirmFunds');
  const amountInput = document.getElementById('amountInput');
  const noteInput = document.getElementById('noteInput');
  const fundsMsg = document.getElementById('fundsMsg');

  const limitInput = document.getElementById('limitInput');
  const saveLimitBtn = document.getElementById('saveLimitBtn');
  const clearLimitBtn = document.getElementById('clearLimitBtn');
  const limitMsg = document.getElementById('limitMsg');

  const saveCatsBtn = document.getElementById('saveCatsBtn');
  const resetCatsBtn = document.getElementById('resetCatsBtn');
  const catsMsg = document.getElementById('catsMsg');

  const freezeBtn = document.getElementById('freezeBtn');

  // --- Helpers ---
  function fmtMoney(n) { return (typeof n === 'number' && Number.isFinite(n)) ? ('BMD $' + n.toFixed(2)) : '—'; }
  function fmtDate(iso) { try { return new Date(iso).toLocaleString(); } catch { return iso || '—'; } }

  async function fetchJSON(url, opts = {}) {
    const res = await fetch(url, {
      ...opts,
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`,
        ...(opts.headers || {})
      }
    });
    if (!res.ok) throw new Error(await res.text().catch(()=>'HTTP error'));
    return res.json();
  }

  // --- Data loaders ---
  async function loadMe() {
    const me = await fetchJSON('/api/me');
    if ((me.role || '').toLowerCase() !== 'parent') {
      alert('This portal is for Parent accounts.');
      window.location.href = '/';
      return;
    }
    parentId = me.id;
  }

  async function loadAssignedStudents() {
    const detail = await fetchJSON(`/api/users/${parentId}`);
    students = detail.assigned_students || [];
    renderStudentOptions();
    if (students.length) {
      selectStudent(students[0].id);
    } else {
      if (studentSelect) studentSelect.innerHTML = '<option>No students linked</option>';
      activityEmpty.textContent = 'No students found.';
    }
  }

  function renderStudentOptions() {
    if (!studentSelect) return;
    studentSelect.innerHTML = students.map(s => {
      const full = `${s.first_name || ''} ${s.last_name || ''}`.trim() || 'Student';
      return `<option value="${s.id}">${full}</option>`;
    }).join('');
    studentSelect.onchange = () => selectStudent(studentSelect.value);
  }

  async function selectStudent(studentId) {
    currentStudentId = studentId;
    if (balanceMsg) balanceMsg.style.display = 'none';
    page = 0;

    const stu = await fetchJSON(`/api/users/${studentId}`);
    currentWalletId = stu.wallet_id || null;

    const name = `${stu.first_name || ''} ${stu.last_name || ''}`.trim();
    if (studentNameEl) studentNameEl.textContent = name || 'Student';

    const sProfile = stu.student_profile || {};
    const school = sProfile.school_name ? `School: ${sProfile.school_name}` : '';
    if (schoolPill) {
      schoolPill.style.display = school ? 'inline-block' : 'none';
      schoolPill.textContent = school;
    }
    const grade = sProfile.grade_level ? `Grade: ${sProfile.grade_level}` : '';
    if (studentInfoEl) studentInfoEl.textContent = [grade].filter(Boolean).join(' • ') || '—';

    if (cardStatusEl) cardStatusEl.textContent = (stu.status ? `Card: ${String(stu.status).toUpperCase()}` : '').trim();

    await Promise.all([loadBalance(), loadActivity(), loadControls()]);
  }

  function setFreezeButtonUI(isFrozen) {
    if (!freezeBtn) return;
    freezeBtn.textContent = isFrozen ? 'Unfreeze Card' : 'Freeze Card';
  }

  async function loadBalance() {
    if (balanceAmount) balanceAmount.textContent = '—';
    if (balanceStatus) balanceStatus.textContent = 'Balance';
    if (!currentWalletId) {
      if (balanceMsg) {
        balanceMsg.textContent = 'Balance unavailable (no wallet found).';
        balanceMsg.className = 'msg error';
        balanceMsg.style.display = 'block';
      }
      return;
    }
    try {
      const data = await fetchJSON(`/api/wallets/user/${currentStudentId}`);
      const cents = Number(data.balance_cents ?? 0);
      if (!Number.isFinite(cents)) throw new Error('No balance_cents field');
      const normalized = cents / 100;
      if (balanceAmount) balanceAmount.textContent = fmtMoney(normalized);
      if (balanceStatus) balanceStatus.textContent = 'Balance';

      const frozen = !!data.is_frozen;
      setFreezeButtonUI(frozen);
      if (cardStatusEl) cardStatusEl.textContent = frozen ? 'Card: FROZEN' : 'Card: ACTIVE';

      if (balanceMsg) balanceMsg.style.display = 'none';
    } catch {
      if (balanceMsg) {
        balanceMsg.textContent = 'Balance currently unavailable.';
        balanceMsg.className = 'msg error';
        balanceMsg.style.display = 'block';
      }
    }
  }

  // Activity (compact list)
  async function loadActivity() {
    txns = [];
    page = 0;
    renderActivity();
    if (!currentStudentId) return;

    try {
      const resp = await fetchJSON(`/api/transactions/user/${currentStudentId}?limit=200&offset=0`);
      const list = Array.isArray(resp) ? resp : (resp.transactions || []);
      txns = list.map(t => {
        const cents = Number(t.amount_cents || 0);
        const uid = String(currentStudentId);
        let sign = 1;
        const kind = (t.type || '').toLowerCase();
        if (kind === 'debit' || kind === 'purchase') sign = -1;
        if (kind === 'credit' || kind === 'refund')  sign =  1;
        if (kind === 'transfer') {
          if (String(t.sender_id) === uid)   sign = -1;
          if (String(t.recipient_id) === uid) sign =  1;
        }
        const amount = (cents / 100) * sign;
        const merchant = t.to_display || t.recipient_name || t.sender_name || t.note || '—';
        const category =
          (typeof t.category === 'string' && t.category) ||
          (t.method ? String(t.method).toUpperCase() : 'GENERAL');

        return {
          amount,
          status: (t.status || kind || 'posted').toString().toUpperCase(),
          category,
          merchant,
          created_at: t.created_at
        };
      });
    } catch (e) {
      console.error(e);
      txns = [];
    }
    renderActivity();
  }

  function renderActivity() {
    const total = txns.length;
    if (activityCountPill) {
      activityCountPill.style.display = total ? 'inline-block' : 'none';
      activityCountPill.textContent = `${total} items`;
    }

    const start = page * PAGE_SIZE, end = start + PAGE_SIZE, slice = txns.slice(start, end);
    if (prevBtn) { prevBtn.disabled = page === 0; prevBtn.onclick = () => { if (page > 0) { page--; renderActivity(); } }; }
    if (nextBtn) { nextBtn.disabled = end >= total; nextBtn.onclick = () => { if (end < total) { page++; renderActivity(); } }; }

    if (!slice.length) {
      if (activityEmpty) activityEmpty.style.display = 'block';
      if (activityFeed) activityFeed.style.display = 'none';
      return;
    }
    if (activityEmpty) activityEmpty.style.display = 'none';
    if (activityFeed) activityFeed.style.display = 'grid';

    activityFeed.innerHTML = slice.map(tx => {
      const amt = Number(tx.amount || 0);
      const amtClass = amt < 0 ? 'neg' : 'pos';
      const amtStr = (amt < 0 ? '-' : '+') + ' ' + (typeof amt === 'number' ? `BMD $${Math.abs(amt).toFixed(2)}` : '—');
      const title = tx.merchant || '—';
      const metaBits = [
        tx.created_at ? fmtDate(tx.created_at) : null,
        (tx.status || 'POSTED').toString().toUpperCase(),
        tx.category ? `Category: ${tx.category}` : null
      ].filter(Boolean);
      return `
        <div class="activity-item">
          <div class="activity-title">${title}</div>
          <div class="activity-amount ${amtClass}">${amtStr}</div>
          <div class="activity-meta"><span>${metaBits.join(' • ')}</span></div>
        </div>
      `;
    }).join('');
  }

  // Controls (limits + categories)
  async function loadControls() {
    if (limitMsg) limitMsg.style.display = 'none';
    if (catsMsg) catsMsg.style.display = 'none';

    // Monthly limit
    try {
      const res = await fetchJSON(`/api/students/${currentStudentId}/limits`);
      const monthly = Number(res?.monthly_limit);
      if (Number.isFinite(monthly) && limitInput) limitInput.value = monthly.toFixed(2);
      else if (limitInput) limitInput.value = '';
    } catch {
      if (limitInput) limitInput.value = '';
    }

    // Categories
    try {
      const res = await fetchJSON(`/api/students/${currentStudentId}/categories`);
      const a = res?.allow || {};
      (document.getElementById('cat_food') || {}).checked = !!a.food;
      (document.getElementById('cat_fastfood') || {}).checked = !!a.fastfood;
      (document.getElementById('cat_electronics') || {}).checked = !!a.electronics;
      (document.getElementById('cat_entertainment') || {}).checked = !!a.entertainment;
      (document.getElementById('cat_other') || {}).checked = !!a.other;
    } catch {
      (document.getElementById('cat_food') || {}).checked = true;
      (document.getElementById('cat_fastfood') || {}).checked = false;
      (document.getElementById('cat_electronics') || {}).checked = false;
      (document.getElementById('cat_entertainment') || {}).checked = true;
      (document.getElementById('cat_other') || {}).checked = true;
    }
  }

  if (saveLimitBtn) {
    saveLimitBtn.onclick = async () => {
      if (!limitInput || !limitMsg) return;
      limitMsg.style.display = 'none';
      const val = Number(limitInput.value);
      if (!Number.isFinite(val) || val < 0) {
        limitMsg.textContent = 'Enter a valid amount.';
        limitMsg.className = 'msg error';
        limitMsg.style.display = 'block';
        return;
      }
      try {
        const res = await fetch(`/api/students/${currentStudentId}/limits`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
          body: JSON.stringify({ monthly_limit: val })
        });
        if (!res.ok) throw new Error(await res.text());
        limitMsg.textContent = 'Spending limit saved.';
        limitMsg.className = 'msg ok';
        limitMsg.style.display = 'block';
      } catch {
        limitMsg.textContent = 'Failed to save limit.';
        limitMsg.className = 'msg error';
        limitMsg.style.display = 'block';
      }
    };
  }

  if (clearLimitBtn) {
    clearLimitBtn.onclick = async () => {
      if (!limitInput || !limitMsg) return;
      limitMsg.style.display = 'none';
      try {
        const res = await fetch(`/api/students/${currentStudentId}/limits`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!res.ok) throw new Error(await res.text());
        limitInput.value = '';
        limitMsg.textContent = 'Limit cleared.';
        limitMsg.className = 'msg ok';
        limitMsg.style.display = 'block';
      } catch {
        limitMsg.textContent = 'Failed to clear limit.';
        limitMsg.className = 'msg error';
        limitMsg.style.display = 'block';
      }
    };
  }

  if (saveCatsBtn) {
    saveCatsBtn.onclick = async () => {
      if (!catsMsg) return;
      catsMsg.style.display = 'none';
      const payload = {
        allow: {
          food: (document.getElementById('cat_food') || {}).checked || false,
          fastfood: (document.getElementById('cat_fastfood') || {}).checked || false,
          electronics: (document.getElementById('cat_electronics') || {}).checked || false,
          entertainment: (document.getElementById('cat_entertainment') || {}).checked || false,
          other: (document.getElementById('cat_other') || {}).checked || false
        }
      };
      try {
        const res = await fetch(`/api/students/${currentStudentId}/categories`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
          body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error(await res.text());
        catsMsg.textContent = 'Categories saved.';
        catsMsg.className = 'msg ok';
        catsMsg.style.display = 'block';
      } catch {
        catsMsg.textContent = 'Failed to save categories.';
        catsMsg.className = 'msg error';
        catsMsg.style.display = 'block';
      }
    };
  }

  if (resetCatsBtn) {
    resetCatsBtn.onclick = loadControls;
  }

  // Add Funds modal
  function openFunds() {
    if (fundsModal) { fundsModal.style.display = 'grid'; fundsModal.setAttribute('aria-hidden', 'false'); }
    if (amountInput) amountInput.focus();
  }
  function closeFundsModal() {
    if (fundsModal) { fundsModal.style.display = 'none'; fundsModal.setAttribute('aria-hidden', 'true'); }
    if (fundsMsg) fundsMsg.style.display = 'none';
    if (amountInput) amountInput.value = '';
    if (noteInput) noteInput.value = '';
  }
  if (addFundsBtn) addFundsBtn.onclick = () => { if (!currentWalletId) { alert('Wallet unavailable for this student.'); return; } openFunds(); };
  if (closeFunds) closeFunds.onclick = closeFundsModal;
  if (fundsModal) fundsModal.addEventListener('click', (e) => { if (e.target === fundsModal) closeFundsModal(); });
  if (confirmFunds) {
    confirmFunds.onclick = async () => {
      if (!amountInput || !fundsMsg) return;
      fundsMsg.style.display = 'none';
      const amt = Number(amountInput.value);
      if (!Number.isFinite(amt) || amt <= 0) {
        fundsMsg.textContent = 'Please enter a valid amount.';
        fundsMsg.className = 'msg error';
        fundsMsg.style.display = 'block';
        return;
      }
      confirmFunds.disabled = true; confirmFunds.textContent = 'Processing…';
      try {
        const res = await fetch(`/api/wallets/${currentWalletId}/parent-deposits`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
          body: JSON.stringify({ amount: amt, note: (noteInput && noteInput.value) || null })
        });
        if (!res.ok) throw new Error(await res.text().catch(()=>`HTTP ${res.status}`));
        fundsMsg.textContent = 'Funds added successfully.';
        fundsMsg.className = 'msg ok';
        fundsMsg.style.display = 'block';
        await loadBalance(); await loadActivity();
        setTimeout(closeFundsModal, 900);
      } catch (e) {
        fundsMsg.textContent = 'Failed to add funds.' + (e?.message ? ` (${e.message})` : '');
        fundsMsg.className = 'msg error';
        fundsMsg.style.display = 'block';
      } finally {
        confirmFunds.disabled = false; confirmFunds.textContent = 'Add Funds';
      }
    };
  }

  // Freeze / Unfreeze
  if (freezeBtn) {
    freezeBtn.addEventListener('click', async (e) => {
      e.preventDefault();
      if (!currentWalletId) return;
      const isCurrentlyFrozen = /unfreeze/i.test(freezeBtn.textContent);
      const path = isCurrentlyFrozen
        ? `/api/wallets/${currentWalletId}/unfreeze`
        : `/api/wallets/${currentWalletId}/freeze`;
      let reason = '';
      if (!isCurrentlyFrozen) reason = prompt('Reason for freezing? (optional)') || '';
      freezeBtn.disabled = true;
      try {
        const res = await fetch(path, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
          body: JSON.stringify({ reason })
        });
        if (!res.ok) throw new Error(await res.text().catch(()=> 'HTTP error'));
        await loadBalance(); await loadActivity();
      } catch {
        alert('Failed to update freeze status.');
      } finally {
        freezeBtn.disabled = false;
      }
    });
  }

  // Logout
  const logoutBtn = document.getElementById('logoutBtn');
  if (logoutBtn) {
    logoutBtn.addEventListener('click', async (e) => {
      e.preventDefault();
      try {
        const me = JSON.parse(localStorage.getItem('boopUser') || '{}'); // left as-is
        if (me.id && token) {
          await fetch(`/api/users/${me.id}/signout`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}` }
          }).catch(() => {});
        }
      } finally {
        localStorage.removeItem('boop_jwt'); // left as-is
        localStorage.removeItem('boopUser'); // left as-is
        sessionStorage.clear();
        window.location.href = '../index.html';
      }
    });
  }

  // Init
  (async function init() {
    try {
      await loadMe();
      if (!parentId) return;
      await loadAssignedStudents();
    } catch (e) {
      console.error(e);
      alert('Unable to load your account. Please sign in again.');
      window.location.href = '../index.html';
    }
  })();
})();
</script>
</body>
</html>
