<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Parent Portal — BOOP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Parents can track spending, add funds, and manage their child's BOOP Card." />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --ink:#0b1220; --boop:#2f80ed; --boop-dark:#1c6fd8; --muted:#6b7280; --text:#1f2937;
      --stroke:#e5e7eb; --bg:#f5f8fb; --card:#ffffff; --ok:#10b981; --warn:#f59e0b; --danger:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    img{max-width:100%;display:block}
    a{color:var(--boop);text-decoration:underline}

    /* Header (logo only) */
    .site-head{background:#0b1220}
    .site-head__inner{max-width:1120px;margin:0 auto;padding:12px 16px}
    .brand{display:flex;align-items:center;gap:10px}
    .brand img{height:28px}

    /* Subbar with logout link */
    .subbar{background:#eef2f7;border-bottom:1px solid var(--stroke)}
    .subbar__inner{max-width:1120px;margin:0 auto;padding:10px 16px;display:flex;justify-content:flex-end}
    .logout-link{font-weight:600}

    /* Main layout */
    .wrap{max-width:1120px;margin:0 auto;padding:16px}
    .grid{display:grid;grid-template-columns:2fr 1fr;gap:16px;align-items:start}
    @media (max-width:1024px){ .grid{grid-template-columns:1.3fr .9fr} }
    @media (max-width:860px){ .grid{grid-template-columns:1fr} }

    /* Cards */
    .card{background:var(--card);border:1px solid var(--stroke);border-radius:14px;box-shadow:0 8px 20px rgba(16,24,40,.06)}
    .card__head{padding:12px 14px;border-bottom:1px solid var(--stroke);display:flex;align-items:center;justify-content:space-between;gap:10px}
    .card__body{padding:14px}
    .pill{font-size:.8rem;background:#eef2ff;color:#374151;border-radius:999px;padding:4px 10px;border:1px solid #dbeafe;white-space:nowrap}

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .select{padding:10px 12px;border:1px solid var(--stroke);border-radius:10px;background:#fff;font-size:.95rem;min-width:220px}

    .balance{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .balance__amount{font-size:2rem;font-weight:700;color:var(--ink)}
    .balance__status{color:var(--muted);font-size:.95rem}
    .actions{display:flex;gap:8px;flex-wrap:wrap}

    .btn-primary{background:var(--boop);color:#fff;border:0;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer}
    .btn-primary:hover{background:var(--boop-dark)}
    .btn-light{background:#fff;color:var(--boop);border:1px solid var(--stroke);border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer}

    .input, select.input{width:100%;padding:12px 14px;border:1px solid var(--stroke);border-radius:10px;outline:none;font-size:.95rem;background:#fff}
    .input:focus{border-color:var(--boop)}
    .msg{font-size:.92rem;margin-top:6px;display:none}
    .msg.error{color:var(--danger)} .msg.ok{color:var(--ok)}

    .empty{color:var(--muted);text-align:center;padding:20px 8px}

    .pager{display:flex;justify-content:flex-end;gap:8px;padding-top:10px}
    .pager button{border:1px solid var(--stroke);background:#fff;color:#111827;border-radius:8px;padding:8px 10px;cursor:pointer}
    .pager button:disabled{opacity:.5;cursor:not-allowed}

    /* Compact activity feed */
    .activity-feed { display: grid; gap: 10px; }
    .activity-item {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 6px 10px;
      padding: 10px 12px;
      border: 1px solid var(--stroke);
      border-radius: 12px;
      background: #fff;
    }
    .activity-title { font-weight: 600; color: var(--ink); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .activity-amount { font-weight: 700; justify-self: end; }
    .activity-amount.pos { color: var(--ok); }
    .activity-amount.neg { color: var(--danger); }
    .activity-meta { grid-column: 1 / -1; display: flex; flex-wrap: wrap; gap: 8px 14px; font-size: .9rem; color: var(--muted); }
    .activity-tag { padding: 2px 8px; border-radius: 999px; font-size: .8rem; border: 1px solid #dbeafe; background: #eef2ff; color: #1f2937; }
    @media (max-width: 520px){
      .activity-item{ padding: 10px; }
      .activity-title{ font-size: .95rem; }
      .activity-meta{ font-size: .85rem; }
    }

    .actions .btn-light{white-space:nowrap}
    body{overflow-x:hidden}

    footer{padding:22px;color:#6b7280;text-align:center;margin-top:20px}
    footer a{color:var(--boop);text-decoration:none;font-weight:600}
  </style>
</head>
<body>
  <!-- Header -->
  <header class="site-head">
    <div class="site-head__inner"><div class="brand"><img src="../assets/Boop-Logo.png" alt="BOOP Logo" /></div></div>
  </header>
  <!-- Subbar -->
  <div class="subbar"><div class="subbar__inner"><a href="#" id="logoutBtn" class="logout-link">Log out</a></div></div>

  <main class="wrap">
    <section class="grid">
      <div>
        <!-- Student & Balance -->
        <div class="card" id="studentCard">
          <div class="card__head">
            <div class="row">
              <strong>Student</strong>
              <select id="studentSelect" class="select"><option>Loading…</option></select>
            </div>
            <span id="schoolPill" class="pill" style="display:none"></span>
          </div>
          <div class="card__body">
            <div class="balance">
              <div>
                <div class="balance__amount" id="balanceAmount">—</div>
                <div class="balance__status" id="balanceStatus">Balance</div>
              </div>
              <div class="actions">
                <button id="addFundsBtn" class="btn-primary">Add Funds</button>
                <button id="freezeBtn" class="btn-light">Freeze Card</button>
              </div>
            </div>
            <div id="balanceMsg" class="msg"></div>
          </div>
        </div>
        <!-- Activity -->
        <div class="card" style="margin-top:16px">
          <div class="card__head"><strong>Recent activity</strong><span class="pill" id="activityCountPill" style="display:none"></span></div>
          <div class="card__body" id="activityWrap">
            <div class="empty" id="activityEmpty">No recent transactions.</div>
            <div id="activityFeed" class="activity-feed" style="display:none"></div>
            <div class="pager"><button id="prevPage">Prev</button><button id="nextPage">Next</button></div>
          </div>
        </div>
      </div>
      <!-- Right -->
      <aside>
        <div class="card summary">
          <div class="card__head"><strong>Overview</strong></div>
          <div class="card__body">
            <h3 id="studentName">—</h3>
            <p id="studentInfo">Loading student details…</p>
            <p id="cardStatus" style="margin-top:6px;color:var(--muted)"></p>
          </div>
        </div>
      </aside>
    </section>
  </main>

  <footer>© <span id="year"></span> BOOP. All rights reserved.</footer>

<script>
(function () {
  const yearEl = document.getElementById('year'); if (yearEl) yearEl.textContent = new Date().getFullYear();
  const token = localStorage.getItem('boop_jwt'); if (!token) { window.location.href = '../index.html'; return; }

  let parentId=null,students=[],currentStudentId=null,currentWalletId=null,txns=[],page=0; const PAGE_SIZE=8;
  const studentSelect=document.getElementById('studentSelect'), schoolPill=document.getElementById('schoolPill'),
        studentNameEl=document.getElementById('studentName'), studentInfoEl=document.getElementById('studentInfo'), cardStatusEl=document.getElementById('cardStatus'),
        balanceAmount=document.getElementById('balanceAmount'), balanceStatus=document.getElementById('balanceStatus'), balanceMsg=document.getElementById('balanceMsg'),
        activityEmpty=document.getElementById('activityEmpty'), activityFeed=document.getElementById('activityFeed'), activityCountPill=document.getElementById('activityCountPill'),
        prevBtn=document.getElementById('prevPage'), nextBtn=document.getElementById('nextPage'),
        addFundsBtn=document.getElementById('addFundsBtn'), freezeBtn=document.getElementById('freezeBtn');

  function fmtMoney(n){return (typeof n==='number'&&Number.isFinite(n))?('BMD $'+n.toFixed(2)):'—';}
  async function fetchJSON(url,opts={}){const res=await fetch(url,{...opts,headers:{'Content-Type':'application/json','Authorization':`Bearer ${token}`,...(opts.headers||{})}});if(!res.ok)throw new Error(await res.text().catch(()=> 'HTTP error'));return res.json();}

  async function loadMe(){const me=await fetchJSON('/api/me');if((me.role||'').toLowerCase()!=='parent'){window.location.href='/';return;}parentId=me.id;}
  async function loadAssignedStudents(){const detail=await fetchJSON(`/api/users/${parentId}`);students=detail.assigned_students||[];renderStudentOptions();if(students.length){selectStudent(students[0].id);}else{studentSelect.innerHTML='<option>No students</option>';activityEmpty.textContent='No students found.';}}
  function renderStudentOptions(){studentSelect.innerHTML=students.map(s=>`<option value="${s.id}">${(s.first_name||'')+' '+(s.last_name||'')}</option>`).join('');studentSelect.onchange=()=>selectStudent(studentSelect.value);}
  async function selectStudent(id){currentStudentId=id;const stu=await fetchJSON(`/api/users/${id}`);currentWalletId=stu.wallet_id||null;studentNameEl.textContent=`${stu.first_name||''} ${stu.last_name||''}`;await loadBalance();}
  
  function setFreezeButtonUI(isFrozen){freezeBtn.textContent=isFrozen?'Unfreeze Card':'Freeze Card';}
  async function loadBalance(){if(!currentWalletId){balanceMsg.textContent='No wallet.';balanceMsg.style.display='block';return;}try{const data=await fetchJSON(`/api/wallets/user/${currentStudentId}`);const cents=Number(data.balance_cents||0);balanceAmount.textContent=fmtMoney(cents/100);setFreezeButtonUI(!!data.is_frozen);cardStatusEl.textContent=data.is_frozen?'Card: FROZEN':'Card: ACTIVE';balanceMsg.style.display='none';}catch{balanceMsg.textContent='Balance unavailable';balanceMsg.style.display='block';}}

  if(freezeBtn){freezeBtn.onclick=async()=>{if(!currentWalletId)return;const frozen=/unfreeze/i.test(freezeBtn.textContent);const path=frozen?`/api/wallets/${currentWalletId}/unfreeze`:`/api/wallets/${currentWalletId}/freeze`;await fetch(path,{method:'POST',headers:{'Authorization':`Bearer ${token}`,'Content-Type':'application/json'}});await loadBalance();};}

  const logoutBtn=document.getElementById('logoutBtn');if(logoutBtn){logoutBtn.onclick=e=>{e.preventDefault();localStorage.removeItem('boop_jwt');localStorage.removeItem('boopUser');window.location.href='../index.html';};}

  (async()=>{await loadMe();if(parentId)await loadAssignedStudents();})();
})();
</script>
</body>
</html>
