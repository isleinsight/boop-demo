<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Parent Portal — BOOP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Parents can track spending, add funds, and manage their child's BOOP Card." />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../assets/styles.css" />
  <style>
    :root{
      --ink:#0b1220; --boop:#2f80ed; --boop-dark:#1c6fd8; --muted:#6b7280; --text:#1f2937;
      --stroke:#e5e7eb; --bg:#f5f8fb; --card:#ffffff; --ok:#10b981; --warn:#f59e0b; --danger:#ef4444;
    }
    *{box-sizing:border-box} body{margin:0;font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    /* NAV */
    .nav{background:#0b1220;}
    .nav__inner{max-width:1120px;margin:0 auto;padding:12px 18px;display:flex;align-items:center;justify-content:space-between}
    .nav__brand img{height:28px;display:block}
    .nav__actions{display:flex;gap:10px;align-items:center}
    .btn-primary{background:var(--boop);color:#fff;border:0;border-radius:10px;padding:10px 14px;font-weight:600;text-decoration:none;display:inline-flex;align-items:center;justify-content:center}
    .btn-primary:hover{background:var(--boop-dark)}
    .btn-light{background:#fff;color:var(--boop);border:1px solid var(--stroke);border-radius:10px;padding:10px 14px;font-weight:600;text-decoration:none;display:inline-flex;align-items:center;justify-content:center}
    /* LAYOUT */
    .wrap{max-width:1120px;margin:0 auto;padding:24px 18px}
    .grid{display:grid;grid-template-columns:1.6fr .9fr;gap:18px;align-items:start}
    @media (max-width:900px){ .grid{grid-template-columns:1fr} }
    /* CARDS */
    .card{background:var(--card);border:1px solid var(--stroke);border-radius:14px;box-shadow:0 10px 24px rgba(16,24,40,.06)}
    .card__head{padding:14px 16px;border-bottom:1px solid var(--stroke);display:flex;align-items:center;justify-content:space-between;gap:10px}
    .card__body{padding:16px}
    .pill{font-size:.8rem;background:#eef2ff;color:#374151;border-radius:999px;padding:4px 10px;border:1px solid #dbeafe}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .select{padding:10px 12px;border:1px solid var(--stroke);border-radius:10px;background:#fff;font-size:.95rem;min-width:220px}
    .balance{display:flex;align-items:center;gap:16px;flex-wrap:wrap}
    .balance__amount{font-size:2rem;font-weight:700;color:var(--ink)}
    .balance__status{color:var(--muted);font-size:.95rem}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    /* table */
    table{width:100%;border-collapse:collapse}
    th, td{padding:12px 10px;border-bottom:1px solid var(--stroke);text-align:left}
    th{font-weight:600;color:#374151}
    td.small{color:var(--muted);font-size:.92rem}
    .tag{display:inline-block;padding:4px 8px;border-radius:999px;font-size:.8rem;font-weight:600;background:#eef2ff;color:#1f2937;border:1px solid #dbeafe}
    .empty{color:var(--muted);text-align:center;padding:30px 8px}
    .pager{display:flex;justify-content:flex-end;gap:8px;padding-top:10px}
    .pager button{border:1px solid var(--stroke);background:#fff;color:#111827;border-radius:8px;padding:8px 10px;cursor:pointer}
    .pager button:disabled{opacity:.5;cursor:not-allowed}
    /* RIGHT: Overview + Controls */
    .summary h3{margin:0 0 6px} .summary p{margin:0;color:var(--muted)}
    .controls .row{align-items:center}
    .controls label{display:block;font-weight:600;margin-bottom:6px}
    .input, select.input{width:100%;padding:12px 14px;border:1px solid var(--stroke);border-radius:10px;outline:none;font-size:.95rem}
    .input:focus{border-color:var(--boop)}
    .switch{display:flex;align-items:center;gap:10px;margin:6px 0}
    .switch input{transform:scale(1.1)}
    .msg{font-size:.92rem;margin-top:6px;display:none}
    .msg.error{color:var(--danger)} .msg.ok{color:var(--ok)}
    /* MODALS */
    .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.45);z-index:50;padding:16px}
    .modal__card{width:100%;max-width:520px;background:#fff;border-radius:14px;border:1px solid var(--stroke);box-shadow:0 20px 50px rgba(0,0,0,.15);overflow:hidden}
    .modal__head{padding:14px 16px;border-bottom:1px solid var(--stroke);display:flex;align-items:center;justify-content:space-between}
    .modal__body{padding:16px;display:grid;gap:12px}
    .modal__foot{padding:14px 16px;border-top:1px solid var(--stroke);display:flex;gap:10px;justify-content:flex-end}
    .close{background:#f3f4f6;border:1px solid var(--stroke);color:#111827;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer}
    footer{padding:22px;color:#6b7280;text-align:center;margin-top:20px}
    footer a{color:var(--boop);text-decoration:none;font-weight:600}
  </style>
</head>
<body>
  <!-- Top Nav -->
<nav>
  <div class="nav-container">
    <div class="nav-left">
      <img src="../assets/Boop-Logo.png" alt="BOOP Logo" />
    </div>
    <div class="nav-right">
    
      <a href="#" id="logoutBtn">Log Out</a>
    </div>
  </div>
</nav>

  <main class="wrap">
    <section class="grid">
      <!-- LEFT: Student + Activity -->
      <div>
        <!-- Student selector & balance -->
        <div class="card" id="studentCard">
          <div class="card__head">
            <div class="row">
              <strong>Student</strong>
              <select id="studentSelect" class="select" aria-label="Choose student">
                <option>Loading…</option>
              </select>
            </div>
            <span id="schoolPill" class="pill" style="display:none"></span>
          </div>
          <div class="card__body">
            <div class="balance">
              <div class="balance__amount" id="balanceAmount">—</div>
              <div class="balance__status" id="balanceStatus">Balance</div>
            </div>
            <div class="actions" style="margin-top:12px">
              <button id="addFundsBtn" class="btn-primary" type="button">Add Funds</button>
              <a id="freezeBtn" class="btn-light" href="javascript:void(0)">Freeze Card</a>
            </div>
            <div id="balanceMsg" class="msg" aria-live="polite"></div>
          </div>
        </div>

        <!-- Activity -->
        <div class="card" style="margin-top:16px">
          <div class="card__head">
            <strong>Recent activity</strong>
            <span class="pill" id="activityCountPill" style="display:none"></span>
          </div>
          <div class="card__body" id="activityWrap">
            <div class="empty" id="activityEmpty">No recent transactions.</div>
            <div style="overflow:auto">
              <table id="activityTable" style="display:none">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Merchant</th>
                    <th>Category</th>
                    <th>Amount</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody id="activityTbody"></tbody>
              </table>
            </div>
            <div class="pager">
              <button id="prevPage">Prev</button>
              <button id="nextPage">Next</button>
            </div>
          </div>
        </div>
      </div>

      <!-- RIGHT: Overview + Controls -->
      <aside>
        <!-- Overview shows details for the selected student -->
        <div class="card summary">
          <div class="card__head"><strong>Overview</strong></div>
          <div class="card__body">
            <h3 id="studentName">—</h3>
            <p id="studentInfo" class="small">Loading student details…</p>
            <p id="cardStatus" class="small" style="margin-top:6px;color:var(--muted)"></p>
          </div>
        </div>

        <!-- Controls -->
        <div class="card controls" style="margin-top:16px">
          <div class="card__head"><strong>Controls</strong></div>
          <div class="card__body">
            <div>
              <label for="limitInput">Monthly spending limit (BMD)</label>
              <input id="limitInput" class="input" type="number" inputmode="decimal" min="0" step="0.01" placeholder="e.g. 150.00" />
              <div style="display:flex;gap:8px;margin-top:10px">
                <button id="saveLimitBtn" class="btn-primary" type="button">Save limit</button>
                <button id="clearLimitBtn" class="btn-light" type="button">Clear</button>
              </div>
              <div id="limitMsg" class="msg" aria-live="polite"></div>
            </div>

            <hr style="border:none;border-top:1px solid var(--stroke);margin:16px 0">

            <div>
              <label>Category safeguards</label>
              <div class="switch"><input id="cat_food" type="checkbox"> <span>Allow: Groceries & Essentials</span></div>
              <div class="switch"><input id="cat_fastfood" type="checkbox"> <span>Allow: Fast food</span></div>
              <div class="switch"><input id="cat_electronics" type="checkbox"> <span>Allow: Electronics</span></div>
              <div class="switch"><input id="cat_entertainment" type="checkbox"> <span>Allow: Entertainment</span></div>
              <div class="switch"><input id="cat_other" type="checkbox"> <span>Allow: Other</span></div>
              <div style="display:flex;gap:8px;margin-top:10px">
                <button id="saveCatsBtn" class="btn-primary" type="button">Save categories</button>
                <button id="resetCatsBtn" class="btn-light" type="button">Reset</button>
              </div>
              <div id="catsMsg" class="msg" aria-live="polite"></div>
            </div>
          </div>
        </div>
      </aside>
    </section>
  </main>

  <!-- Add Funds Modal -->
  <div id="fundsModal" class="modal" aria-hidden="true">
    <div class="modal__card" role="dialog" aria-modal="true" aria-labelledby="fundsTitle">
      <div class="modal__head">
        <strong id="fundsTitle">Add Funds</strong>
        <button class="close" id="closeFunds">Close</button>
      </div>
      <div class="modal__body">
        <label>Amount (BMD)
          <input id="amountInput" class="input" type="number" inputmode="decimal" min="1" step="0.01" placeholder="25.00" />
        </label>
        <label>Note (optional)
          <input id="noteInput" class="input" type="text" placeholder="Top-up for lunches" />
        </label>
        <div id="fundsMsg" class="msg" aria-live="polite"></div>
      </div>
      <div class="modal__foot">
        <button id="confirmFunds" class="btn-primary">Add Funds</button>
      </div>
    </div>
  </div>

  <!-- Request Another Child Modal -->
  <div id="requestModal" class="modal" aria-hidden="true">
    <div class="modal__card" role="dialog" aria-modal="true" aria-labelledby="reqTitle">
      <div class="modal__head">
        <strong id="reqTitle">Request another child</strong>
        <button class="close" id="closeRequest">Close</button>
      </div>
      <div class="modal__body">
        <label>Child’s full name
          <input id="reqName" class="input" type="text" placeholder="First Last" />
        </label>
        <label>Date of birth
          <input id="reqDob" class="input" type="date" />
        </label>
        <label>School (optional)
          <input id="reqSchool" class="input" type="text" placeholder="School name" />
        </label>
        <label>Notes (optional)
          <input id="reqNotes" class="input" type="text" placeholder="Anything else we should know" />
        </label>
        <div id="reqMsg" class="msg" aria-live="polite"></div>
      </div>
      <div class="modal__foot">
        <button id="submitRequest" class="btn-primary">Submit request</button>
      </div>
    </div>
  </div>

  <footer>
    © <span id="year"></span> BOOP. All rights reserved.
    &nbsp;•&nbsp; <a href="/terms.html">Terms</a> &nbsp;•&nbsp; <a href="/privacy.html">Privacy</a>
  </footer>

  <script>
(function () {
  // --- Year ---
  const yearEl = document.getElementById('year');
  if (yearEl) yearEl.textContent = new Date().getFullYear();

  // --- Auth guard ---
  const token = localStorage.getItem('boop_jwt');
  if (!token) {
    window.location.href = 'index.html';
    return;
  }

  // --- State ---
  let parentId = null;
  let students = [];
  let currentStudentId = null;
  let currentWalletId = null;
  let txns = [];
  let page = 0;
  const PAGE_SIZE = 8;

  // --- El refs ---
  const studentSelect = document.getElementById('studentSelect');
  const schoolPill = document.getElementById('schoolPill');
  const studentNameEl = document.getElementById('studentName');
  const studentInfoEl = document.getElementById('studentInfo');
  const cardStatusEl = document.getElementById('cardStatus');

  const balanceAmount = document.getElementById('balanceAmount');
  const balanceStatus = document.getElementById('balanceStatus');
  const balanceMsg = document.getElementById('balanceMsg');

  const activityEmpty = document.getElementById('activityEmpty');
  const activityTable = document.getElementById('activityTable');
  const activityTbody = document.getElementById('activityTbody');
  const activityCountPill = document.getElementById('activityCountPill');
  const prevBtn = document.getElementById('prevPage');
  const nextBtn = document.getElementById('nextPage');

  const addFundsBtn = document.getElementById('addFundsBtn');
  const fundsModal = document.getElementById('fundsModal');
  const closeFunds = document.getElementById('closeFunds');
  const confirmFunds = document.getElementById('confirmFunds');
  const amountInput = document.getElementById('amountInput');
  const noteInput = document.getElementById('noteInput');
  const fundsMsg = document.getElementById('fundsMsg');

  const requestChildBtn = document.getElementById('requestChildBtn'); // this may not exist on your page — guarded below
  const requestModal = document.getElementById('requestModal');
  const closeRequest = document.getElementById('closeRequest');
  const submitRequest = document.getElementById('submitRequest');
  const reqName = document.getElementById('reqName');
  const reqDob = document.getElementById('reqDob');
  const reqSchool = document.getElementById('reqSchool');
  const reqNotes = document.getElementById('reqNotes');
  const reqMsg = document.getElementById('reqMsg');

  const limitInput = document.getElementById('limitInput');
  const saveLimitBtn = document.getElementById('saveLimitBtn');
  const clearLimitBtn = document.getElementById('clearLimitBtn');
  const limitMsg = document.getElementById('limitMsg');

  const saveCatsBtn = document.getElementById('saveCatsBtn');
  const resetCatsBtn = document.getElementById('resetCatsBtn');
  const catsMsg = document.getElementById('catsMsg');

  // --- Helpers ---
  function fmtMoney(n) { return (typeof n === 'number' && Number.isFinite(n)) ? ('BMD $' + n.toFixed(2)) : '—'; }
  function fmtDate(iso) { try { return new Date(iso).toLocaleString(); } catch { return iso || '—'; } }

  async function fetchJSON(url, opts = {}) {
    const res = await fetch(url, {
      ...opts,
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`,
        ...(opts.headers || {})
      }
    });
    if (!res.ok) throw new Error(await res.text().catch(()=>'HTTP error'));
    return res.json();
  }

  // --- Data loaders ---
  async function loadMe() {
    const me = await fetchJSON('/api/me');
    if ((me.role || '').toLowerCase() !== 'parent') {
      alert('This portal is for Parent accounts.');
      window.location.href = '/';
      return;
    }
    parentId = me.id;
  }

  async function loadAssignedStudents() {
    const detail = await fetchJSON(`/api/users/${parentId}`);
    students = detail.assigned_students || [];
    renderStudentOptions();
    if (students.length) {
      selectStudent(students[0].id);
    } else {
      if (studentSelect) studentSelect.innerHTML = '<option>No students linked</option>';
      activityEmpty.textContent = 'No students found.';
    }
  }

  function renderStudentOptions() {
    if (!studentSelect) return;
    studentSelect.innerHTML = students.map(s => {
      const full = `${s.first_name || ''} ${s.last_name || ''}`.trim() || 'Student';
      return `<option value="${s.id}">${full}</option>`;
    }).join('');
    studentSelect.onchange = () => selectStudent(studentSelect.value);
  }

  async function selectStudent(studentId) {
    currentStudentId = studentId;
    if (balanceMsg) balanceMsg.style.display = 'none';
    page = 0;

    const stu = await fetchJSON(`/api/users/${studentId}`);
    currentWalletId = stu.wallet_id || null;

    const name = `${stu.first_name || ''} ${stu.last_name || ''}`.trim();
    if (studentNameEl) studentNameEl.textContent = name || 'Student';

    const sProfile = stu.student_profile || {};
    const school = sProfile.school_name ? `School: ${sProfile.school_name}` : '';
    if (schoolPill) {
      schoolPill.style.display = school ? 'inline-block' : 'none';
      schoolPill.textContent = school;
    }
    const grade = sProfile.grade_level ? `Grade: ${sProfile.grade_level}` : '';
    if (studentInfoEl) studentInfoEl.textContent = [grade].filter(Boolean).join(' • ') || '—';

    if (cardStatusEl) cardStatusEl.textContent = (stu.status ? `Card: ${String(stu.status).toUpperCase()}` : '').trim();

    await Promise.all([loadBalance(), loadActivity(), loadControls()]);
  }

  async function loadBalance() {
    if (balanceAmount) balanceAmount.textContent = '—';
    if (balanceStatus) balanceStatus.textContent = 'Balance';
    if (!currentWalletId) {
      if (balanceMsg) {
        balanceMsg.textContent = 'Balance unavailable (no wallet found).';
        balanceMsg.className = 'msg error';
        balanceMsg.style.display = 'block';
      }
      return;
    }
    try {
      const data = await fetchJSON(`/api/wallets/${currentWalletId}`); // adjust if your route differs
      const bal = Number(data.balance ?? data?.wallet?.balance);
      if (!Number.isFinite(bal)) throw new Error('No balance field');
      if (balanceAmount) balanceAmount.textContent = fmtMoney(bal);
      if (balanceStatus) balanceStatus.textContent = data.status ? `Balance • ${String(data.status).toUpperCase()}` : 'Balance';
    } catch {
      if (balanceMsg) {
        balanceMsg.textContent = 'Balance currently unavailable.';
        balanceMsg.className = 'msg error';
        balanceMsg.style.display = 'block';
      }
    }
  }

  async function loadActivity() {
    txns = [];
    page = 0;
    renderActivity();
    if (!currentWalletId) return;
    try {
      const list = await fetchJSON(`/api/wallets/${currentWalletId}/transactions`); // adjust if your route differs
      txns = Array.isArray(list) ? list : (list.transactions || []);
    } catch { /* ignore */ }
    renderActivity();
  }

  function renderActivity() {
    const total = txns.length;
    if (activityCountPill) {
      activityCountPill.style.display = total ? 'inline-block' : 'none';
      activityCountPill.textContent = `${total} items`;
    }
    const start = page * PAGE_SIZE, end = start + PAGE_SIZE, slice = txns.slice(start, end);
    if (prevBtn) { prevBtn.disabled = page === 0; prevBtn.onclick = () => { if (page > 0) { page--; renderActivity(); } }; }
    if (nextBtn) { nextBtn.disabled = end >= total; nextBtn.onclick = () => { if (end < total) { page++; renderActivity(); } }; }

    if (!slice.length) {
      if (activityEmpty) activityEmpty.style.display = 'block';
      if (activityTable) activityTable.style.display = 'none';
      return;
    }
    if (activityEmpty) activityEmpty.style.display = 'none';
    if (activityTable) activityTable.style.display = 'table';
    if (activityTbody) {
      activityTbody.innerHTML = slice.map(tx => {
        const amt = Number(tx.amount || 0);
        const amtStr = (amt < 0 ? '-' : '+') + fmtMoney(Math.abs(amt));
        const status = (tx.status || 'posted').toString().toUpperCase();
        const cat = tx.category || 'GENERAL';
        const merchant = tx.merchant || tx.description || '—';
        const date = tx.created_at || tx.posted_at || tx.date || tx.timestamp;
        return `<tr>
          <td class="small">${fmtDate(date)}</td>
          <td>${merchant}</td>
          <td><span class="tag">${cat}</span></td>
          <td>${amt < 0 ? '<span style="color:#ef4444">' + amtStr + '</span>' : '<span style="color:#10b981">' + amtStr + '</span>'}</td>
          <td class="small">${status}</td>
        </tr>`;
      }).join('');
    }
  }

  // --- Controls (limit + categories) ---
  async function loadControls() {
    if (limitMsg) limitMsg.style.display = 'none';
    if (catsMsg) catsMsg.style.display = 'none';

    // limit
    try {
      const res = await fetchJSON(`/api/students/${currentStudentId}/limits`); // implement server route
      const monthly = Number(res?.monthly_limit);
      if (Number.isFinite(monthly) && limitInput) limitInput.value = monthly.toFixed(2);
      else if (limitInput) limitInput.value = '';
    } catch { if (limitInput) limitInput.value = ''; }

    // categories
    try {
      const res = await fetchJSON(`/api/students/${currentStudentId}/categories`); // implement server route
      const a = res?.allow || {};
      (document.getElementById('cat_food') || {}).checked = !!a.food;
      (document.getElementById('cat_fastfood') || {}).checked = !!a.fastfood;
      (document.getElementById('cat_electronics') || {}).checked = !!a.electronics;
      (document.getElementById('cat_entertainment') || {}).checked = !!a.entertainment;
      (document.getElementById('cat_other') || {}).checked = !!a.other;
    } catch {
      (document.getElementById('cat_food') || {}).checked = true;
      (document.getElementById('cat_fastfood') || {}).checked = false;
      (document.getElementById('cat_electronics') || {}).checked = false;
      (document.getElementById('cat_entertainment') || {}).checked = true;
      (document.getElementById('cat_other') || {}).checked = true;
    }
  }

  if (saveLimitBtn) {
    saveLimitBtn.onclick = async () => {
      if (!limitInput || !limitMsg) return;
      limitMsg.style.display = 'none';
      const val = Number(limitInput.value);
      if (!Number.isFinite(val) || val < 0) {
        limitMsg.textContent = 'Enter a valid amount.';
        limitMsg.className = 'msg error';
        limitMsg.style.display = 'block';
        return;
      }
      try {
        const res = await fetch(`/api/students/${currentStudentId}/limits`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
          body: JSON.stringify({ monthly_limit: val })
        });
        if (!res.ok) throw new Error(await res.text());
        limitMsg.textContent = 'Spending limit saved.';
        limitMsg.className = 'msg ok';
        limitMsg.style.display = 'block';
      } catch {
        limitMsg.textContent = 'Failed to save limit.';
        limitMsg.className = 'msg error';
        limitMsg.style.display = 'block';
      }
    };
  }

  if (clearLimitBtn) {
    clearLimitBtn.onclick = async () => {
      if (!limitInput || !limitMsg) return;
      limitMsg.style.display = 'none';
      try {
        const res = await fetch(`/api/students/${currentStudentId}/limits`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!res.ok) throw new Error(await res.text());
        limitInput.value = '';
        limitMsg.textContent = 'Limit cleared.';
        limitMsg.className = 'msg ok';
        limitMsg.style.display = 'block';
      } catch {
        limitMsg.textContent = 'Failed to clear limit.';
        limitMsg.className = 'msg error';
        limitMsg.style.display = 'block';
      }
    };
  }

  if (saveCatsBtn) {
    saveCatsBtn.onclick = async () => {
      if (!catsMsg) return;
      catsMsg.style.display = 'none';
      const payload = {
        allow: {
          food: (document.getElementById('cat_food') || {}).checked || false,
          fastfood: (document.getElementById('cat_fastfood') || {}).checked || false,
          electronics: (document.getElementById('cat_electronics') || {}).checked || false,
          entertainment: (document.getElementById('cat_entertainment') || {}).checked || false,
          other: (document.getElementById('cat_other') || {}).checked || false
        }
      };
      try {
        const res = await fetch(`/api/students/${currentStudentId}/categories`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
          body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error(await res.text());
        catsMsg.textContent = 'Categories saved.';
        catsMsg.className = 'msg ok';
        catsMsg.style.display = 'block';
      } catch {
        catsMsg.textContent = 'Failed to save categories.';
        catsMsg.className = 'msg error';
        catsMsg.style.display = 'block';
      }
    };
  }

  if (resetCatsBtn) {
    resetCatsBtn.onclick = loadControls;
  }

  // --- Add Funds modal ---
  function openFunds() {
    if (fundsModal) { fundsModal.style.display = 'grid'; fundsModal.setAttribute('aria-hidden', 'false'); }
    if (amountInput) amountInput.focus();
  }
  function closeFundsModal() {
    if (fundsModal) { fundsModal.style.display = 'none'; fundsModal.setAttribute('aria-hidden', 'true'); }
    if (fundsMsg) fundsMsg.style.display = 'none';
    if (amountInput) amountInput.value = '';
    if (noteInput) noteInput.value = '';
  }

  if (addFundsBtn) addFundsBtn.onclick = () => { if (!currentWalletId) { alert('Wallet unavailable for this student.'); return; } openFunds(); };
  if (closeFunds) closeFunds.onclick = closeFundsModal;
  if (fundsModal) fundsModal.addEventListener('click', (e) => { if (e.target === fundsModal) closeFundsModal(); });
  if (confirmFunds) {
    confirmFunds.onclick = async () => {
      if (!amountInput || !fundsMsg) return;
      fundsMsg.style.display = 'none';
      const amt = Number(amountInput.value);
      if (!Number.isFinite(amt) || amt <= 0) {
        fundsMsg.textContent = 'Please enter a valid amount.';
        fundsMsg.className = 'msg error';
        fundsMsg.style.display = 'block';
        return;
      }
      confirmFunds.disabled = true; confirmFunds.textContent = 'Processing…';
      try {
        const res = await fetch(`/api/wallets/${currentWalletId}/deposits`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
          body: JSON.stringify({ amount: amt, note: (noteInput && noteInput.value) || null })
        });
        if (!res.ok) throw new Error(await res.text());
        fundsMsg.textContent = 'Funds added successfully.';
        fundsMsg.className = 'msg ok';
        fundsMsg.style.display = 'block';
        await loadBalance(); await loadActivity();
        setTimeout(closeFundsModal, 900);
      } catch {
        fundsMsg.textContent = 'Failed to add funds.';
        fundsMsg.className = 'msg error';
        fundsMsg.style.display = 'block';
      } finally {
        confirmFunds.disabled = false; confirmFunds.textContent = 'Add Funds';
      }
    };
  }

  // --- Request another child modal (guarded: trigger may not exist) ---
  function openReq() {
    if (requestModal) { requestModal.style.display = 'grid'; requestModal.setAttribute('aria-hidden', 'false'); }
    if (reqName) reqName.focus();
  }
  function closeReq() {
    if (requestModal) { requestModal.style.display = 'none'; requestModal.setAttribute('aria-hidden', 'true'); }
    if (reqMsg) reqMsg.style.display = 'none';
    if (reqName) reqName.value = '';
    if (reqDob) reqDob.value = '';
    if (reqSchool) reqSchool.value = '';
    if (reqNotes) reqNotes.value = '';
  }
  if (requestChildBtn) requestChildBtn.onclick = openReq;
  if (closeRequest) closeRequest.onclick = closeReq;
  if (requestModal) requestModal.addEventListener('click', (e) => { if (e.target === requestModal) closeReq(); });
  if (submitRequest) {
    submitRequest.onclick = async () => {
      if (!reqMsg || !reqName || !reqDob) return;
      reqMsg.style.display = 'none';
      if (!reqName.value.trim() || !reqDob.value) {
        reqMsg.textContent = 'Name and DOB are required.';
        reqMsg.className = 'msg error';
        reqMsg.style.display = 'block';
        return;
      }
      submitRequest.disabled = true; submitRequest.textContent = 'Submitting…';
      try {
        const res = await fetch(`/api/parents/${parentId}/child-requests`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
          body: JSON.stringify({
            child_name: reqName.value.trim(),
            child_dob: reqDob.value,
            school: (reqSchool && reqSchool.value) || null,
            notes: (reqNotes && reqNotes.value) || null
          })
        });
        if (!res.ok) throw new Error(await res.text());
        reqMsg.textContent = 'Request submitted. An admin will review it shortly.';
        reqMsg.className = 'msg ok';
        reqMsg.style.display = 'block';
        setTimeout(closeReq, 1000);
      } catch {
        reqMsg.textContent = 'Failed to submit request.';
        reqMsg.className = 'msg error';
        reqMsg.style.display = 'block';
      } finally {
        submitRequest.disabled = false; submitRequest.textContent = 'Submit request';
      }
    };
  }

  // --- Init ---
  (async function init() {
    try {
      await loadMe();
      if (!parentId) return;
      await loadAssignedStudents();
    } catch (e) {
      console.error(e);
      alert('Unable to load your account. Please sign in again.');
      window.location.href = 'index.html';
    }
  })();

  // --- Logout (null-safe, server best-effort) ---
  const logoutBtn = document.getElementById('logoutBtn');
  if (logoutBtn) {
    logoutBtn.addEventListener('click', async (e) => {
      e.preventDefault();
      try {
        const me = JSON.parse(localStorage.getItem('boopUser') || '{}');
        if (me.id && token) {
          await fetch(`/api/users/${me.id}/signout`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}` }
          }).catch(() => {});
        }
      } finally {
        localStorage.removeItem('boop_jwt');
        localStorage.removeItem('boopUser');
        sessionStorage.clear();
        window.location.href = 'index.html';
      }
    });
  }
})();
</script>
</body>
</html>
