<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Parent Portal — BOOP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Parents can track spending, add funds, and manage their child's BOOP Card." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --ink:#0b1220;          /* dark header/nav */
      --boop:#2f80ed;         /* primary blue */
      --boop-dark:#1c6fd8;
      --muted:#6b7280;
      --text:#1f2937;
      --stroke:#e5e7eb;
      --bg:#f5f8fb;
      --card:#ffffff;
      --ok:#10b981;
      --warn:#f59e0b;
      --danger:#ef4444;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg); color:var(--text)
    }

    /* NAV */
    .nav{background:#0b1220;}
    .nav__inner{max-width:1120px;margin:0 auto;padding:12px 18px;display:flex;align-items:center;justify-content:space-between}
    .nav__brand img{height:28px;display:block}
    .nav__actions{display:flex;gap:10px;align-items:center}
    .btn-primary{
      background:var(--boop); color:#fff; border:0; border-radius:10px;
      padding:10px 14px; font-weight:600; text-decoration:none; display:inline-flex; align-items:center; justify-content:center;
    }
    .btn-primary:hover{background:var(--boop-dark)}
    .btn-light{
      background:#fff; color:var(--boop); border:1px solid var(--stroke); border-radius:10px;
      padding:10px 14px; font-weight:600; text-decoration:none; display:inline-flex; align-items:center; justify-content:center;
    }

    /* LAYOUT */
    .wrap{max-width:1120px;margin:0 auto;padding:24px 18px}
    .grid{display:grid;grid-template-columns:1.6fr .9fr;gap:18px;align-items:start}
    @media (max-width:900px){ .grid{grid-template-columns:1fr} }

    /* CARDS */
    .card{
      background:var(--card);
      border:1px solid var(--stroke);
      border-radius:14px;
      box-shadow:0 10px 24px rgba(16,24,40,.06);
    }
    .card__head{padding:14px 16px;border-bottom:1px solid var(--stroke);display:flex;align-items:center;justify-content:space-between;gap:10px}
    .card__body{padding:16px}
    .pill{font-size:.8rem;background:#eef2ff;color:#374151;border-radius:999px;padding:4px 10px;border:1px solid #dbeafe}

    /* LEFT: Student + Activity */
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .select{
      padding:10px 12px;border:1px solid var(--stroke);border-radius:10px;background:#fff;font-size:.95rem;min-width:220px
    }

    .balance{
      display:flex; align-items:center; gap:16px; flex-wrap:wrap
    }
    .balance__amount{font-size:2rem;font-weight:700;color:var(--ink)}
    .balance__status{color:var(--muted);font-size:.95rem}

    .actions{display:flex;gap:8px;flex-wrap:wrap}

    /* table */
    table{width:100%;border-collapse:collapse}
    th, td{padding:12px 10px;border-bottom:1px solid var(--stroke);text-align:left}
    th{font-weight:600;color:#374151}
    td.small{color:var(--muted);font-size:.92rem}
    .tag{
      display:inline-block; padding:4px 8px; border-radius:999px; font-size:.8rem; font-weight:600;
      background:#eef2ff; color:#1f2937; border:1px solid #dbeafe
    }
    .empty{color:var(--muted);text-align:center;padding:30px 8px}

    .pager{display:flex;justify-content:flex-end;gap:8px;padding-top:10px}
    .pager button{
      border:1px solid var(--stroke); background:#fff; color:#111827; border-radius:8px; padding:8px 10px; cursor:pointer
    }
    .pager button:disabled{opacity:.5;cursor:not-allowed}

    /* RIGHT: Login/Account quick card replaced by Summary card */
    .summary h3{margin:0 0 6px}
    .summary p{margin:0;color:var(--muted)}

    /* MODAL */
    .modal{
      position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.45); z-index:50;
      padding:16px;
    }
    .modal__card{
      width:100%; max-width:440px; background:#fff; border-radius:14px; border:1px solid var(--stroke); box-shadow:0 20px 50px rgba(0,0,0,.15);
      overflow:hidden;
    }
    .modal__head{padding:14px 16px;border-bottom:1px solid var(--stroke);display:flex;align-items:center;justify-content:space-between}
    .modal__body{padding:16px; display:grid; gap:12px}
    .modal__foot{padding:14px 16px;border-top:1px solid var(--stroke);display:flex;gap:10px;justify-content:flex-end}
    .close{background:#f3f4f6;border:1px solid var(--stroke);color:#111827;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer}
    .input, select.input{
      width:100%; padding:12px 14px; border:1px solid var(--stroke); border-radius:10px; outline:none; font-size:.95rem;
    }
    .input:focus{border-color:var(--boop)}
    .msg{font-size:.92rem;margin-top:6px;display:none}
    .msg.error{color:var(--danger)}
    .msg.ok{color:var(--ok)}

    /* FOOTER */
    footer{padding:22px;color:#6b7280;text-align:center;margin-top:20px}
    footer a{color:var(--boop);text-decoration:none;font-weight:600}
  </style>
</head>
<body>
  <!-- NAV -->
  <header class="nav">
    <div class="nav__inner">
      <a class="nav__brand" href="/"><img src="/assets/Boop-Logo.png" alt="BOOP" /></a>
      <div class="nav__actions">
        <a class="btn-light" href="/parent/help.html">Help</a>
        <a class="btn-primary" href="/signup-placeholder.html">Add My Child</a>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section class="grid">
      <!-- LEFT: Student selection, balance, activity -->
      <div>
        <!-- Student selector & balance -->
        <div class="card" id="studentCard">
          <div class="card__head">
            <div class="row">
              <strong>Student</strong>
              <select id="studentSelect" class="select" aria-label="Choose student">
                <option>Loading…</option>
              </select>
            </div>
            <span id="schoolPill" class="pill" style="display:none"></span>
          </div>
          <div class="card__body">
            <div class="balance">
              <div class="balance__amount" id="balanceAmount">—</div>
              <div class="balance__status" id="balanceStatus">Balance</div>
            </div>
            <div class="actions" style="margin-top:12px">
              <button id="addFundsBtn" class="btn-primary" type="button">Add Funds</button>
              <a id="freezeBtn" class="btn-light" href="javascript:void(0)">Freeze Card</a>
            </div>
            <div id="balanceMsg" class="msg" aria-live="polite"></div>
          </div>
        </div>

        <!-- Activity -->
        <div class="card" style="margin-top:16px">
          <div class="card__head">
            <strong>Recent activity</strong>
            <span class="pill" id="activityCountPill" style="display:none"></span>
          </div>
          <div class="card__body" id="activityWrap">
            <div class="empty" id="activityEmpty">No recent transactions.</div>
            <div style="overflow:auto">
              <table id="activityTable" style="display:none">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Merchant</th>
                    <th>Category</th>
                    <th>Amount</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody id="activityTbody"></tbody>
              </table>
            </div>
            <div class="pager">
              <button id="prevPage">Prev</button>
              <button id="nextPage">Next</button>
            </div>
          </div>
        </div>
      </div>

      <!-- RIGHT: Summary / tips -->
      <aside>
        <div class="card summary">
          <div class="card__head"><strong>Overview</strong></div>
          <div class="card__body">
            <h3 id="studentName">—</h3>
            <p id="studentInfo" class="small">Loading student details…</p>
            <hr style="border:none;border-top:1px solid var(--stroke);margin:12px 0">
            <p class="small" style="color:var(--muted)">
              Tip: you can set spending limits and category safeguards from your child’s settings (coming soon).
            </p>
          </div>
        </div>
      </aside>
    </section>
  </main>

  <!-- Add Funds Modal -->
  <div id="fundsModal" class="modal" aria-hidden="true">
    <div class="modal__card" role="dialog" aria-modal="true" aria-labelledby="fundsTitle">
      <div class="modal__head">
        <strong id="fundsTitle">Add Funds</strong>
        <button class="close" id="closeFunds">Close</button>
      </div>
      <div class="modal__body">
        <label>Amount (BMD)
          <input id="amountInput" class="input" type="number" inputmode="decimal" min="1" step="0.01" placeholder="25.00" />
        </label>
        <label>Note (optional)
          <input id="noteInput" class="input" type="text" placeholder="Top-up for lunches" />
        </label>
        <div id="fundsMsg" class="msg" aria-live="polite"></div>
      </div>
      <div class="modal__foot">
        <button id="confirmFunds" class="btn-primary">Add Funds</button>
      </div>
    </div>
  </div>

  <footer>
    © <span id="year"></span> BOOP. All rights reserved.
    &nbsp;•&nbsp; <a href="/terms.html">Terms</a> &nbsp;•&nbsp; <a href="/privacy.html">Privacy</a>
  </footer>

  <script>
    // Year
    document.getElementById('year').textContent = new Date().getFullYear();

    // --- Auth guard & data loading ---
    const token = localStorage.getItem('boop_jwt');
    if (!token) {
      location.href = '/accounts/login.html'; // or your general login
    }

    let parentId = null;
    let students = []; // [{id, first_name, last_name, email, wallet_id?, student_profile?}, ...]
    let currentStudentId = null;
    let currentWalletId = null;

    const studentSelect = document.getElementById('studentSelect');
    const schoolPill = document.getElementById('schoolPill');
    const studentNameEl = document.getElementById('studentName');
    const studentInfoEl = document.getElementById('studentInfo');

    const balanceAmount = document.getElementById('balanceAmount');
    const balanceStatus = document.getElementById('balanceStatus');
    const balanceMsg = document.getElementById('balanceMsg');

    const activityEmpty = document.getElementById('activityEmpty');
    const activityTable = document.getElementById('activityTable');
    const activityTbody = document.getElementById('activityTbody');
    const activityCountPill = document.getElementById('activityCountPill');

    const addFundsBtn = document.getElementById('addFundsBtn');
    const fundsModal = document.getElementById('fundsModal');
    const closeFunds = document.getElementById('closeFunds');
    const confirmFunds = document.getElementById('confirmFunds');
    const amountInput = document.getElementById('amountInput');
    const noteInput = document.getElementById('noteInput');
    const fundsMsg = document.getElementById('fundsMsg');

    // Pagination state
    let txns = [];
    let page = 0;
    const PAGE_SIZE = 8;

    function fmtMoney(n) {
      if (typeof n !== 'number') return '—';
      return 'BMD $' + n.toFixed(2);
    }
    function fmtDate(iso) {
      try { return new Date(iso).toLocaleString(); } catch { return iso || '—'; }
    }

    async function fetchJSON(url, opts = {}) {
      const res = await fetch(url, {
        ...opts,
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`,
          ...(opts.headers || {})
        }
      });
      if (!res.ok) throw new Error(await res.text());
      return res.json();
    }

    async function loadMe() {
      const me = await fetchJSON('/api/me');
      if ((me.role || '').toLowerCase() !== 'parent') {
        alert('This portal is for Parent accounts.');
        location.href = '/';
        return;
      }
      parentId = me.id;
    }

    async function loadAssignedStudents() {
      // Your backend: GET /api/users/:id returns assigned_students for role=parent
      const detail = await fetchJSON(`/api/users/${parentId}`);
      students = detail.assigned_students || [];
      // If wallet_id not included, we’ll fetch per student when selected
      renderStudentOptions();
      if (students.length) {
        selectStudent(students[0].id);
      } else {
        studentSelect.innerHTML = '<option>No students linked</option>';
        balanceAmount.textContent = '—';
        activityEmpty.textContent = 'No students found.';
      }
    }

    function renderStudentOptions() {
      studentSelect.innerHTML = students.map(s =>
        `<option value="${s.id}">${s.first_name || ''} ${s.last_name || ''}</option>`
      ).join('');
      studentSelect.addEventListener('change', () => {
        selectStudent(studentSelect.value);
      });
    }

    async function selectStudent(studentId) {
      currentStudentId = studentId;
      balanceMsg.style.display = 'none';
      fundsMsg.style.display = 'none';
      page = 0;

      // Load full student row to find wallet_id (your /api/users/:id returns entire user row)
      const stu = await fetchJSON(`/api/users/${studentId}`);
      currentWalletId = stu.wallet_id || null;

      // Header bits
      const name = `${stu.first_name || ''} ${stu.last_name || ''}`.trim();
      studentNameEl.textContent = name || 'Student';
      const sProfile = stu.student_profile || {};
      const school = sProfile.school_name ? `School: ${sProfile.school_name}` : '';
      schoolPill.style.display = school ? 'inline-block' : 'none';
      schoolPill.textContent = school;
      studentInfoEl.textContent = sProfile.grade_level ? `Grade: ${sProfile.grade_level}` : '';

      // Load balance & activity (best-effort)
      await loadBalance();
      await loadActivity();
    }

    async function loadBalance() {
      balanceAmount.textContent = '—';
      balanceStatus.textContent = 'Balance';
      balanceMsg.style.display = 'none';

      if (!currentWalletId) {
        balanceMsg.textContent = 'Balance unavailable (no wallet found).';
        balanceMsg.className = 'msg error';
        balanceMsg.style.display = 'block';
        return;
      }

      try {
        // TODO: Update to your balance endpoint. Common patterns shown below:
        // 1) /api/wallets/:id/summary   -> { balance: 123.45 }
        // 2) /api/wallets/:id           -> { id, status, balance, ... }
        const data = await fetchJSON(`/api/wallets/${currentWalletId}`); // try #2
        const bal = Number(data.balance ?? data?.wallet?.balance);
        if (!Number.isFinite(bal)) throw new Error('No balance field in response');

        balanceAmount.textContent = fmtMoney(bal);
        balanceStatus.textContent = data.status ? `Balance • ${String(data.status).toUpperCase()}` : 'Balance';
      } catch (err) {
        // Graceful fallback
        balanceMsg.textContent = 'Balance currently unavailable.';
        balanceMsg.className = 'msg error';
        balanceMsg.style.display = 'block';
      }
    }

    async function loadActivity() {
      txns = [];
      page = 0;
      renderActivity();

      if (!currentWalletId) return;

      try {
        // TODO: Update to your transactions endpoint.
        // Examples:
        //   /api/transactions?wallet_id=...    -> [{...}]
        //   /api/wallets/:id/transactions      -> [{...}]
        const list = await fetchJSON(`/api/wallets/${currentWalletId}/transactions`);
        txns = Array.isArray(list) ? list : (list.transactions || []);
      } catch (err) {
        // leave empty state
      }
      renderActivity();
    }

    function renderActivity() {
      const total = txns.length;
      activityCountPill.style.display = total ? 'inline-block' : 'none';
      activityCountPill.textContent = `${total} items`;

      const start = page * PAGE_SIZE;
      const end = start + PAGE_SIZE;
      const slice = txns.slice(start, end);

      const prev = document.getElementById('prevPage');
      const next = document.getElementById('nextPage');
      prev.disabled = page === 0;
      next.disabled = end >= total;
      prev.onclick = () => { if (page>0){ page--; renderActivity(); } };
      next.onclick = () => { if (end<total){ page++; renderActivity(); } };

      if (!slice.length) {
        activityEmpty.style.display = 'block';
        activityTable.style.display = 'none';
        return;
      }

      activityEmpty.style.display = 'none';
      activityTable.style.display = 'table';

      activityTbody.innerHTML = slice.map(tx => {
        const amt = Number(tx.amount || 0);  // negative for purchases?
        const amtStr = (amt < 0 ? '-' : '+') + fmtMoney(Math.abs(amt));
        const status = (tx.status || 'posted').toString().toUpperCase();
        const cat = tx.category || 'GENERAL';
        const merchant = tx.merchant || tx.description || '—';
        const date = tx.created_at || tx.posted_at || tx.date || tx.timestamp;

        return `
          <tr>
            <td class="small">${fmtDate(date)}</td>
            <td>${merchant}</td>
            <td><span class="tag">${cat}</span></td>
            <td>${amt < 0 ? '<span style="color:#ef4444">'+amtStr+'</span>' : '<span style="color:#10b981">'+amtStr+'</span>'}</td>
            <td class="small">${status}</td>
          </tr>
        `;
      }).join('');
    }

    // --- Add Funds Modal ---
    function openFunds(){ fundsModal.style.display='grid'; fundsModal.setAttribute('aria-hidden','false'); amountInput.focus(); }
    function closeFundsModal(){ fundsModal.style.display='none'; fundsModal.setAttribute('aria-hidden','true'); fundsMsg.style.display='none'; amountInput.value=''; noteInput.value=''; }

    addFundsBtn.addEventListener('click', () => {
      if (!currentWalletId) {
        alert('Wallet unavailable for this student.');
        return;
      }
      openFunds();
    });
    closeFunds.addEventListener('click', closeFundsModal);
    fundsModal.addEventListener('click', (e)=>{ if(e.target === fundsModal) closeFundsModal(); });

    confirmFunds.addEventListener('click', async ()=>{
      fundsMsg.style.display='none';
      const amt = Number(amountInput.value);
      if (!Number.isFinite(amt) || amt <= 0) {
        fundsMsg.textContent = 'Please enter a valid amount.';
        fundsMsg.className = 'msg error';
        fundsMsg.style.display = 'block';
        return;
      }
      confirmFunds.disabled = true;
      confirmFunds.textContent = 'Processing…';
      try {
        // TODO: Update to your top-up endpoint.
        // Examples:
        //   POST /api/wallets/:id/deposits { amount, note }
        //   POST /api/funding/topup { wallet_id, amount, note }
        const res = await fetch(`/api/wallets/${currentWalletId}/deposits`, {
          method:'POST',
          headers:{
            'Content-Type':'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ amount: amt, note: noteInput.value || null })
        });
        if (!res.ok) {
          const txt = await res.text();
          throw new Error(txt || 'Top-up failed');
        }
        fundsMsg.textContent = 'Funds added successfully.';
        fundsMsg.className = 'msg ok';
        fundsMsg.style.display = 'block';
        // Refresh balance & activity
        await loadBalance();
        await loadActivity();
        setTimeout(closeFundsModal, 900);
      } catch (err) {
        fundsMsg.textContent = 'Failed to add funds. ' + (err.message || '');
        fundsMsg.className = 'msg error';
        fundsMsg.style.display = 'block';
      } finally {
        confirmFunds.disabled = false;
        confirmFunds.textContent = 'Add Funds';
      }
    });

    // --- Init ---
    (async function init(){
      try{
        await loadMe();
        if (!parentId) return;
        await loadAssignedStudents();
      } catch (e) {
        console.error(e);
        alert('Unable to load your account. Please sign in again.');
        location.href = '/accounts/login.html';
      }
    })();
  </script>
</body>
</html>
