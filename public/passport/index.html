<script>
(async () => {
  const ALLOWED = new Set([
    "vendor", "rolevendor",     // tolerate odd/capitalized values
    "health", "health_professional", "healthprofessional",
    "transit", "bus", "ferry"
  ]);

  try {
    const token = localStorage.getItem("boop_jwt");
    if (!token) throw new Error("No token");

    // 1) Lightweight identity (id, email, role, type)
    const meRes = await fetch("/api/me", {
      headers: { Authorization: `Bearer ${token}` }
    });
    if (!meRes.ok) throw new Error("Unauthorized");
    const basic = await meRes.json();

    // Normalize role
    const rawRole = String(basic.role || basic.type || "").trim();
    const role = rawRole.toLowerCase();

    if (!ALLOWED.has(role)) throw new Error("Forbidden");

    // 2) Enrich with names if available
    let full = basic;
    try {
      const fullRes = await fetch("/api/users/me", {
        headers: { Authorization: `Bearer ${token}` }
      });
      if (fullRes.ok) {
        const more = await fullRes.json();
        full = { ...basic, ...more };
      }
    } catch (_) { /* optional */ }

    // Save for the page to use (first_name/last_name etc.)
    localStorage.setItem("boopUser", JSON.stringify(full));
    window.__boopRole = role; // handy if you switch UI by role

  } catch (err) {
    // On any failure, clear and go home
    try { await fetch("/api/logout", { method: "POST" }); } catch {}
    localStorage.clear();
    location.href = "/index.html";
  }
})();
</script>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Passport</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    :root{
      --ink:#0f1b2d;
      --muted:#6b7280;
      --stroke:#e6ebf1;
      --ok:#065f46;
      --warn:#92400e;
      --err:#7f1d1d;
      --blue:#2f80ed;
      --blue-dark:#1c6fd8;
      --bg:#f5f7fa;
      --card:#ffffff;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; min-height:100vh; background:var(--bg); color:var(--ink);
      font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      display:flex; flex-direction:column;
    }

    /* Top bar */
    .topbar{ background:#0b1220; color:#fff; border-bottom:1px solid #0f172a; }
    .topbar__inner{
      max-width: 1100px; margin:0 auto; padding:12px 16px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .brand{ display:flex; align-items:center; gap:10px; }
    .brand img{ height:28px; display:block; }
    .brand .who{ font-size:.9rem; opacity:.85 }
    .logout{ color:#cfe0ff; text-decoration:none; font-size:.9rem; }
    .logout:hover{ text-decoration:underline; }

    /* Main wrapper */
    .wrap{ max-width:1100px; margin:24px auto; padding:0 16px; width:100%; }

    /* Shared card style */
    .card{
      background:var(--card); border:1px solid var(--stroke); border-radius:14px;
      box-shadow:0 8px 24px rgba(15, 23, 42, .06); padding:18px;
    }
    h1{ margin:0 0 6px; font-size:1.25rem; }
    .sub{ margin:0 0 14px; color:var(--muted); font-size:.95rem; }

    label{ display:block; font-size:.9rem; color:#1f2a44; margin:10px 0 6px; }
    input, textarea, button, select{
      width:100%; border:1px solid #d1d9e6; border-radius:10px; padding:10px 12px;
      font-size:1rem; font-family:inherit; background:#fff;
    }
    input:focus, textarea:focus, select:focus{ outline:none; border-color:var(--blue); }
    .row{ display:flex; gap:12px; flex-wrap:wrap; }
    .row > .col{ flex:1 1 260px; }

    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      margin-top:14px; padding:10px 14px; border-radius:10px; border:1px solid transparent;
      background:var(--blue); color:#fff; font-weight:700; cursor:pointer;
    }
    .btn:hover{ background:var(--blue-dark); }
    .btn.secondary{ background:#fff; color:var(--ink); border-color:#d1d9e6; }
    .btn.secondary:hover{ background:#f3f4f6; }

    .status{ margin-top:12px; padding:10px 12px; border-radius:10px; border:1px solid var(--stroke); }
    .status.ok{ background:#ecfdf5; border-color:#a7f3d0; color:var(--ok); }
    .status.warn{ background:#fff7ed; border-color:#fed7aa; color:var(--warn); }
    .status.err{ background:#fef2f2; border-color:#fecaca; color:var(--err); }

    /* Sections (hidden until JS decides) */
    .view{ display:none; }
    .view.active{ display:block; }

    /* Small helper bits */
    .kv{ display:flex; gap:12px; flex-wrap:wrap; margin:8px 0 0; }
    .kv .item{ padding:8px 10px; border:1px solid var(--stroke); border-radius:10px; background:#fff; }
    .muted{ color:var(--muted) }

    /* Footer */
    footer{ margin-top:auto; border-top:1px solid var(--stroke); background:#fff; }
    .footer__inner{ max-width:1100px; margin:0 auto; padding:14px 16px; font-size:.9rem; color:#4b5563;
      display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; }
    .footer__links a{ color:var(--blue); text-decoration:none; margin-right:12px; }
    .footer__links a:hover{ text-decoration:underline; }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="topbar">
    <div class="topbar__inner">
      <div class="brand">
        <img src="../assets/logo-white.png" alt="Payulot" />
        <div class="who" id="signedInAs">Loading…</div>
      </div>
      <a class="logout" href="#" id="logoutLink">Log out</a>
    </div>
  </div>

  <div class="wrap">

    <!-- Common passport header -->
    <div class="card" style="margin-bottom:16px;">
      <h1>Passport</h1>
      <p class="sub">This page adapts to the signed-in role. Provide a Passport ID or scan to continue.</p>

      <div class="row">
        <div class="col">
          <label>Passport ID</label>
          <input id="pid" type="text" inputmode="text" placeholder="e.g. Pa79cf0cd1f0da64e" />
        </div>
        <div class="col">
          <label>Quick actions</label>
          <div class="row">
            <button class="btn secondary" id="btnPaste">Paste from clipboard</button>
            <button class="btn" id="btnLoad">Load</button>
          </div>
        </div>
      </div>

      <div id="commonStatus" class="status" style="display:none;"></div>

      <div class="kv">
        <div class="item"><span class="muted">Signed-in role:</span> <strong id="roleBadge">—</strong></div>
        <div class="item"><span class="muted">Signed-in user:</span> <strong id="whoBadge">—</strong></div>
      </div>
    </div>

    <!-- Vendor VIEW -->
    <section id="view-vendor" class="view card">
      <h2 style="margin:0 0 6px;">Vendor • Charge by Passport</h2>
      <p class="sub">Enter an amount and complete the charge for this passport.</p>

      <div class="row">
        <div class="col">
          <label>Amount</label>
          <input id="v_amount" type="number" inputmode="decimal" min="0.01" step="0.01" placeholder="0.00" />
        </div>
        <div class="col">
          <label>Note (optional)</label>
          <input id="v_note" type="text" maxlength="120" placeholder="Short description for receipt" />
        </div>
      </div>

      <button class="btn" id="v_chargeBtn">Charge</button>
      <div id="v_status" class="status" style="display:none;"></div>
    </section>

    <!-- Health VIEW -->
    <section id="view-health" class="view card">
      <h2 style="margin:0 0 6px;">Health • Emergency Passport</h2>
      <p class="sub">Show read-only info useful for emergency care. (No PHI here; just placeholders until your API is ready.)</p>

      <div class="row">
        <div class="col">
          <label>Flag</label>
          <input disabled value="No known allergies (example)" />
        </div>
        <div class="col">
          <label>Emergency Contact</label>
          <input disabled value="(example) Jane Doe • +1 441-555-0134" />
        </div>
      </div>
      <div class="row">
        <div class="col">
          <label>Notes</label>
          <textarea disabled rows="3">This section renders from your health API when ready.</textarea>
        </div>
      </div>
    </section>

    <!-- Transit VIEW -->
    <section id="view-transit" class="view card">
      <h2 style="margin:0 0 6px;">Transit • Validate & Deduct</h2>
      <p class="sub">Validate the passport and deduct a ride or fare.</p>

      <div class="row">
        <div class="col">
          <label>Mode</label>
          <select id="t_mode">
            <option value="bus">Bus</option>
            <option value="ferry">Ferry</option>
            <option value="rail">Rail</option>
          </select>
        </div>
        <div class="col">
          <label>Fare</label>
          <input id="t_fare" type="number" inputmode="decimal" min="0" step="0.01" value="2.75" />
        </div>
      </div>

      <button class="btn" id="t_validateBtn">Validate & Deduct</button>
      <div id="t_status" class="status" style="display:none;"></div>
    </section>

  </div>

  <footer>
    <div class="footer__inner">
      <div>© <span id="year"></span> Payulot</div>
      <div class="footer__links">
        <a href="../terms.html" target="_blank" rel="noopener">Terms</a>
        <a href="../privacy.html" target="_blank" rel="noopener">Privacy</a>
      </div>
    </div>
  </footer>

  <script src="./passport.js" defer></script>
</body>
</html>
