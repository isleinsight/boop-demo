<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Passport</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    :root{
      --ink:#0f1b2d; --muted:#6b7280; --stroke:#e6ebf1; --ok:#065f46; --warn:#92400e; --err:#7f1d1d;
      --blue:#2f80ed; --blue-dark:#1c6fd8; --bg:#f5f7fa; --card:#ffffff;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; min-height:100vh; background:var(--bg); color:var(--ink);
      font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      display:flex; flex-direction:column;
    }
    .topbar{ background:#0b1220; color:#fff; border-bottom:1px solid #0f172a; }
    .topbar__inner{
      max-width:1100px; margin:0 auto; padding:12px 16px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .brand{ display:flex; align-items:center; gap:10px; }
    .brand img{ height:28px; display:block; }
    .brand .who{ font-size:.9rem; opacity:.85 }
    .logout{ color:#cfe0ff; text-decoration:none; font-size:.9rem; }
    .logout:hover{ text-decoration:underline; }

    .wrap{ max-width:1100px; margin:24px auto; padding:0 16px; width:100%; }
    .card{
      background:var(--card); border:1px solid var(--stroke); border-radius:14px;
      box-shadow:0 8px 24px rgba(15, 23, 42, .06); padding:18px;
    }
    h1{ margin:0 0 6px; font-size:1.25rem; }
    .sub{ margin:0 0 14px; color:var(--muted); font-size:.95rem; }
    label{ display:block; font-size:.9rem; color:#1f2a44; margin:10px 0 6px; }
    input, textarea, button, select{
      width:100%; border:1px solid #d1d9e6; border-radius:10px; padding:10px 12px;
      font-size:1rem; font-family:inherit; background:#fff;
    }
    input:focus, textarea:focus, select:focus{ outline:none; border-color:var(--blue); }
    .row{ display:flex; gap:12px; flex-wrap:wrap; }
    .row > .col{ flex:1 1 260px; }

    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      margin-top:14px; padding:10px 14px; border-radius:10px; border:1px solid transparent;
      background:var(--blue); color:#fff; font-weight:700; cursor:pointer;
    }
    .btn:hover{ background:var(--blue-dark); }
    .btn.secondary{ background:#fff; color:var(--ink); border-color:#d1d9e6; }
    .btn.secondary:hover{ background:#f3f4f6; }

    .status{ margin-top:12px; padding:10px 12px; border-radius:10px; border:1px solid var(--stroke); display:none; }
    .status.ok{ background:#ecfdf5; border-color:#a7f3d0; color:var(--ok); display:block; }
    .status.warn{ background:#fff7ed; border-color:#fed7aa; color:#b45309; display:block; }
    .status.err{ background:#fef2f2; border-color:#fecaca; color:#991b1b; display:block; }

    .view{ display:none; }
    .view.active{ display:block; }

    .kv{ display:flex; gap:12px; flex-wrap:wrap; margin:8px 0 0; }
    .kv .item{ padding:8px 10px; border:1px solid var(--stroke); border-radius:10px; background:#fff; }
    .muted{ color:var(--muted) }

    /* Masked PID chip */
    .pid-chip{
      display:inline-flex; align-items:center; gap:8px; padding:8px 10px;
      border:1px dashed var(--stroke); border-radius:10px; background:#f8fafc; color:#111827;
      min-height:42px;
    }
    .pid-chip .pid{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; letter-spacing:.02em; }
    .pid-chip .hint{ color:var(--muted); font-size:.9rem; }

    footer{ margin-top:auto; border-top:1px solid var(--stroke); background:#fff; }
    .footer__inner{ max-width:1100px; margin:0 auto; padding:14px 16px; font-size:.9rem; color:#4b5563;
      display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; }
    .footer__links a{ color:#2f80ed; text-decoration:none; margin-right:12px; }
    .footer__links a:hover{ text-decoration:underline; }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="topbar">
    <div class="topbar__inner">
      <div class="brand">
        <img src="../assets/logo-white.png" alt="Payulot" />
        <div class="who" id="signedInAs">Loading…</div>
      </div>
      <a class="logout" href="#" id="logoutLink">Log out</a>
    </div>
  </div>

  <div class="wrap">

    <!-- Common passport header -->
    <div class="card" style="margin-bottom:16px;">
      <h1>Passport</h1>
      <p class="sub">This page opens from the scanner (deep link includes a Passport token). The full ID is never displayed.</p>

      <!-- Hidden full PID (set ONLY from deep link) -->
      <input id="pidFull" type="hidden" autocomplete="off" />

      <!-- Masked PID display -->
      <div class="row">
        <div class="col">
          <label>Selected Passport</label>
          <div class="pid-chip" id="pidChip">
            <span class="pid" id="pidMasked">No passport detected</span>
            <span class="hint" id="pidHint"></span>
          </div>
        </div>
      </div>

      <div id="commonStatus" class="status"></div>

      <div class="kv">
        <div class="item"><span class="muted">Signed-in role:</span> <strong id="roleBadge">—</strong></div>
        <div class="item"><span class="muted">Signed-in user:</span> <strong id="whoBadge">—</strong></div>
      </div>
    </div>

    <!-- Vendor VIEW -->
    <section id="view-vendor" class="view card">
      <h2 style="margin:0 0 6px;">Vendor • Charge by Passport</h2>
      <p class="sub">Enter an amount and complete the charge for the selected passport.</p>

      <div class="row">
        <div class="col">
          <label>Amount</label>
          <input id="v_amount" type="number" inputmode="decimal" min="0.01" step="0.01" placeholder="0.00" />
        </div>
        <div class="col">
          <label>Note (optional)</label>
          <input id="v_note" type="text" maxlength="120" placeholder="Short description for receipt" />
        </div>
      </div>

      <button class="btn" id="v_chargeBtn" disabled>Charge</button>
      <div id="v_status" class="status"></div>
    </section>

    <!-- Health VIEW -->
    <section id="view-health" class="view card">
      <h2 style="margin:0 0 6px;">Health • Emergency Passport</h2>
      <p class="sub">Read-only info for emergency care (placeholder until your health API is live).</p>
      <div class="row">
        <div class="col">
          <label>Flag</label>
          <input disabled value="No known allergies (example)" />
        </div>
        <div class="col">
          <label>Emergency Contact</label>
          <input disabled value="(example) Jane Doe • +1 441-555-0134" />
        </div>
      </div>
      <div class="row">
        <div class="col">
          <label>Notes</label>
          <textarea disabled rows="3">This section renders from your health API when ready.</textarea>
        </div>
      </div>
    </section>

    <!-- Transit VIEW -->
    <section id="view-transit" class="view card">
      <h2 style="margin:0 0 6px;">Transit • Validate & Deduct</h2>
      <p class="sub">Validate the passport and deduct a ride or fare.</p>

      <div class="row">
        <div class="col">
          <label>Mode</label>
          <select id="t_mode">
            <option value="bus">Bus</option>
            <option value="ferry">Ferry</option>
            <option value="rail">Rail</option>
          </select>
        </div>
        <div class="col">
          <label>Fare</label>
          <input id="t_fare" type="number" inputmode="decimal" min="0" step="0.01" value="2.75" />
        </div>
      </div>

      <button class="btn" id="t_validateBtn" disabled>Validate & Deduct</button>
      <div id="t_status" class="status"></div>
    </section>

  </div>

  <footer>
    <div class="footer__inner">
      <div>© <span id="year"></span> Payulot</div>
      <div class="footer__links">
        <a href="../terms.html" target="_blank" rel="noopener">Terms</a>
        <a href="../privacy.html" target="_blank" rel="noopener">Privacy</a>
      </div>
    </div>
  </footer>

  <script>
    // ---------- config ----------
    const BACKEND_EXPECTS_CENTS = false;

    // ---------- helpers ----------
    const $ = (id) => document.getElementById(id);
    const maskPid = (pid) => (pid && typeof pid === 'string') ? ('••••-••••-••••-' + pid.slice(-4)) : '';
    const showStatus = (el, msg, cls) => { if(!el) return; el.className = 'status ' + (cls||''); el.textContent = msg; el.style.display = 'block'; };
    const hideStatus = (el) => { if(el){ el.style.display = 'none'; } };

    function roleKey(me) {
      const r = String(me?.role || '').toLowerCase().trim();
      const t = String(me?.type || '').toLowerCase().trim();
      const v = r || t;
      if (['vendor','rolevendor'].includes(v)) return 'vendor';
      if (['health','health_professional','healthprofessional','medical','emt','ambulance'].includes(v)) return 'health';
      if (['transit','bus','ferry','rail','operator'].includes(v)) return 'transit';
      return 'unknown';
    }
    function fullNameOrEmail(me) {
      const first = (me?.first_name || '').trim();
      const last  = (me?.last_name  || '').trim();
      const name = (first + ' ' + last).trim();
      return name || me?.email || 'User';
    }
    async function fetchMe() {
      const token = localStorage.getItem('boop_jwt');
      if (!token) throw new Error('No token');
      const headers = { Authorization: `Bearer ${token}` };
      const r = await fetch('/api/me', { headers });
      if (!r.ok) {
        let m = 'Unauthorized';
        try { m = (await r.json())?.message || m; } catch {}
        throw new Error(m);
      }
      const basic = await r.json();
      try {
        const more = await fetch('/api/users/me', { headers });
        if (more.ok) return { ...basic, ...(await more.json()) };
      } catch {}
      return basic;
    }
    function setRoleView(role) {
      ['view-vendor','view-health','view-transit'].forEach(id => $(id)?.classList.remove('active'));
      if (role === 'vendor') $('view-vendor')?.classList.add('active');
      if (role === 'health') $('view-health')?.classList.add('active');
      if (role === 'transit') $('view-transit')?.classList.add('active');
    }

    // ---------- boot ----------
    document.addEventListener('DOMContentLoaded', async () => {
      $('year') && ($('year').textContent = new Date().getFullYear());

      // 1) Require ?pid= from deep link
      let PID = '';
      try {
        const u = new URL(location.href);
        const raw = (u.searchParams.get('pid') || '').trim();
        if (raw && /^[A-Za-z0-9_-]{12,}$/.test(raw)) PID = raw;
      } catch {}
      const pidFull = $('pidFull');
      const pidMaskedEl = $('pidMasked');
      const pidHint = $('pidHint');
      const commonStatus = $('commonStatus');

      if (!PID) {
        pidFull.value = '';
        pidMaskedEl.textContent = 'No passport detected';
        pidHint.textContent = '';
        showStatus(commonStatus, 'Open this page from the scanner. Missing or invalid token.', 'warn');
      } else {
        pidFull.value = PID;
        pidMaskedEl.textContent = maskPid(PID);
        pidHint.textContent = '(masked — last 4 only)';
        hideStatus(commonStatus);
      }

      // 2) Auth + identity + role gate
      try {
        const me = await fetchMe();
        const who = fullNameOrEmail(me);
        const role = roleKey(me);

        $('signedInAs').textContent = `Signed in as ${who}`;
        $('roleBadge').textContent = role;
        $('whoBadge').textContent = who;

        setRoleView(role);

        // enable actions only if PID present
        if (PID) {
          if (role === 'vendor') $('v_chargeBtn').disabled = false;
          if (role === 'transit') $('t_validateBtn').disabled = false;
        } else {
          $('v_chargeBtn').disabled = true;
          $('t_validateBtn').disabled = true;
        }
      } catch (e) {
        try { await fetch('/api/logout', { method:'POST' }); } catch {}
        localStorage.clear();
        location.href = '/index.html';
        return;
      }

      // 3) Vendor: charge
      $('v_amount')?.addEventListener('keydown', (e) => { if (e.key === 'Enter') $('v_chargeBtn')?.click(); });
      $('v_chargeBtn')?.addEventListener('click', async () => {
        const out = $('v_status');
        hideStatus(out);
        const amt = Number($('v_amount')?.value || 0);
        const note = $('v_note')?.value || null;
        if (!pidFull.value) return showStatus(out, 'No passport detected.', 'err');
        if (!Number.isFinite(amt) || amt <= 0) return showStatus(out, 'Enter a valid amount.', 'err');

        const btn = $('v_chargeBtn'); btn.disabled = true;
        try {
          const token = localStorage.getItem('boop_jwt') || '';
          const payload = BACKEND_EXPECTS_CENTS
            ? { pid_token: pidFull.value, amount_cents: Math.round(amt * 100), note }
            : { pid_token: pidFull.value, amount: amt, note };

          const r = await fetch('/api/vendor/passport-charge', {
            method:'POST',
            headers:{ 'Content-Type':'application/json', Authorization: `Bearer ${token}` },
            body: JSON.stringify(payload)
          });
          const j = await r.json().catch(()=>({}));
          if (!r.ok) throw new Error(j.message || j.error || `HTTP ${r.status}`);
          showStatus(out, 'Charge completed.', 'ok');
        } catch (err) {
          showStatus(out, `❌ ${err.message || err}`, 'err');
        } finally {
          btn.disabled = false;
        }
      });

      // 4) Transit (demo)
      $('t_validateBtn')?.addEventListener('click', async () => {
        const out = $('t_status');
        hideStatus(out);
        if (!pidFull.value) return showStatus(out, 'No passport detected.', 'err');
        const fare = Number($('t_fare')?.value || 0);
        const mode = $('t_mode')?.value || 'bus';
        if (!Number.isFinite(fare) || fare < 0) return showStatus(out, 'Enter a valid fare.', 'err');
        showStatus(out, `(demo) ${mode} fare deducted: ${fare.toFixed(2)}`, 'ok');
      });

      // 5) Logout
      $('logoutLink')?.addEventListener('click', async (e)=>{
        e.preventDefault();
        try { await fetch('/api/logout', { method:'POST' }); } catch {}
        localStorage.clear(); location.href = '../login.html';
      });
    });
  </script>
</body>
</html>
