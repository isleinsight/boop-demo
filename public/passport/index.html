<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Passport</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    :root{
      --ink:#0f1b2d; --muted:#6b7280; --stroke:#e6ebf1; --ok:#065f46; --warn:#92400e; --err:#7f1d1d;
      --blue:#2f80ed; --blue-dark:#1c6fd8; --bg:#f5f7fa; --card:#ffffff;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; min-height:100vh; background:var(--bg); color:var(--ink);
      font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      display:flex; flex-direction:column;
    }
    .topbar{ background:#0b1220; color:#fff; border-bottom:1px solid #0f172a; }
    .topbar__inner{
      max-width:1100px; margin:0 auto; padding:12px 16px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .brand{ display:flex; align-items:center; gap:10px; }
    .brand img{ height:28px; display:block; }
    .brand .who{ font-size:.9rem; opacity:.85 }
    .logout{ color:#cfe0ff; text-decoration:none; font-size:.9rem; }
    .logout:hover{ text-decoration:underline; }

    .wrap{ max-width:1100px; margin:24px auto; padding:0 16px; width:100%; }
    .card{
      background:var(--card); border:1px solid var(--stroke); border-radius:14px;
      box-shadow:0 8px 24px rgba(15, 23, 42, .06); padding:18px;
    }
    h1{ margin:0 0 6px; font-size:1.25rem; }
    .sub{ margin:0 0 14px; color:var(--muted); font-size:.95rem; }
    label{ display:block; font-size:.9rem; color:#1f2a44; margin:10px 0 6px; }
    input, textarea, button, select{
      width:100%; border:1px solid #d1d9e6; border-radius:10px; padding:10px 12px;
      font-size:1rem; font-family:inherit; background:#fff;
    }
    input:focus, textarea:focus, select:focus{ outline:none; border-color:var(--blue); }
    .row{ display:flex; gap:12px; flex-wrap:wrap; }
    .row > .col{ flex:1 1 260px; }

    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      margin-top:14px; padding:10px 14px; border-radius:10px; border:1px solid transparent;
      background:var(--blue); color:#fff; font-weight:700; cursor:pointer;
    }
    .btn:hover{ background:var(--blue-dark); }
    .btn.secondary{ background:#fff; color:var(--ink); border-color:#d1d9e6; }
    .btn.secondary:hover{ background:#f3f4f6; }

    .status{ margin-top:12px; padding:10px 12px; border-radius:10px; border:1px solid var(--stroke); }
    .status.ok{ background:#ecfdf5; border-color:#a7f3d0; color:var(--ok); }
    .status.warn{ background:#fff7ed; border-color:#fed7aa; color:var(--warn); }
    .status.err{ background:#fef2f2; border-color:#fecaca; color:var(--err); }

    .view{ display:none; }
    .view.active{ display:block; }

    .kv{ display:flex; gap:12px; flex-wrap:wrap; margin:8px 0 0; }
    .kv .item{ padding:8px 10px; border:1px solid var(--stroke); border-radius:10px; background:#fff; }
    .muted{ color:var(--muted) }

    /* Masked PID chip */
    .pid-chip{
      display:inline-flex; align-items:center; gap:8px; padding:8px 10px;
      border:1px dashed var(--stroke); border-radius:10px; background:#f8fafc; color:#111827;
      min-height:42px;
    }
    .pid-chip .pid{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; letter-spacing:.02em; }
    .pid-chip .hint{ color:var(--muted); font-size:.9rem; }

    footer{ margin-top:auto; border-top:1px solid var(--stroke); background:#fff; }
    .footer__inner{ max-width:1100px; margin:0 auto; padding:14px 16px; font-size:.9rem; color:#4b5563;
      display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; }
    .footer__links a{ color:var(--blue); text-decoration:none; margin-right:12px; }
    .footer__links a:hover{ text-decoration:underline; }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="topbar">
    <div class="topbar__inner">
      <div class="brand">
        <img src="../assets/logo-white.png" alt="Payulot" />
        <div class="who" id="signedInAs">Loading…</div>
      </div>
      <a class="logout" href="#" id="logoutLink">Log out</a>
    </div>
  </div>

  <div class="wrap">

    <!-- Common passport header -->
    <div class="card" style="margin-bottom:16px;">
      <h1>Passport</h1>
      <p class="sub">This page adapts to the signed-in role. Use “Scan / Load” to select a Passport. The full ID is never displayed.</p>

      <!-- Hidden full PID (set ONLY by scan/deeplink/postMessage) -->
      <input id="pidFull" type="hidden" autocomplete="off" />

      <!-- Masked PID display + buttons -->
      <div class="row">
        <div class="col">
          <label>Selected Passport</label>
          <div class="pid-chip" id="pidChip">
            <span class="pid" id="pidMasked">No passport selected</span>
            <span class="hint" id="pidHint"></span>
          </div>
        </div>
        <div class="col">
          <label>Actions</label>
          <div class="row">
            <button class="btn secondary" id="btnScan" type="button">Scan / Load</button>
            <button class="btn" id="btnUse" type="button" disabled>Use This Passport</button>
          </div>
        </div>
      </div>

      <div id="commonStatus" class="status" style="display:none;"></div>

      <div class="kv">
        <div class="item"><span class="muted">Signed-in role:</span> <strong id="roleBadge">—</strong></div>
        <div class="item"><span class="muted">Signed-in user:</span> <strong id="whoBadge">—</strong></div>
      </div>
    </div>

    <!-- Vendor VIEW -->
    <section id="view-vendor" class="view card">
      <h2 style="margin:0 0 6px;">Vendor • Charge by Passport</h2>
      <p class="sub">Enter an amount and complete the charge for the selected passport.</p>

      <div class="row">
        <div class="col">
          <label>Amount</label>
          <input id="v_amount" type="number" inputmode="decimal" min="0.01" step="0.01" placeholder="0.00" />
        </div>
        <div class="col">
          <label>Note (optional)</label>
          <input id="v_note" type="text" maxlength="120" placeholder="Short description for receipt" />
        </div>
      </div>

      <button class="btn" id="v_chargeBtn" disabled>Charge</button>
      <div id="v_status" class="status" style="display:none;"></div>
    </section>

    <!-- Health VIEW -->
    <section id="view-health" class="view card">
      <h2 style="margin:0 0 6px;">Health • Emergency Passport</h2>
      <p class="sub">Read-only info for emergency care (placeholders until your API is ready).</p>
      <div class="row">
        <div class="col">
          <label>Flag</label>
          <input disabled value="No known allergies (example)" />
        </div>
        <div class="col">
          <label>Emergency Contact</label>
          <input disabled value="(example) Jane Doe • +1 441-555-0134" />
        </div>
      </div>
      <div class="row">
        <div class="col">
          <label>Notes</label>
          <textarea disabled rows="3">This section renders from your health API when ready.</textarea>
        </div>
      </div>
    </section>

    <!-- Transit VIEW -->
    <section id="view-transit" class="view card">
      <h2 style="margin:0 0 6px;">Transit • Validate & Deduct</h2>
      <p class="sub">Validate the passport and deduct a ride or fare.</p>

      <div class="row">
        <div class="col">
          <label>Mode</label>
          <select id="t_mode">
            <option value="bus">Bus</option>
            <option value="ferry">Ferry</option>
            <option value="rail">Rail</option>
          </select>
        </div>
        <div class="col">
          <label>Fare</label>
          <input id="t_fare" type="number" inputmode="decimal" min="0" step="0.01" value="2.75" />
        </div>
      </div>

      <button class="btn" id="t_validateBtn" disabled>Validate & Deduct</button>
      <div id="t_status" class="status" style="display:none;"></div>
    </section>

  </div>

  <footer>
    <div class="footer__inner">
      <div>© <span id="year"></span> Payulot</div>
      <div class="footer__links">
        <a href="../terms.html" target="_blank" rel="noopener">Terms</a>
        <a href="../privacy.html" target="_blank" rel="noopener">Privacy</a>
      </div>
    </div>
  </footer>

  <script>
    // Util: mask all but last 4
    function maskPid(pid){
      if(!pid || typeof pid !== 'string') return '';
      const last4 = pid.slice(-4);
      return '••••-••••-••••-' + last4;
    }

    // Wire up basic UI bits
    const yearEl = document.getElementById('year'); if(yearEl) yearEl.textContent = new Date().getFullYear();
    const pidFull = document.getElementById('pidFull');
    const pidMaskedEl = document.getElementById('pidMasked');
    const pidHint = document.getElementById('pidHint');
    const btnScan = document.getElementById('btnScan');
    const btnUse = document.getElementById('btnUse');
    const chargeBtn = document.getElementById('v_chargeBtn');
    const transitBtn = document.getElementById('t_validateBtn');

    // Disable any accidental text entry on the hidden field (belt & suspenders)
    ['keydown','keypress','beforeinput','paste','drop'].forEach(evt => {
      pidFull.addEventListener(evt, e => e.preventDefault());
    });

    function setPid(pid){
      pidFull.value = pid || '';
      const ok = !!pid;
      pidMaskedEl.textContent = ok ? maskPid(pid) : 'No passport selected';
      pidHint.textContent = ok ? '(masked — last 4 only)' : '';
      btnUse.disabled = !ok;
      chargeBtn.disabled = !ok;
      transitBtn.disabled = !ok;
    }

    // Accept from ?pid= in URL (deeplink)
    (function preloadFromQuery(){
      try{
        const u = new URL(location.href);
        const pid = u.searchParams.get('pid');
        if(pid && /^[A-Za-z0-9_-]{12,}$/.test(pid)) setPid(pid);
      }catch{}
    })();

    // Accept from NFC/Scanner via postMessage
    window.addEventListener('message', (e)=>{
      // You can tighten origin checks here, e.g.: if(e.origin !== 'https://scanner.payulot.com') return;
      const data = e.data || {};
      if(data && typeof data === 'object' && typeof data.pid === 'string'){
        // Basic allowlist check: looks like a token-ish string
        if(/^[A-Za-z0-9_-]{12,}$/.test(data.pid)){
          setPid(data.pid);
        }
      }
    });

    // "Scan / Load" — open your scanner page (adjust URL)
    btnScan.addEventListener('click', ()=>{
      // Open a scanner tab/window that will postMessage({pid:"..."}) back to this window
      window.open('/vendor/scanner.html', '_blank', 'noopener');
    });

    // Use the selected passport (does not reveal PID)
    btnUse.addEventListener('click', ()=>{
      if(!pidFull.value) return;
      const status = document.getElementById('commonStatus');
      status.className = 'status ok';
      status.textContent = 'Passport loaded. You can proceed.';
      status.style.display = 'block';
      // Here you might also fetch and cache limited profile info server-side (still keep PID hidden in UI)
    });

    // Example charge handler (uses hidden PID)
    document.getElementById('v_chargeBtn')?.addEventListener('click', async ()=>{
      const amt = Number(document.getElementById('v_amount')?.value || 0);
      const note = document.getElementById('v_note')?.value || null;
      const out = document.getElementById('v_status');
      out.style.display = 'none';
      if(!pidFull.value || !Number.isFinite(amt) || amt <= 0){
        out.className = 'status err';
        out.textContent = 'Missing passport or invalid amount.';
        out.style.display = 'block';
        return;
      }
      try{
        const r = await fetch('/api/vendor/passport-charge', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({ pid_token: pidFull.value, amount: amt, note })
        });
        const j = await r.json().catch(()=>({}));
        if(!r.ok) throw new Error(j.message || 'Charge failed');
        out.className = 'status ok';
        out.textContent = 'Charge approved.';
      }catch(e){
        out.className = 'status err';
        out.textContent = e.message || 'Charge failed';
      }finally{
        out.style.display = 'block';
      }
    });

    // Transit example
    document.getElementById('t_validateBtn')?.addEventListener('click', async ()=>{
      const mode = document.getElementById('t_mode')?.value || 'bus';
      const fare = Number(document.getElementById('t_fare')?.value || 0);
      const out = document.getElementById('t_status');
      out.style.display = 'none';
      if(!pidFull.value){
        out.className = 'status err'; out.textContent = 'No passport selected.'; out.style.display = 'block'; return;
      }
      try{
        const r = await fetch('/api/transit/validate', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({ pid_token: pidFull.value, mode, fare })
        });
        const j = await r.json().catch(()=>({}));
        if(!r.ok) throw new Error(j.message || 'Validation failed');
        out.className = 'status ok'; out.textContent = 'Validated & fare deducted.'; out.style.display = 'block';
      }catch(e){
        out.className = 'status err'; out.textContent = e.message || 'Validation failed'; out.style.display = 'block';
      }
    });

    // Simple role/name placeholders
    document.getElementById('signedInAs').textContent = 'Signed in';
    document.getElementById('roleBadge').textContent = 'Vendor';
    document.getElementById('whoBadge').textContent = 'you@business.bm';
    document.getElementById('view-vendor').classList.add('active');

    // Logout
    document.getElementById('logoutLink')?.addEventListener('click', async (e)=>{
      e.preventDefault();
      try { await fetch('/api/logout', { method:'POST' }); } catch {}
      localStorage.clear(); location.href = '../login.html';
    });
  </script>
</body>
</html>
